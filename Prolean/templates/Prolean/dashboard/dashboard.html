{% extends 'Prolean/dashboard/base_student.html' %}
{% load static price_filters custom_filters i18n %}
{% get_current_language as CURRENT_LANGUAGE %}

{% block student_header_title %}
    {% if CURRENT_LANGUAGE == 'ar' %}مرحباً{% elif CURRENT_LANGUAGE == 'en' %}Welcome{% else %}Bienvenue{% endif %},
    <span class="text-gradient">{% if user.is_authenticated %}{{ user.first_name|default:profile.full_name|cut:" " }}{% else %}Guest{% endif %}</span>
{% endblock %}

{% block student_header_subtitle %}
    {% if profile.status == 'ACTIVE' %}
        {% if CURRENT_LANGUAGE == 'ar' %}لوحة متابعة دراستك، البث المباشر، وجدولك القادم.{% elif CURRENT_LANGUAGE == 'en' %}Your learning cockpit: live sessions, progress, and next classes.{% else %}Votre cockpit d'apprentissage: live, progression et séances à venir.{% endif %}
    {% else %}
        {% if CURRENT_LANGUAGE == 'ar' %}حسابك قيد المراجعة حالياً.{% elif CURRENT_LANGUAGE == 'en' %}Your account is currently under review.{% else %}Votre compte est en cours de validation.{% endif %}
    {% endif %}
{% endblock %}

{% block student_content %}
<style>
    .stu-grid { display:grid; gap:18px; }
    .hero-shell {
        border:1px solid var(--stu-border);
        border-radius:24px;
        padding:20px;
        background:
            radial-gradient(1200px 320px at -10% -40%, rgba(255,107,0,.22), transparent 42%),
            radial-gradient(900px 240px at 120% -40%, rgba(14,165,233,.22), transparent 38%),
            linear-gradient(135deg, #f8fafc 0%, #eef2f7 100%);
    }
    .dark .hero-shell {
        background:
            radial-gradient(1200px 320px at -10% -40%, rgba(255,107,0,.22), transparent 42%),
            radial-gradient(900px 240px at 120% -40%, rgba(14,165,233,.22), transparent 38%),
            linear-gradient(135deg, #101827 0%, #0b1220 100%);
    }
    .kpi-row { display:grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap:10px; }
    .kpi-box { border:1px solid var(--stu-border); border-radius:14px; padding:10px; background:var(--stu-bg); }
    .kpi-l { font-size:10px; font-weight:900; letter-spacing:.12em; text-transform:uppercase; color:var(--stu-text-muted); }
    .kpi-v { font-size:22px; font-weight:900; color:var(--stu-text-main); }

    .main-grid { display:grid; grid-template-columns: 1.6fr 1fr; gap:18px; }
    .panelx { border:1px solid var(--stu-border); border-radius:20px; background:var(--stu-bg); padding:16px; }
    .live-tile { border:1px solid #fecaca; background:linear-gradient(135deg,#fff1f2,#fff); border-radius:14px; padding:12px; }
    .dark .live-tile { background:linear-gradient(135deg, rgba(127,29,29,.35), rgba(15,23,42,.35)); border-color: rgba(248,113,113,.35); }

    .training-grid { display:grid; gap:12px; grid-template-columns: repeat(3, minmax(0,1fr)); }
    .training-card { border:1px solid var(--stu-border); border-radius:16px; overflow:hidden; background:var(--stu-bg); display:flex; flex-direction:column; }
    .training-head { height:120px; background:linear-gradient(135deg,#ff6b00,#0ea5e9); display:flex; align-items:center; justify-content:center; color:#fff; }

    .msg-item { border-top:1px solid var(--stu-border); padding:12px 2px; }

    @media (max-width: 1180px) {
        .kpi-row { grid-template-columns: repeat(2, minmax(0,1fr)); }
        .main-grid { grid-template-columns: 1fr; }
        .training-grid { grid-template-columns: repeat(2, minmax(0,1fr)); }
    }
    @media (max-width: 760px) {
        .training-grid { grid-template-columns: 1fr; }
    }
</style>

{% if is_guest %}
<div class="panelx text-center py-14">
    <h3 class="text-2xl font-black mb-2" style="color:var(--stu-text-main);">{% if CURRENT_LANGUAGE == 'ar' %}الوصول مقيّد{% elif CURRENT_LANGUAGE == 'en' %}Restricted Access{% else %}Accès restreint{% endif %}</h3>
    <p class="text-sm font-semibold mb-6" style="color:var(--stu-text-muted);">{% if CURRENT_LANGUAGE == 'ar' %}سجّل الدخول للوصول إلى مساحتك.{% elif CURRENT_LANGUAGE == 'en' %}Sign in to access your dashboard.{% else %}Connectez-vous pour accéder à votre espace.{% endif %}</p>
    <div class="flex flex-wrap justify-center gap-3">
        <a href="{% url 'Prolean:login' %}" class="px-6 py-3 rounded-xl bg-brand text-white text-sm font-black">{% if CURRENT_LANGUAGE == 'ar' %}تسجيل الدخول{% elif CURRENT_LANGUAGE == 'en' %}Login{% else %}Connexion{% endif %}</a>
        <a href="{% url 'Prolean:register' %}" class="px-6 py-3 rounded-xl border text-sm font-black" style="border-color:var(--stu-border);color:var(--stu-text-main);">{% if CURRENT_LANGUAGE == 'ar' %}إنشاء حساب{% elif CURRENT_LANGUAGE == 'en' %}Sign up{% else %}Inscription{% endif %}</a>
    </div>
</div>
{% elif profile.status == 'ACTIVE' %}

<div class="stu-grid">
    <section class="hero-shell">
        <div class="flex flex-wrap items-start justify-between gap-4 mb-4">
            <div>
                <p class="text-[10px] font-black uppercase tracking-[.2em]" style="color:var(--stu-text-muted);">Learning Cockpit</p>
                <h2 class="text-2xl font-black" style="color:var(--stu-text-main);">{% if CURRENT_LANGUAGE == 'ar' %}نظرة فورية على دراستك{% elif CURRENT_LANGUAGE == 'en' %}Your Learning Overview{% else %}Vue instantanée de votre parcours{% endif %}</h2>
            </div>
            <span class="px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-widest bg-emerald-100 text-emerald-700">{{ profile.get_status_display }}</span>
        </div>
        <div class="kpi-row">
            <div class="kpi-box"><p class="kpi-l">{% if CURRENT_LANGUAGE == 'ar' %}المدفوع{% elif CURRENT_LANGUAGE == 'en' %}Paid{% else %}Payé{% endif %}</p><p class="kpi-v" data-price-mad="{{ amount_paid|default:0 }}">{{ amount_paid|convert_price:request|format_currency:request.session.preferred_currency }}</p></div>
            <div class="kpi-box"><p class="kpi-l">{% if CURRENT_LANGUAGE == 'ar' %}المتبقي{% elif CURRENT_LANGUAGE == 'en' %}Remaining{% else %}Restant{% endif %}</p><p class="kpi-v" data-price-mad="{{ amount_remaining|default:0 }}">{{ amount_remaining|convert_price:request|format_currency:request.session.preferred_currency }}</p></div>
            <div class="kpi-box"><p class="kpi-l">{% if CURRENT_LANGUAGE == 'ar' %}التقدم{% elif CURRENT_LANGUAGE == 'en' %}Progress{% else %}Progression{% endif %}</p><p class="kpi-v">{{ watch_percentage }}%</p></div>
            <div class="kpi-box"><p class="kpi-l">{% if CURRENT_LANGUAGE == 'ar' %}التكوينات{% elif CURRENT_LANGUAGE == 'en' %}Trainings{% else %}Formations{% endif %}</p><p class="kpi-v">{% if external_authority_mode and external_formations %}{{ external_formations|length }}{% else %}{{ my_formations.count }}{% endif %}</p></div>
        </div>
    </section>

    <section class="main-grid">
        <div class="panelx space-y-4">
            <div class="flex items-center justify-between">
                <h3 class="text-lg font-black" style="color:var(--stu-text-main);">{% if CURRENT_LANGUAGE == 'ar' %}البث المباشر والجلسات{% elif CURRENT_LANGUAGE == 'en' %}Live & Sessions{% else %}Live & Sessions{% endif %}</h3>
                {% if next_seance %}<span class="text-xs font-bold" style="color:var(--stu-text-muted);">{{ next_seance.date|date:'d M' }} · {{ next_seance.time|time:'H:i' }}</span>{% endif %}
            </div>

            {% if external_active_live_sessions %}
                {% for live_row in external_active_live_sessions %}
                <div class="live-tile flex items-center justify-between gap-3">
                    <div>
                        <p class="text-sm font-black" style="color:var(--stu-text-main);">{{ live_row.session_name }}</p>
                        <p class="text-xs font-semibold" style="color:var(--stu-text-muted);">{{ live_row.professor_name }} · {{ live_row.ville }}</p>
                    </div>
                    <a href="{% url 'Prolean:external_live_room' live_row.session_id %}" class="px-4 py-2 rounded-xl bg-red-600 text-white text-xs font-black uppercase tracking-widest">Join</a>
                </div>
                {% endfor %}
            {% elif active_streams %}
                <div class="live-tile flex items-center justify-between gap-3">
                    <div>
                        <p class="text-sm font-black" style="color:var(--stu-text-main);">{{ active_streams.0.session.formations.all.0.title }}</p>
                        <p class="text-xs font-semibold" style="color:var(--stu-text-muted);">{{ active_streams.0.session.professor.profile.full_name }}</p>
                    </div>
                    <a href="{% url 'Prolean:live_session' active_streams.0.id %}" class="px-4 py-2 rounded-xl bg-red-600 text-white text-xs font-black uppercase tracking-widest">Join</a>
                </div>
            {% else %}
                <div class="kpi-box"><p class="text-sm font-bold" style="color:var(--stu-text-muted);">{% if CURRENT_LANGUAGE == 'ar' %}لا يوجد بث مباشر حالياً.{% elif CURRENT_LANGUAGE == 'en' %}No active live stream right now.{% else %}Aucun live actif pour le moment.{% endif %}</p></div>
            {% endif %}

            <div class="kpi-box">
                <p class="text-xs font-black uppercase tracking-[.14em] mb-2" style="color:var(--stu-text-muted);">{% if CURRENT_LANGUAGE == 'ar' %}الجلسة القادمة{% elif CURRENT_LANGUAGE == 'en' %}Next Session{% else %}Prochaine séance{% endif %}</p>
                <p class="text-sm font-black" style="color:var(--stu-text-main);">{% if next_seance %}{{ next_seance.title }}{% else %}{% if CURRENT_LANGUAGE == 'ar' %}لا توجد جلسة مجدولة{% elif CURRENT_LANGUAGE == 'en' %}No session planned{% else %}Aucune séance planifiée{% endif %}{% endif %}</p>
                <a href="{% url 'Prolean:student_schedule' %}" class="inline-flex mt-3 px-4 py-2 rounded-xl bg-brand text-white text-xs font-black uppercase tracking-widest">{% if CURRENT_LANGUAGE == 'ar' %}الجدول{% elif CURRENT_LANGUAGE == 'en' %}Schedule{% else %}Agenda{% endif %}</a>
            </div>
        </div>

        <div class="panelx">
            <h3 class="text-lg font-black mb-2" style="color:var(--stu-text-main);">{% if CURRENT_LANGUAGE == 'ar' %}الرسائل{% elif CURRENT_LANGUAGE == 'en' %}Announcements{% else %}Messages{% endif %}</h3>
            {% for note in notifications|slice:':5' %}
            <div class="msg-item {% if forloop.first %}border-0 pt-0{% endif %}">
                <p class="text-sm font-black" style="color:var(--stu-text-main);">{{ note.title }}</p>
                <p class="text-xs" style="color:var(--stu-text-muted);">{{ note.message|truncatechars:130 }}</p>
            </div>
            {% empty %}
            <p class="text-sm font-bold" style="color:var(--stu-text-muted);">{% if CURRENT_LANGUAGE == 'ar' %}لا توجد رسائل جديدة.{% elif CURRENT_LANGUAGE == 'en' %}No recent messages.{% else %}Aucun message récent.{% endif %}</p>
            {% endfor %}
        </div>
    </section>

    <section class="panelx">
        <div class="flex items-center justify-between mb-3">
            <h3 id="formations" class="text-lg font-black" style="color:var(--stu-text-main);">{% if CURRENT_LANGUAGE == 'ar' %}التكوينات{% elif CURRENT_LANGUAGE == 'en' %}Trainings{% else %}Formations{% endif %}</h3>
            <span class="text-xs font-black px-3 py-1 rounded-full" style="background:var(--stu-surface-hover);color:var(--stu-text-muted);">{% if external_authority_mode and external_formations %}{{ external_formations|length }}{% else %}{{ my_formations.count }}{% endif %}</span>
        </div>
        <div class="training-grid">
            {% if external_authority_mode and external_formations %}
                {% for row in external_formations %}
                <article class="training-card">
                    <div class="training-head"><span class="material-symbols-outlined text-5xl">school</span></div>
                    <div class="p-4 flex-1 flex flex-col gap-2">
                        <h4 class="text-sm font-black" style="color:var(--stu-text-main);">{{ row.formation_name|default:'Training' }}</h4>
                        <p class="text-xs" style="color:var(--stu-text-muted);">{{ row.session_name|default:'Session' }} · {{ row.ville|default:'-' }}</p>
                        <p class="text-xs font-bold" style="color:var(--stu-text-muted);">{{ row.professor_name|default:'-' }}</p>
                    </div>
                </article>
                {% empty %}
                <div class="kpi-box" style="grid-column:1/-1;"><p class="text-sm font-bold" style="color:var(--stu-text-muted);">No assignments yet.</p></div>
                {% endfor %}
            {% else %}
                {% for training in my_formations %}
                <article class="training-card">
                    <div class="training-head">
                        {% if training.thumbnail %}<img src="{{ training.thumbnail }}" alt="{{ training.title }}" class="w-full h-full object-cover">{% else %}<span class="material-symbols-outlined text-5xl">school</span>{% endif %}
                    </div>
                    <div class="p-4 flex-1 flex flex-col gap-2">
                        <h4 class="text-sm font-black" style="color:var(--stu-text-main);">{{ training.title }}</h4>
                        <p class="text-xs" style="color:var(--stu-text-muted);">{{ training.short_description|truncatechars:90 }}</p>
                        <a href="{% url 'Prolean:recorded_videos_list' training.slug %}" class="mt-auto inline-flex items-center justify-center px-3 py-2 rounded-xl bg-brand text-white text-xs font-black uppercase tracking-widest">{% if CURRENT_LANGUAGE == 'ar' %}متابعة{% elif CURRENT_LANGUAGE == 'en' %}Continue{% else %}Continuer{% endif %}</a>
                    </div>
                </article>
                {% empty %}
                <div class="kpi-box" style="grid-column:1/-1;"><p class="text-sm font-bold" style="color:var(--stu-text-muted);">{% if CURRENT_LANGUAGE == 'ar' %}لا توجد تكوينات حالياً.{% elif CURRENT_LANGUAGE == 'en' %}No trainings yet.{% else %}Aucune formation pour le moment.{% endif %}</p></div>
                {% endfor %}
            {% endif %}
        </div>
    </section>
</div>

{% else %}
<div class="panelx text-center py-14">
    <h3 class="text-2xl font-black mb-2" style="color:var(--stu-text-main);">{% if CURRENT_LANGUAGE == 'ar' %}الحساب قيد التحقق{% elif CURRENT_LANGUAGE == 'en' %}Account Pending Validation{% else %}Compte en attente de validation{% endif %}</h3>
    <p class="text-sm font-semibold mb-6" style="color:var(--stu-text-muted);">{% if CURRENT_LANGUAGE == 'ar' %}سيتم تفعيل حسابك بعد مراجعة الفريق.{% elif CURRENT_LANGUAGE == 'en' %}Your account will be activated after team review.{% else %}Votre accès sera activé après validation de l'équipe.{% endif %}</p>
    <a href="https://wa.me/212779259942" class="inline-flex items-center gap-2 px-6 py-3 bg-amber-500 text-white rounded-xl font-bold">Support WhatsApp</a>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    {% if external_active_live_sessions %}
    const externalLives = [
        {% for live_row in external_active_live_sessions %}
        { join_url: "{% url 'Prolean:external_live_room' live_row.session_id %}" }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];
    window.dispatchEvent(new CustomEvent('liveStreamsUpdate', { detail: externalLives }));
    {% endif %}
});
</script>
{% endblock %}
