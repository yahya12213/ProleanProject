{% extends 'Prolean/professor/base_professor.html' %}
{% load static i18n %}
{% get_current_language as CURRENT_LANGUAGE %}

{% block header_title %}{% if CURRENT_LANGUAGE == 'ar' %}استوديو الأستاذ{% elif CURRENT_LANGUAGE == 'en' %}Professor Studio{% else %}Studio Professeur{% endif %}{% endblock %}
{% block header_subtitle %}{% if CURRENT_LANGUAGE == 'ar' %}تحكم مباشر بالجلسات والبث والطلاب.{% elif CURRENT_LANGUAGE == 'en' %}Live control center for sessions, streaming, and students.{% else %}Centre de pilotage des sessions, du live et des étudiants.{% endif %}{% endblock %}

{% block professor_content %}
<style>
    .dash-wrap { display: grid; gap: 20px; }
    .hero-panel {
        border: 1px solid var(--prof-border);
        border-radius: 24px;
        padding: 22px;
        background:
            radial-gradient(1200px 300px at -10% -40%, rgba(255,107,0,.25), transparent 40%),
            radial-gradient(800px 250px at 120% -40%, rgba(6,182,212,.18), transparent 35%),
            linear-gradient(135deg, #101726 0%, #1a2840 100%);
        color: #f8fafc;
    }
    .hero-kpi { display: grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap: 10px; }
    .hero-kpi > div {
        border: 1px solid rgba(148,163,184,.28);
        background: rgba(255,255,255,.08);
        border-radius: 14px;
        padding: 10px 12px;
    }
    .hero-kpi p { margin: 0; }
    .kpi-l { font-size: 10px; font-weight: 900; letter-spacing: .12em; text-transform: uppercase; color: #cbd5e1; }
    .kpi-v { font-size: 20px; font-weight: 900; color: #fff; }

    .studio-grid { display: grid; gap: 18px; grid-template-columns: 320px minmax(0, 1fr); }
    .cardx {
        border: 1px solid var(--prof-border);
        border-radius: 20px;
        background: var(--prof-surface);
        padding: 16px;
    }
    .session-tile {
        display: block;
        border: 1px solid var(--prof-border);
        border-radius: 14px;
        padding: 12px;
        background: var(--prof-bg);
        transition: .2s ease;
    }
    .session-tile:hover { transform: translateY(-1px); }
    .session-tile.active {
        border-color: var(--prof-brand);
        background: linear-gradient(135deg, rgba(255,107,0,.12), rgba(255,107,0,.03));
    }

    .action-grid { display: grid; gap: 10px; grid-template-columns: repeat(3, minmax(0,1fr)); }
    .btnx { border-radius: 12px; padding: 12px; font-size: 11px; font-weight: 900; text-transform: uppercase; letter-spacing: .08em; }

    .students-grid { display: grid; gap: 10px; grid-template-columns: repeat(2, minmax(0,1fr)); }
    .studentx {
        border: 1px solid var(--prof-border);
        border-radius: 12px;
        background: var(--prof-bg);
        padding: 10px;
    }

    .local-grid { display: grid; gap: 18px; grid-template-columns: 2fr 1fr; }
    .feed-list > div { border-top: 1px solid var(--prof-border); padding: 12px 2px; }

    @media (max-width: 1180px) {
        .studio-grid, .local-grid { grid-template-columns: 1fr; }
        .hero-kpi { grid-template-columns: repeat(2, minmax(0,1fr)); }
        .action-grid { grid-template-columns: 1fr; }
        .students-grid { grid-template-columns: 1fr; }
    }
</style>

{% if external_professor_mode %}
<div class="dash-wrap">
    {% if external_error %}
    <div class="cardx" style="border-color:#f59e0b;background:#fffbeb;color:#92400e;">Source Barka temporairement indisponible.</div>
    {% endif %}

    <section class="hero-panel">
        <p class="kpi-l mb-2">Live Command</p>
        <h2 class="text-2xl font-black mb-1">{{ external_selected_session.titre|default:"No session selected" }}</h2>
        <p class="text-sm text-slate-300 mb-4">{{ external_selected_session.ville_name|default:"-" }} · {{ external_selected_session.session_type|default:"-" }} · {{ external_selected_session.statut|default:"-" }}</p>
        <div class="hero-kpi">
            <div><p class="kpi-l">Sessions</p><p class="kpi-v">{{ external_sessions|length }}</p></div>
            <div><p class="kpi-l">Students</p><p class="kpi-v">{{ students_count }}</p></div>
            <div><p class="kpi-l">Online Web</p><p class="kpi-v">{{ online_students_count|default:0 }}</p></div>
            <div><p class="kpi-l">Live</p><p class="kpi-v">{% if external_live_state and external_live_state.status == 'live' %}On Air{% elif external_live_state and external_live_state.status == 'paused' %}Paused{% else %}Offline{% endif %}</p></div>
        </div>
    </section>

    <section class="studio-grid">
        <aside class="cardx">
            <div class="flex items-center justify-between mb-3">
                <h3 class="text-xs font-black uppercase tracking-[.14em]" style="color:var(--prof-text-main);">Barka Sessions</h3>
                <span class="text-xs font-bold" style="color:var(--prof-text-muted);">{{ external_sessions|length }}</span>
            </div>
            <div class="space-y-2 max-h-[470px] overflow-y-auto pr-1">
                {% for sess in external_sessions %}
                <a href="?session_id={{ sess.id }}" class="session-tile {% if external_selected_session and external_selected_session.id == sess.id %}active{% endif %}">
                    <p class="text-sm font-black" style="color:var(--prof-text-main);">{{ sess.titre|default:"Session" }}</p>
                    <p class="text-[11px] mt-1" style="color:var(--prof-text-muted);">{{ sess.ville_name|default:"-" }} · {{ sess.statut|default:"-" }}</p>
                </a>
                {% empty %}
                <div class="session-tile"><p class="text-sm font-bold" style="color:var(--prof-text-muted);">No sessions available.</p></div>
                {% endfor %}
            </div>
        </aside>

        <div class="cardx space-y-4">
            {% if external_selected_session %}
            <div class="action-grid">
                <form method="post" action="{% url 'Prolean:external_professor_live_start' external_selected_session.id %}">{% csrf_token %}<button class="btnx w-full bg-emerald-600 text-white {% if external_live_state and external_live_state.status == 'live' %}opacity-60{% endif %}">Start & Join</button></form>
                <form method="post" action="{% url 'Prolean:external_professor_live_pause' external_selected_session.id %}">{% csrf_token %}<button class="btnx w-full bg-amber-500 text-white {% if not external_live_state or external_live_state.status != 'live' %}opacity-60{% endif %}">Pause</button></form>
                {% if external_live_state and external_live_state.status == 'live' %}
                <a href="{% url 'Prolean:external_live_room' external_selected_session.id %}" class="btnx text-center bg-brand text-white inline-flex items-center justify-center">Open Studio</a>
                {% else %}
                <div class="btnx text-center border" style="border-color:var(--prof-border);color:var(--prof-text-muted);">Studio Inactive</div>
                {% endif %}
            </div>

            <form method="post" action="{% url 'Prolean:external_professor_live_end' external_selected_session.id %}" class="grid grid-cols-1 md:grid-cols-[1fr_auto] gap-2">
                {% csrf_token %}
                <input type="url" name="recording_url" placeholder="Recording URL" class="px-3 py-2 rounded-xl border" style="border-color:var(--prof-border);background:var(--prof-bg);color:var(--prof-text-main);">
                <button class="btnx bg-red-600 text-white">End Live</button>
            </form>

            <form method="post" action="{% url 'Prolean:external_send_session_notification' external_selected_session.id %}" class="grid grid-cols-1 md:grid-cols-4 gap-2">
                {% csrf_token %}
                <input type="text" name="title" required placeholder="Broadcast title" class="md:col-span-1 px-3 py-2 rounded-xl border" style="border-color:var(--prof-border);background:var(--prof-bg);color:var(--prof-text-main);">
                <input type="text" name="message" required placeholder="Message to all session students" class="md:col-span-2 px-3 py-2 rounded-xl border" style="border-color:var(--prof-border);background:var(--prof-bg);color:var(--prof-text-main);">
                <button class="btnx md:col-span-1 bg-prof-text-main text-prof-bg" style="background:var(--prof-text-main);color:var(--prof-bg);">Broadcast</button>
            </form>

            <div>
                <div class="flex items-center justify-between mb-2">
                    <h4 class="text-xs font-black uppercase tracking-[.14em]" style="color:var(--prof-text-main);">Students In Session</h4>
                    <span class="text-xs font-bold" style="color:var(--prof-text-muted);">{{ students_count }}</span>
                </div>
                <div class="students-grid">
                    {% for st in external_students %}
                    <article class="studentx">
                        <div class="flex items-center justify-between gap-2">
                            <p class="text-sm font-black" style="color:var(--prof-text-main);">{{ st.student_name|default:"Student" }}</p>
                            {% if st.is_online_web %}<span class="px-2 py-1 rounded-full text-[10px] font-black bg-emerald-100 text-emerald-700">Online</span>{% else %}<span class="px-2 py-1 rounded-full text-[10px] font-black bg-neutral-200 text-neutral-700">Offline</span>{% endif %}
                        </div>
                        <p class="text-xs mt-1" style="color:var(--prof-text-muted);">{{ st.student_email|default:"-" }}</p>
                        <p class="text-xs" style="color:var(--prof-text-muted);">{{ st.student_phone|default:"-" }}</p>
                    </article>
                    {% empty %}
                    <div class="studentx" style="grid-column:1/-1;"><p class="text-sm font-bold" style="color:var(--prof-text-muted);">No student in this session.</p></div>
                    {% endfor %}
                </div>
            </div>
            {% else %}
            <div class="studentx"><p class="text-sm font-bold" style="color:var(--prof-text-muted);">Select a session to open controls.</p></div>
            {% endif %}
        </div>
    </section>
</div>
{% else %}
<div class="dash-wrap">
    {% if not selected_session %}
    <div class="cardx text-center py-14">
        <h3 class="text-2xl font-black mb-2" style="color:var(--prof-text-main);">No active session</h3>
        <p class="text-sm font-semibold" style="color:var(--prof-text-muted);">Select one session to unlock your studio controls.</p>
        {% if all_sessions %}
        <div class="flex flex-wrap items-center justify-center gap-2 mt-6">
            {% for sess in all_sessions %}<a href="?session_id={{ sess.id }}" class="px-4 py-2 rounded-xl bg-brand text-white text-sm font-black">{{ sess.city.name }}</a>{% endfor %}
        </div>
        {% endif %}
    </div>
    {% else %}
    <section class="hero-panel">
        <p class="kpi-l mb-2">Local Session</p>
        <h2 class="text-2xl font-black mb-1">{{ selected_session.city.name }} · {{ selected_session.get_status_display }}</h2>
        <div class="hero-kpi">
            <div><p class="kpi-l">Students</p><p class="kpi-v">{{ students_count }}</p></div>
            <div><p class="kpi-l">Comments</p><p class="kpi-v">{{ recent_comments|length }}</p></div>
            <div><p class="kpi-l">Streams</p><p class="kpi-v">{{ active_streams|length }}</p></div>
            <div><p class="kpi-l">Upcoming</p><p class="kpi-v">{{ upcoming_sessions|length }}</p></div>
        </div>
    </section>

    <section class="local-grid">
        <div class="cardx space-y-4">
            <div class="flex items-center justify-between">
                <h3 class="text-lg font-black" style="color:var(--prof-text-main);">Live Studio</h3>
                {% if selected_session.status == 'ONGOING' %}
                    {% if active_streams %}
                        {% for stream in active_streams %}<a href="{% url 'Prolean:live_session' stream.id %}" class="btnx bg-red-600 text-white">Join Live</a>{% endfor %}
                    {% else %}
                        <a href="{% url 'Prolean:start_live_stream' selected_session.id %}" class="btnx bg-brand text-white">Start Live</a>
                    {% endif %}
                {% else %}
                    <span class="text-xs font-black uppercase" style="color:var(--prof-text-muted);">Session inactive</span>
                {% endif %}
            </div>

            <div class="feed-list">
                <div class="border-0 pt-0">
                    <h4 class="text-xs font-black uppercase tracking-[.12em]" style="color:var(--prof-text-muted);">Recent Interactions</h4>
                </div>
                {% for comment in recent_comments %}
                <div>
                    <p class="text-sm font-black" style="color:var(--prof-text-main);">{{ comment.student.profile.full_name }}</p>
                    <p class="text-sm" style="color:var(--prof-text-muted);">{{ comment.content|truncatechars:140 }}</p>
                    <a href="{% url 'Prolean:professor_comments' %}?student_id={{ comment.student.id }}" class="text-xs font-black text-brand">Reply</a>
                </div>
                {% empty %}
                <div><p class="text-sm font-bold" style="color:var(--prof-text-muted);">No recent interactions.</p></div>
                {% endfor %}
            </div>
        </div>

        <div class="cardx">
            <h3 class="text-xs font-black uppercase tracking-[.12em] mb-4" style="color:var(--prof-text-muted);">Broadcast</h3>
            <form action="{% url 'Prolean:send_session_notification' selected_session.id %}" method="post" class="space-y-3">
                {% csrf_token %}
                <input type="text" name="title" placeholder="Subject" required class="w-full px-3 py-2 rounded-xl border" style="border-color:var(--prof-border);background:var(--prof-bg);color:var(--prof-text-main);">
                <textarea name="message" rows="5" placeholder="Your message..." required class="w-full px-3 py-2 rounded-xl border resize-none" style="border-color:var(--prof-border);background:var(--prof-bg);color:var(--prof-text-main);"></textarea>
                <button class="btnx w-full bg-brand text-white">Send Announcement</button>
            </form>

            <form action="{% url 'Prolean:update_session_status' selected_session.id %}" method="post" class="mt-4">
                {% csrf_token %}
                <input type="hidden" name="status" value="COMPLETED">
                {% if selected_session.status != 'COMPLETED' %}
                <button class="btnx w-full bg-red-600 text-white">Close Session</button>
                {% else %}
                <div class="btnx text-center border" style="border-color:var(--prof-border);color:var(--prof-text-muted);">Session already closed</div>
                {% endif %}
            </form>
        </div>
    </section>
    {% endif %}
</div>
{% endif %}
{% endblock %}
