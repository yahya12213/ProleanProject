{% extends 'Prolean/professor/base_professor.html' %}
{% load static %}

{% block header_title %}Gestion des Étudiants{% endblock %}
{% block header_subtitle %}Suivi détaillé de votre cohorte et progrès académiques.{% endblock %}

{% block professor_content %}
{% if external_professor_mode %}
<div class="space-y-8">
    <div class="glass-card p-6 flex items-center justify-between">
        <div>
            <h2 class="text-xl font-black" style="color: var(--prof-text-main);">Étudiants par Session (Barka)</h2>
            <p class="text-sm opacity-70" style="color: var(--prof-text-muted);">Live assignments from management system.</p>
        </div>
        <span class="text-2xl font-black text-brand">{{ external_students|length }}</span>
    </div>

    {% if external_sessions %}
    <div class="flex flex-wrap gap-3">
        {% for sess in external_sessions %}
        <a href="?session_id={{ sess.id }}" class="px-4 py-2 rounded-xl border font-bold text-sm {% if external_selected_session and external_selected_session.id == sess.id %}bg-brand text-white border-brand{% else %}bg-surface-hover border-prof{% endif %}">
            {{ sess.titre|default:"Session" }}
        </a>
        {% endfor %}
    </div>
    {% endif %}

    <div class="glass-card p-5">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
            <div>
                <h3 class="font-black text-base" style="color: var(--prof-text-main);">WhatsApp Broadcast Queue</h3>
                <p class="text-xs opacity-70" style="color: var(--prof-text-muted);">Generate one-time links and send Arabic caution message one-by-one or to all students.</p>
            </div>
            <button type="button" id="send-all-whatsapp" class="btnx sky"
                {% if not external_selected_session or not external_selected_session.id %}disabled{% endif %}>
                Send All on WhatsApp
            </button>
        </div>
        <div id="broadcast-status" class="text-xs mt-3 opacity-70" style="color: var(--prof-text-muted);"></div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {% for st in external_students %}
        <div class="glass-card p-5">
            <h3 class="font-black text-lg" style="color: var(--prof-text-main);">{{ st.display_name|default:st.student_name|default:"Étudiant" }}</h3>
            <p class="text-xs opacity-70 mt-1" style="color: var(--prof-text-muted);">{{ st.display_email|default:st.student_email|default:"-" }}</p>
            <p class="text-xs opacity-70" style="color: var(--prof-text-muted);">{{ st.display_phone|default:st.student_phone|default:"-" }}</p>
            <div class="mt-4 text-[10px] uppercase tracking-widest font-bold opacity-60">{{ st.formation_title|default:"Formation" }}</div>

            <div class="mt-4 grid grid-cols-2 gap-2">
                <div class="px-3 py-2 rounded-xl bg-surface-hover border border-prof">
                    <div class="text-[9px] font-black uppercase tracking-widest opacity-50" style="color: var(--prof-text-muted);">Watched</div>
                    <div class="text-sm font-black" style="color: var(--prof-text-main);">{{ st.tracking_watch_label|default:"0m" }}</div>
                </div>
                <div class="px-3 py-2 rounded-xl bg-surface-hover border border-prof">
                    <div class="text-[9px] font-black uppercase tracking-widest opacity-50" style="color: var(--prof-text-muted);">Engagement</div>
                    <div class="text-sm font-black" style="color: var(--prof-text-main);">{{ st.tracking_engagement|floatformat:0|default:"0" }}</div>
                </div>
                <div class="px-3 py-2 rounded-xl bg-surface-hover border border-prof">
                    <div class="text-[9px] font-black uppercase tracking-widest opacity-50" style="color: var(--prof-text-muted);">Speaking</div>
                    <div class="text-sm font-black" style="color: var(--prof-text-main);">{{ st.tracking_speaking_label|default:"0m" }}</div>
                    <div class="text-[10px] font-black opacity-60" style="color: var(--prof-text-muted);">{{ st.tracking_speaks|default:0 }} starts</div>
                </div>
                <div class="px-3 py-2 rounded-xl bg-surface-hover border border-prof">
                    <div class="text-[9px] font-black uppercase tracking-widest opacity-50" style="color: var(--prof-text-muted);">Hand up</div>
                    <div class="text-sm font-black" style="color: var(--prof-text-main);">{{ st.tracking_hand_label|default:"0m" }}</div>
                    <div class="text-[10px] font-black opacity-60" style="color: var(--prof-text-muted);">{{ st.tracking_hands|default:0 }} raises</div>
                </div>
            </div>

            <div class="mt-4 px-4 py-3 rounded-2xl bg-surface-hover border border-prof">
                <div class="text-[9px] font-black uppercase tracking-widest opacity-50" style="color: var(--prof-text-muted);">One-click join link</div>
                <div class="text-[10px] opacity-70 mt-1" style="color: var(--prof-text-muted);">CIN: {{ st.display_cin|default:"-" }}</div>
                <div class="text-[10px] opacity-70" style="color: var(--prof-text-muted);">Status: {{ st.join_invite_status|default:"none"|upper }}</div>
                {% if st.join_invite_created_at %}
                <div class="text-[10px] opacity-70" style="color: var(--prof-text-muted);">Generated: {{ st.join_invite_created_at|date:"Y-m-d H:i" }}</div>
                {% endif %}
                {% if st.join_invite_expires_at %}
                <div class="text-[10px] opacity-70" style="color: var(--prof-text-muted);">Expires: {{ st.join_invite_expires_at|date:"Y-m-d H:i" }}</div>
                {% endif %}
                {% if st.join_invite_used_at %}
                <div class="text-[10px] opacity-70" style="color: var(--prof-text-muted);">Used: {{ st.join_invite_used_at|date:"Y-m-d H:i" }}</div>
                {% endif %}
                {% if st.join_invite_used_location %}
                <div class="text-[10px] opacity-70" style="color: var(--prof-text-muted);">Location: {{ st.join_invite_used_location }}</div>
                {% endif %}
                {% if st.join_invite_used_device %}
                <div class="text-[10px] opacity-70" style="color: var(--prof-text-muted);">Device: {{ st.join_invite_used_device }}</div>
                {% endif %}
                <div class="mt-3 flex gap-2">
                    <button type="button" class="btnx sky flex-1"
                        {% if not external_selected_session or not external_selected_session.id or not st.display_cin %}disabled{% endif %}
                        onclick="generateJoinLink('{{ external_selected_session.id|default:'' }}', '{{ st.display_cin|escapejs }}', '{{ st.display_name|escapejs }}', this)">
                        Generate New & Copy
                    </button>
                    <button type="button" class="btnx flex-1 border border-prof"
                        data-send-whatsapp="1"
                        data-session-id="{{ external_selected_session.id|default:'' }}"
                        data-cin="{{ st.display_cin|default:''|escapejs }}"
                        data-name="{{ st.display_name|default:''|escapejs }}"
                        data-phone="{{ st.display_phone|default:''|escapejs }}"
                        data-email="{{ st.display_email|default:''|escapejs }}"
                        {% if not external_selected_session or not external_selected_session.id or not st.display_cin %}disabled{% endif %}
                        onclick="sendSingleWhatsApp(this)">
                        Send via WhatsApp
                    </button>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-span-full py-20 text-center opacity-60">
            <span class="material-symbols-outlined text-4xl text-muted">person_off</span>
            <p class="font-bold mt-3">Aucun étudiant trouvé pour cette session</p>
        </div>
        {% endfor %}
    </div>

    <div class="glass-card p-5">
        <div class="flex items-center justify-between">
            <h3 class="font-black text-base" style="color: var(--prof-text-main);">Auto Attendance Timeline</h3>
            <span class="text-[10px] opacity-60" style="color: var(--prof-text-muted);">Live + link + moderation activity</span>
        </div>
        <div class="mt-4 space-y-2 max-h-[26rem] overflow-auto pr-1">
            {% for event in attendance_timeline %}
            <div class="rounded-xl border border-prof bg-surface-hover px-3 py-2">
                <div class="text-[11px] font-black" style="color: var(--prof-text-main);">{{ event.event_label }} • {{ event.student_name }}</div>
                {% if event.meta_label %}
                <div class="text-[10px] opacity-70" style="color: var(--prof-text-muted);">{{ event.meta_label }}</div>
                {% endif %}
                <div class="text-[10px] opacity-60" style="color: var(--prof-text-muted);">{{ event.happened_at|date:"Y-m-d H:i:s" }}</div>
            </div>
            {% empty %}
            <div class="text-xs opacity-60" style="color: var(--prof-text-muted);">No timeline events yet for this session.</div>
            {% endfor %}
        </div>
    </div>
</div>
{% else %}
<div class="space-y-8">
    <!-- Header with Stats -->
    <div class="glass-card p-6 flex flex-col md:flex-row items-center justify-between gap-6">
        <div class="flex items-center gap-4">
            <div class="size-12 rounded-xl bg-brand-light text-brand flex items-center justify-center">
                <span class="material-symbols-outlined text-2xl">school</span>
            </div>
            <div>
                <h2 class="text-xs font-black uppercase tracking-widest opacity-50 mb-1" style="color: var(--prof-text-muted);">Cohorte Active</h2>
                <div class="flex items-center gap-2">
                    <span class="text-xl font-black tracking-tight" style="color: var(--prof-text-main);">
                        {% if selected_session %}
                            {{ selected_session.city }}<span class="opacity-50 mx-2">•</span>{{ selected_session.start_date|date:"F Y" }}
                        {% else %}
                            Toutes Sessions
                        {% endif %}
                    </span>
                </div>
            </div>
        </div>
        <div class="flex items-center gap-2 px-4 py-2 rounded-xl bg-surface-hover border border-prof">
            <span class="text-2xl font-black text-brand">{{ students.count }}</span>
            <span class="text-xs font-bold uppercase tracking-widest opacity-70" style="color: var(--prof-text-muted);">Inscrits</span>
        </div>
    </div>

    <!-- Students Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {% for student in students %}
        <div class="glass-card group overflow-hidden hover:-translate-y-1 transition-all duration-300">
            <!-- Card Header Gradient -->
            <div class="h-1 bg-gradient-to-r from-brand to-brand-light opacity-50"></div>
            
            <div class="p-6">
                <div class="flex items-start gap-4 mb-6">
                    <div class="size-16 rounded-2xl bg-surface-hover text-brand flex items-center justify-center font-black text-xl shadow-inner group-hover:scale-105 transition-transform">
                        {% if student.profile.profile_picture %}
                        <img src="{{ student.profile.profile_picture }}" class="size-full object-cover rounded-2xl">
                        {% else %}
                        {{ student.profile.full_name|first|upper }}
                        {% endif %}
                    </div>
                    <div class="flex-1 min-w-0">
                        <h3 class="text-lg font-black tracking-tight mb-1 truncate" style="color: var(--prof-text-main);">{{ student.profile.full_name }}</h3>
                        <p class="text-xs font-medium truncate opacity-60 mb-2" style="color: var(--prof-text-muted);">{{ student.user.email }}</p>
                        <span class="inline-flex items-center gap-1.5 px-2 py-1 rounded-md badge-success text-[10px] font-bold uppercase tracking-wider">
                            <span class="size-1.5 rounded-full bg-green-500 animate-pulse"></span>
                            Actif
                        </span>
                    </div>
                </div>

                <div class="space-y-4">
                    <!-- Formations -->
                    <div class="space-y-2">
                        <p class="text-[9px] font-black uppercase tracking-widest opacity-40" style="color: var(--prof-text-muted);">Formations</p>
                        <div class="flex flex-wrap gap-2">
                            {% for formation in student.authorized_formations.all %}
                            <span class="px-2 py-1 bg-surface-hover border border-prof rounded-lg text-[10px] font-bold uppercase tracking-wide opacity-80" style="color: var(--prof-text-main);">
                                {{ formation.title|truncatechars:18 }}
                            </span>
                            {% empty %}
                            <span class="text-[10px] italic opacity-40" style="color: var(--prof-text-muted);">Aucune formation</span>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Contact Details -->
                    <div class="grid grid-cols-2 gap-3 pt-4 border-t border-prof">
                        <div>
                            <p class="text-[9px] font-black uppercase tracking-widest opacity-40 mb-1" style="color: var(--prof-text-muted);">Ville</p>
                            <p class="text-xs font-bold" style="color: var(--prof-text-main);">{{ student.profile.city|default:"—" }}</p>
                        </div>
                        <div>
                            <p class="text-[9px] font-black uppercase tracking-widest opacity-40 mb-1" style="color: var(--prof-text-muted);">Contact</p>
                            <p class="text-xs font-bold truncate" style="color: var(--prof-text-main);">{{ student.profile.phone_number|default:"—" }}</p>
                        </div>
                    </div>
                </div>

                <!-- Actions -->
                <div class="mt-6 flex items-center justify-between gap-3">
                    <div class="flex items-center gap-2">
                        <a href="mailto:{{ student.user.email }}" class="size-9 rounded-xl border border-prof flex items-center justify-center text-muted hover:text-brand hover:border-brand transition-colors" style="color: var(--prof-text-muted);">
                            <span class="material-symbols-outlined text-lg">mail</span>
                        </a>
                        {% if student.profile.phone_number %}
                        <a href="https://wa.me/{{ student.profile.phone_number }}" target="_blank" 
                           class="size-9 rounded-xl border border-prof flex items-center justify-center text-muted hover:text-green-500 hover:border-green-500 transition-colors" style="color: var(--prof-text-muted);">
                            <span class="material-symbols-outlined text-lg">chat</span>
                        </a>
                        {% endif %}
                    </div>
                    <!-- Removed Dossier Suivis Button as requested -->
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-span-full py-20 text-center">
            <div class="size-20 rounded-full bg-surface-hover flex items-center justify-center mx-auto mb-6 opacity-50">
                <span class="material-symbols-outlined text-4xl" style="color: var(--prof-text-muted);">person_off</span>
            </div>
            <h3 class="text-xl font-black mb-2" style="color: var(--prof-text-main);">Aucun étudiant trouvé</h3>
            <p class="text-sm opacity-60" style="color: var(--prof-text-muted);">Cette session ne compte actuellement aucun inscrit.</p>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
{{ block.super }}
{% if external_professor_mode %}
<script>
  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
    return '';
  }
  function normalizeWhatsAppPhone(rawPhone) {
    let digits = String(rawPhone || '').replace(/\D+/g, '');
    if (!digits) return '';
    if (digits.startsWith('00')) digits = digits.slice(2);
    if (digits.length === 10 && digits.startsWith('0')) digits = `212${digits.slice(1)}`;
    return digits;
  }
  function cautionMessageArabic(joinUrl) {
    return `رابط الحصة الخاصة بك: ${joinUrl}. يرجى عدم مشاركة هذا الرابط مع أي شخص آخر للحفاظ على أمان الفصل.`;
  }
  async function trackWhatsAppClick(phone, message) {
    try {
      await fetch('/api/track-whatsapp/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ phone_number: phone || '', message: message || '', url: window.location.pathname }),
      });
    } catch (_) {}
  }
  async function requestJoinLink(sessionId, cin, name, email, phone) {
    const resp = await fetch(`/external/live/invite/${encodeURIComponent(sessionId)}/regen/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken'),
      },
      body: JSON.stringify({ cin, name, email, phone }),
    });
    const text = await resp.text();
    let data = {};
    try { data = JSON.parse(text || '{}'); } catch (_) { data = {}; }
    if (!data || !data.ok || !data.join_url) {
      const msg = (data && data.error) ? data.error : (text || `Unable to generate link (HTTP ${resp.status}).`);
      throw new Error(String(msg).slice(0, 600));
    }
    return data;
  }
  async function generateJoinLink(sessionId, cin, name, btn) {
    try {
      if (!sessionId || !cin) return;
      if (btn) btn.disabled = true;
      const data = await requestJoinLink(sessionId, cin, name, '', '');
      try {
        await navigator.clipboard.writeText(String(data.join_url));
      } catch (e) {
        prompt('Copy this link:', String(data.join_url));
      }
      alert('Join link copied.');
    } catch (e) {
      alert('Unable to generate link.');
    } finally {
      if (btn) btn.disabled = false;
    }
  }
  async function sendSingleWhatsApp(btn, options = {}) {
    if (!btn) return;
    const sessionId = btn.dataset.sessionId || '';
    const cin = btn.dataset.cin || '';
    const name = btn.dataset.name || '';
    const email = btn.dataset.email || '';
    const phone = btn.dataset.phone || '';
    if (!sessionId || !cin) return;
    const original = btn.textContent;
    try {
      btn.disabled = true;
      btn.textContent = 'Generating...';
      const data = await requestJoinLink(sessionId, cin, name, email, phone);
      const msg = cautionMessageArabic(String(data.join_url));
      const waPhone = normalizeWhatsAppPhone(phone);
      const waUrl = waPhone
        ? `https://wa.me/${encodeURIComponent(waPhone)}?text=${encodeURIComponent(msg)}`
        : `https://wa.me/?text=${encodeURIComponent(msg)}`;
      const opened = window.open(waUrl, '_blank', 'noopener');
      await trackWhatsAppClick(waPhone, msg);
      if (!opened) alert('Popup blocked. Allow popups for this site to open WhatsApp queue.');
      btn.textContent = 'Sent';
      setTimeout(() => { btn.textContent = original; }, 1400);
      return !!opened;
    } catch (e) {
      if (!options.silent) {
        alert(String(e && e.message ? e.message : 'Unable to send via WhatsApp.'));
      }
      btn.textContent = original;
      return false;
    } finally {
      btn.disabled = false;
    }
  }
  async function sendAllWhatsAppQueue() {
    const status = document.getElementById('broadcast-status');
    const buttons = Array.from(document.querySelectorAll('button[data-send-whatsapp="1"]'))
      .filter((btn) => !btn.disabled);
    if (!buttons.length) {
      if (status) status.textContent = 'No students available for WhatsApp queue.';
      return;
    }
    let sent = 0;
    let failed = 0;
    for (let index = 0; index < buttons.length; index += 1) {
      const btn = buttons[index];
      const label = btn.dataset.name || btn.dataset.cin || `Student ${index + 1}`;
      if (status) status.textContent = `Queue ${index + 1}/${buttons.length}: ${label}`;
      const ok = await sendSingleWhatsApp(btn, { silent: true });
      if (ok) {
        sent += 1;
      } else {
        failed += 1;
      } 
      await new Promise((resolve) => setTimeout(resolve, 400));
    }
    if (status) status.textContent = `Broadcast queue completed. Sent: ${sent}, Failed: ${failed}.`;
  }
  (function initBroadcastQueue() {
    const sendAllBtn = document.getElementById('send-all-whatsapp');
    if (!sendAllBtn) return;
    sendAllBtn.addEventListener('click', async () => {
      sendAllBtn.disabled = true;
      const original = sendAllBtn.textContent;
      sendAllBtn.textContent = 'Sending queue...';
      try {
        await sendAllWhatsAppQueue();
      } finally {
        sendAllBtn.disabled = false;
        sendAllBtn.textContent = original;
      }
    });
  })();
</script>
{% endif %}
{% endblock %}
