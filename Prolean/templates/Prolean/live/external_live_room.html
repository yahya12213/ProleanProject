{% extends 'Prolean/base.html' %}
{% load static %}

{% block title %}Live Presenter Room{% endblock %}
{% block main_class %}w-full max-w-none{% endblock %}
{% block extra_css %}
<style>
    html, body {
        height: 100%;
        max-height: 100%;
        overflow: hidden;
    }

    #contact, .floating-buttons { display: none !important; }
    body > header, body > footer { display: none !important; }

    .presenter-room {
        --bg-main: linear-gradient(180deg, #14171c 0%, #101318 100%);
        --text-main: #e5e7eb;
        --panel-bg: #11141a;
        --top-bg: #15181d;
        --panel-border: rgba(148, 163, 184, 0.24);
        --top-border: rgba(148, 163, 184, 0.2);
        --media-bg: #090b0f;
        --label-bg: rgba(0, 0, 0, 0.65);
        --muted-text: #cbd5e1;
        --layout-bg: #1b212b;
        --ctrl-bg: #222a35;
        --mode-bg: #202733;
        --resizer-bg: linear-gradient(180deg, rgba(148, 163, 184, 0.18), rgba(148, 163, 184, 0.08));
        --resizer-border: rgba(148, 163, 184, 0.25);
        --empty-text: #9ca3af;
        height: 100vh;
        max-height: 100vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        background: var(--bg-main);
        color: var(--text-main);
        font-family: "Plus Jakarta Sans", sans-serif;
    }

    .presenter-room[data-ui-theme="light"] {
        --bg-main: linear-gradient(180deg, #f8fafc 0%, #eef2f7 100%);
        --text-main: #0f172a;
        --panel-bg: #ffffff;
        --top-bg: #f8fafc;
        --panel-border: rgba(15, 23, 42, 0.12);
        --top-border: rgba(15, 23, 42, 0.12);
        --media-bg: #e5e7eb;
        --label-bg: rgba(15, 23, 42, 0.75);
        --muted-text: #334155;
        --layout-bg: #f1f5f9;
        --ctrl-bg: #e2e8f0;
        --mode-bg: #e2e8f0;
        --resizer-bg: linear-gradient(180deg, rgba(15, 23, 42, 0.14), rgba(15, 23, 42, 0.06));
        --resizer-border: rgba(15, 23, 42, 0.18);
        --empty-text: #475569;
    }

    .room-top {
        border-bottom: 1px solid var(--top-border);
        background: var(--top-bg);
        flex: 0 0 auto;
    }

    .room-title {
        color: var(--muted-text);
    }

    .room-shell {
        display: grid;
        grid-template-columns: minmax(0, 1fr) 10px minmax(320px, var(--right-pane-width, 28%));
        grid-template-areas: "left resize right";
        gap: 14px;
        flex: 1 1 auto;
        min-height: 0;
        padding: 12px;
        overflow: hidden;
    }

    @media (max-width: 1100px) {
        .room-shell {
            grid-template-columns: 1fr;
            grid-template-areas: "left" "right";
            grid-template-rows: minmax(0, 1fr) minmax(0, 1fr);
        }

        .pane-resizer {
            display: none;
        }

        .pane-main, .pane-side {
            min-height: 0;
        }
    }

    .pane {
        border: 1px solid var(--panel-border);
        background: var(--panel-bg);
        border-radius: 12px;
        overflow: hidden;
        position: relative;
        display: flex;
        flex-direction: column;
    }

    .pane-main {
        min-height: 62vh;
        grid-area: left;
    }

    .pane-side {
        min-height: 62vh;
        cursor: pointer;
        min-width: 0;
        grid-area: right;
    }

    .right-split {
        height: 100%;
        display: grid;
        grid-template-rows: 1fr 1fr;
        min-height: 0;
    }

    .right-split-top, .right-split-bottom {
        position: relative;
        min-height: 0;
        background: var(--media-bg);
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }

    .right-split-bottom {
        border-top: 2px solid #f97316;
    }

    .pane-title {
        position: absolute;
        top: 8px;
        left: 8px;
        z-index: 5;
        background: var(--label-bg);
        border: 1px solid var(--panel-border);
        border-radius: 8px;
        padding: 4px 8px;
        font-size: 11px;
        font-weight: 800;
        letter-spacing: 0.06em;
        text-transform: uppercase;
    }

    .speaker-border {
        box-shadow: inset 0 0 0 2px #22c55e;
    }

    .raised-border {
        box-shadow: inset 0 0 0 2px #ef4444;
    }

    .video-host {
        width: 100%;
        height: 100%;
        background: var(--media-bg);
        flex: 1;
        min-height: 0;
    }

    .video-host video {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .avatar-host {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: radial-gradient(circle at 20% 20%, #1f2937 0%, #0b0d11 100%);
    }

    .avatar-badge {
        width: 96px;
        height: 96px;
        border-radius: 999px;
        background: #f97316;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #fff;
        font-size: 38px;
        font-weight: 900;
    }

    .student-grid {
        display: grid;
        grid-template-columns: repeat(var(--student-grid-cols, 2), minmax(0, 1fr));
        gap: 8px;
        padding: 40px 8px 8px;
        height: 100%;
        min-height: 0;
        overflow: auto;
    }

    .student-grid.compact {
        grid-template-columns: repeat(1, minmax(0, 1fr));
        grid-auto-rows: minmax(0, 1fr);
    }

    .student-grid.compact .student-card {
        min-height: 0;
    }

    .student-card {
        min-height: var(--student-tile-min-h, 120px);
        border: 1px solid var(--panel-border);
        border-radius: 10px;
        overflow: hidden;
        position: relative;
        background: var(--media-bg);
    }

    .student-card video {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .student-label {
        position: absolute;
        left: 6px;
        bottom: 6px;
        z-index: 4;
        padding: 3px 7px;
        border-radius: 7px;
        background: var(--label-bg);
        color: #fff;
        font-size: 11px;
        font-weight: 700;
    }

    .controls-bar {
        border-top: 1px solid var(--top-border);
        background: var(--top-bg);
        padding: 10px 12px;
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
        flex: 0 0 auto;
    }

    .ctrl-btn {
        width: 42px;
        height: 42px;
        border-radius: 10px;
        border: 1px solid var(--panel-border);
        background: var(--ctrl-bg);
        color: var(--text-main);
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }

    .ctrl-btn[data-state="off"] {
        background: rgba(239, 68, 68, 0.18);
        border-color: rgba(239, 68, 68, 0.45);
        color: #fca5a5;
    }

    .mode-btn {
        height: 32px;
        padding: 0 10px;
        border-radius: 8px;
        border: 1px solid var(--panel-border);
        background: var(--mode-bg);
        color: var(--muted-text);
        font-size: 11px;
        font-weight: 800;
        text-transform: uppercase;
        letter-spacing: 0.06em;
    }

    .mode-btn.active {
        background: #f97316;
        border-color: #fb923c;
        color: #111827;
    }

    .layout-panel {
        margin-left: auto;
        display: none;
        align-items: center;
        gap: 8px;
        background: var(--layout-bg);
        border: 1px solid var(--panel-border);
        border-radius: 10px;
        padding: 8px;
    }

    .layout-panel.open {
        display: flex;
        flex-wrap: wrap;
    }

    .layout-item {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        color: var(--muted-text);
        font-size: 11px;
        font-weight: 700;
    }

    .layout-item input[type="range"] {
        width: 88px;
    }

    .layout-item .value {
        min-width: 26px;
        text-align: right;
        color: #f8fafc;
    }

    .room-fullscreen .room-top {
        display: none;
    }

    @media (max-width: 1100px) {
        html, body {
            overflow-y: auto;
        }

        .presenter-room {
            height: 100dvh;
            max-height: 100dvh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .room-shell {
            min-height: 0;
        }
    }

    @media (max-width: 900px) {

        .room-shell {
            padding: 8px;
            gap: 8px;
        }

        .controls-bar {
            padding: 8px;
            gap: 6px;
            overflow-x: auto;
            flex-wrap: nowrap;
        }

        .ctrl-btn {
            width: 40px;
            height: 40px;
            flex: 0 0 auto;
        }

        .mode-btn {
            height: 30px;
            padding: 0 8px;
        }
    }

    .presenter-room.swapped .room-shell {
        grid-template-columns: minmax(320px, var(--right-pane-width, 28%)) 10px minmax(0, 1fr);
        grid-template-areas: "right resize left";
    }

    .presenter-room.swapped #pane-resizer {
        cursor: col-resize;
    }

    .pane-resizer {
        grid-area: resize;
        align-self: stretch;
        border-radius: 999px;
        background: var(--resizer-bg);
        border: 1px solid var(--resizer-border);
        position: relative;
        cursor: col-resize;
        touch-action: none;
    }

    .pane-resizer::after {
        content: "";
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 4px;
        height: 32px;
        border-radius: 999px;
        background: rgba(203, 213, 225, 0.45);
    }

    .pane-resizer.dragging {
        background: linear-gradient(180deg, rgba(249, 115, 22, 0.45), rgba(249, 115, 22, 0.2));
        border-color: rgba(249, 115, 22, 0.7);
    }

    .empty-students {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        color: var(--empty-text);
        font-size: 18px;
        font-weight: 700;
        padding: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div id="room-root" class="presenter-room">
    <div class="room-top px-3 py-2 flex items-center justify-between">
        <div class="room-title text-xs font-black uppercase tracking-widest">Live Presenter</div>
        <div class="flex items-center gap-2">
            <span id="conn-badge" class="px-2 py-1 rounded bg-amber-500/15 text-amber-300 text-[10px] font-black uppercase tracking-wider">Connecting</span>
            <form method="post" action="{% url 'Prolean:external_live_leave' session_id %}">
                {% csrf_token %}
                <button type="submit" class="px-3 py-1.5 rounded bg-red-600 hover:bg-red-700 text-white text-[11px] font-black uppercase tracking-wider">Leave</button>
            </form>
        </div>
    </div>

    <div id="conn-error" class="hidden mx-3 mt-2 px-3 py-2 rounded border border-red-500/40 bg-red-500/10 text-red-300 text-xs font-semibold"></div>

    <div class="room-shell">
        <section id="left-pane" class="pane pane-main">
            <div class="pane-title">Professor Camera</div>
            <div id="left-host" class="video-host"></div>
        </section>

        <div id="pane-resizer" class="pane-resizer" title="Drag to resize screens"></div>

        <section id="right-pane" class="pane pane-side" title="Tap to switch right screen mode">
            <div id="right-title" class="pane-title">Professor Screen Share + Your Camera</div>
            <div id="right-host" class="video-host"></div>
        </section>
    </div>

    <div class="controls-bar">
        <button id="toggle-audio" class="ctrl-btn" data-state="on" title="Microphone"><span class="material-symbols-outlined">mic</span></button>
        <button id="toggle-video" class="ctrl-btn" data-state="on" title="Camera"><span class="material-symbols-outlined">videocam</span></button>
        <button id="toggle-screen" class="ctrl-btn" title="Screen Share"><span class="material-symbols-outlined">present_to_all</span></button>
        <button id="raise-hand" class="ctrl-btn" title="Raise Hand"><span class="material-symbols-outlined">front_hand</span></button>
        <button id="enable-sound" class="ctrl-btn" title="Enable Sound"><span class="material-symbols-outlined">volume_up</span></button>
        <button id="toggle-fullscreen" class="ctrl-btn" title="Fullscreen"><span class="material-symbols-outlined">fullscreen</span></button>
        <button id="cycle-right-mode" class="ctrl-btn" title="Switch Right Screen"><span class="material-symbols-outlined">swap_horiz</span></button>
        <button id="mode-screen" class="mode-btn" title="Screen only">Screen</button>
        <button id="mode-split" class="mode-btn active" title="Screen + Students">Split</button>
        <button id="mode-students" class="mode-btn" title="Students grid">Students</button>
        <button id="toggle-layout-panel" class="mode-btn" title="Customize layout">Layout</button>
        <div id="layout-panel" class="layout-panel">
            <label class="layout-item">
                <input id="swap-panes" type="checkbox" />
                <span>Swap</span>
            </label>
            <label class="layout-item">
                <span>Right</span>
                <input id="right-width" type="range" min="24" max="45" value="28" />
                <span id="right-width-value" class="value">28%</span>
            </label>
            <label class="layout-item">
                <span>Cols</span>
                <input id="grid-cols" type="range" min="1" max="4" value="2" />
                <span id="grid-cols-value" class="value">2</span>
            </label>
            <label class="layout-item">
                <span>Tile</span>
                <input id="tile-size" type="range" min="100" max="220" value="120" />
                <span id="tile-size-value" class="value">120</span>
            </label>
            <button id="reset-layout" class="mode-btn" type="button">Reset</button>
        </div>
        <div id="audio-sink" class="hidden"></div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/livekit-client/dist/livekit-client.umd.min.js"></script>
<script>
(() => {
  const rawLivekitUrl = "{{ livekit_url|escapejs }}";
  const livekitToken = "{{ livekit_token|escapejs }}";
  const liveRole = String("{{ live_role|escapejs }}").toLowerCase();
  const isProfessor = liveRole === "professor";
  const selfName = "{{ user.get_full_name|default:user.username|escapejs }}";
  const professorIdentityHint = "{{ professor_identity_hint|default:''|escapejs }}";
  const professorNameHint = "{{ professor_name_hint|default:''|escapejs }}";

  const roomRoot = document.getElementById("room-root");
  const leftPane = document.getElementById("left-pane");
  const paneResizer = document.getElementById("pane-resizer");
  const rightPane = document.getElementById("right-pane");
  const leftHost = document.getElementById("left-host");
  const rightHost = document.getElementById("right-host");
  const rightTitle = document.getElementById("right-title");
  const connBadge = document.getElementById("conn-badge");
  const connError = document.getElementById("conn-error");
  const audioSink = document.getElementById("audio-sink");

  const btnAudio = document.getElementById("toggle-audio");
  const btnVideo = document.getElementById("toggle-video");
  const btnScreen = document.getElementById("toggle-screen");
  const btnRaiseHand = document.getElementById("raise-hand");
  const btnSound = document.getElementById("enable-sound");
  const btnFullscreen = document.getElementById("toggle-fullscreen");
  const btnCycleMode = document.getElementById("cycle-right-mode");
  const btnModeScreen = document.getElementById("mode-screen");
  const btnModeSplit = document.getElementById("mode-split");
  const btnModeStudents = document.getElementById("mode-students");
  const btnToggleLayoutPanel = document.getElementById("toggle-layout-panel");
  const layoutPanel = document.getElementById("layout-panel");
  const swapPanesInput = document.getElementById("swap-panes");
  const rightWidthInput = document.getElementById("right-width");
  const gridColsInput = document.getElementById("grid-cols");
  const tileSizeInput = document.getElementById("tile-size");
  const rightWidthValue = document.getElementById("right-width-value");
  const gridColsValue = document.getElementById("grid-cols-value");
  const tileSizeValue = document.getElementById("tile-size-value");
  const btnResetLayout = document.getElementById("reset-layout");
  let isResizing = false;
  let themeObserver = null;

  const participantLabels = new Map();
  const participantRoles = new Map();
  const videoTracks = new Map(); // sid -> {track, identity, source, isLocal}
  const audioEls = new Map(); // identity -> audioEl
  const raisedHands = new Set();
  const speakingIds = new Set();

  let professorIdentity = null;
  const joinOrder = new Map();
  let joinCounter = 0;
  let rightMode = 1; // 0 screen share only, 1 split (screen+self), 2 students grid
  const layoutStorageKey = "prolean_live_layout_v1";
  const defaultLayoutPrefs = {
    swapped: false,
    rightWidth: 28,
    gridCols: 2,
    tileMinHeight: 120,
  };
  let layoutPrefs = { ...defaultLayoutPrefs };

  const normalizeLivekitUrl = (value) => {
    const cleaned = String(value || "").trim().replace(/^['"]|['"]$/g, "");
    if (!cleaned) return "";
    if (/^wss?:\/\//i.test(cleaned)) return cleaned;
    return `wss://${cleaned}`;
  };

  const normalizeSource = (source) => {
    const text = String(source || "").toLowerCase();
    if (!text || text === "unknown") return "camera";
    return text;
  };

  const isScreenShare = (source) => normalizeSource(source).startsWith("screen_share");

  const initials = (label) => (String(label || "U").trim()[0] || "U").toUpperCase();

  const setStatus = (txt, kind = "warn") => {
    const style = {
      ok: "bg-green-500/15 text-green-300",
      warn: "bg-amber-500/15 text-amber-300",
      err: "bg-red-500/15 text-red-300",
    }[kind] || "bg-amber-500/15 text-amber-300";
    connBadge.className = `px-2 py-1 rounded text-[10px] font-black uppercase tracking-wider ${style}`;
    connBadge.textContent = txt;
  };

  const showError = (message) => {
    connError.textContent = message;
    connError.classList.remove("hidden");
  };

  const detectUiTheme = () => {
    const body = document.body;
    const root = document.documentElement;
    const bodyTheme = String(body?.dataset?.theme || body?.getAttribute("data-bs-theme") || "").toLowerCase();
    const rootTheme = String(root?.dataset?.theme || root?.getAttribute("data-bs-theme") || "").toLowerCase();
    const classDark = body?.classList?.contains("dark") || root?.classList?.contains("dark");
    if (bodyTheme === "light" || rootTheme === "light") return "light";
    if (bodyTheme === "dark" || rootTheme === "dark" || classDark) return "dark";
    return window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light";
  };

  const applyUiTheme = () => {
    roomRoot.dataset.uiTheme = detectUiTheme();
  };

  const bindThemeSync = () => {
    applyUiTheme();
    const media = window.matchMedia("(prefers-color-scheme: dark)");
    if (typeof media.addEventListener === "function") {
      media.addEventListener("change", applyUiTheme);
    } else if (typeof media.addListener === "function") {
      media.addListener(applyUiTheme);
    }
    themeObserver = new MutationObserver(applyUiTheme);
    if (document.body) {
      themeObserver.observe(document.body, { attributes: true, attributeFilter: ["class", "data-theme", "data-bs-theme"] });
    }
    themeObserver.observe(document.documentElement, { attributes: true, attributeFilter: ["class", "data-theme", "data-bs-theme"] });
  };

  const applyLayoutPrefs = () => {
    roomRoot.classList.toggle("swapped", !!layoutPrefs.swapped);
    roomRoot.style.setProperty("--right-pane-width", `${layoutPrefs.rightWidth}%`);
    roomRoot.style.setProperty("--student-grid-cols", String(layoutPrefs.gridCols));
    roomRoot.style.setProperty("--student-tile-min-h", `${layoutPrefs.tileMinHeight}px`);
    rightWidthValue.textContent = `${layoutPrefs.rightWidth}%`;
    gridColsValue.textContent = String(layoutPrefs.gridCols);
    tileSizeValue.textContent = String(layoutPrefs.tileMinHeight);
    swapPanesInput.checked = !!layoutPrefs.swapped;
    rightWidthInput.value = String(layoutPrefs.rightWidth);
    gridColsInput.value = String(layoutPrefs.gridCols);
    tileSizeInput.value = String(layoutPrefs.tileMinHeight);
  };

  const persistLayoutPrefs = () => {
    try {
      localStorage.setItem(layoutStorageKey, JSON.stringify(layoutPrefs));
    } catch (_) {}
  };

  const loadLayoutPrefs = () => {
    try {
      const raw = localStorage.getItem(layoutStorageKey);
      if (!raw) return;
      const parsed = JSON.parse(raw);
      layoutPrefs = {
        swapped: !!parsed.swapped,
        rightWidth: Math.min(45, Math.max(24, Number(parsed.rightWidth || 28))),
        gridCols: Math.min(4, Math.max(1, Number(parsed.gridCols || 2))),
        tileMinHeight: Math.min(220, Math.max(100, Number(parsed.tileMinHeight || 120))),
      };
    } catch (_) {}
  };

  const markPaneBorders = () => {
    leftPane.classList.remove("speaker-border", "raised-border");
    rightPane.classList.remove("speaker-border", "raised-border");

    if (professorIdentity && speakingIds.has(professorIdentity)) leftPane.classList.add("speaker-border");
    if (professorIdentity && raisedHands.has(professorIdentity)) leftPane.classList.add("raised-border");

    const rightStudentIds = Array.from(participantLabels.keys()).filter((id) => !isProfessorLike(id));
    const rightHasSpeaker = rightStudentIds.some((id) => speakingIds.has(id));
    const rightHasRaised = rightStudentIds.some((id) => raisedHands.has(id));
    if (rightHasSpeaker) rightPane.classList.add("speaker-border");
    if (rightHasRaised) rightPane.classList.add("raised-border");
  };

  const getIdentityRole = (participant) => {
    if (!participant) return null;
    try {
      if (participant.metadata) {
        const meta = JSON.parse(participant.metadata);
        const roleKeys = ["role", "user_role", "participant_role", "type"];
        for (const key of roleKeys) {
          if (meta && typeof meta[key] === "string") {
            const value = String(meta[key]).toLowerCase();
            if (value.includes("prof") || value.includes("teacher") || value.includes("instructor")) return "professor";
          }
        }
      }
    } catch (_) {}
    const identity = String(participant.identity || "").toLowerCase();
    if (identity.includes("prof")) return "professor";
    if (identity.includes("teacher")) return "professor";
    return null;
  };

  const sameText = (a, b) => String(a || "").trim().toLowerCase() === String(b || "").trim().toLowerCase();

  const resolveProfessorFromHints = () => {
    if (professorIdentityHint) {
      for (const id of participantLabels.keys()) {
        if (sameText(id, professorIdentityHint)) return id;
      }
    }
    if (professorNameHint) {
      for (const [id, name] of participantLabels.entries()) {
        if (sameText(name, professorNameHint)) return id;
      }
    }
    return null;
  };

  const resolveProfessorIdentity = () => {
    if (isProfessor && room.localParticipant) return room.localParticipant.identity;

    const hinted = resolveProfessorFromHints();
    if (hinted) return hinted;

    if (professorIdentity) {
      const stillPresent = participantLabels.has(professorIdentity);
      if (stillPresent) return professorIdentity;
    }

    for (const [id, role] of participantRoles.entries()) {
      if (role === "professor") return id;
    }

    for (const [id, name] of participantLabels.entries()) {
      const idText = String(id || "").toLowerCase();
      const nameText = String(name || "").toLowerCase();
      if (idText.includes("prof") || idText.includes("teacher") || idText.includes("instructor")) return id;
      if (nameText.includes("prof") || nameText.includes("teacher") || nameText.includes("instructor")) return id;
    }

    const screenOwners = new Set(
      Array.from(videoTracks.values())
        .filter((v) => !v.isLocal && isScreenShare(v.source))
        .map((v) => v.identity)
    );
    for (const id of screenOwners) {
      if (pickTrack(id, false)) return id;
    }

    const cameraOwners = Array.from(new Set(
      Array.from(videoTracks.values())
        .filter((v) => !v.isLocal && !isScreenShare(v.source))
        .map((v) => v.identity)
    ));
    cameraOwners.sort((a, b) => (joinOrder.get(a) || 999999) - (joinOrder.get(b) || 999999));
    if (cameraOwners.length) return cameraOwners[0];

    for (const { identity, source, isLocal } of videoTracks.values()) {
      if (!isLocal && !isScreenShare(source)) return identity;
    }
    return professorIdentity;
  };

  const isProfessorLike = (identity) => {
    if (!identity) return false;
    if (identity === professorIdentity) return true;
    const role = participantRoles.get(identity);
    if (role === "professor") return true;
    const idText = String(identity).toLowerCase();
    if (idText.includes("prof") || idText.includes("teacher")) return true;
    const hasScreen = Array.from(videoTracks.values()).some((v) => v.identity === identity && isScreenShare(v.source));
    return hasScreen;
  };

  const tracksByIdentity = (identity, wantScreen = false) =>
    Array.from(videoTracks.values()).filter((v) => v.identity === identity && (wantScreen ? isScreenShare(v.source) : !isScreenShare(v.source)));

  const pickTrack = (identity, wantScreen = false) => {
    const arr = tracksByIdentity(identity, wantScreen);
    return arr.length ? arr[arr.length - 1] : null;
  };

  const renderAvatar = (host, label) => {
    host.innerHTML = "";
    const wrap = document.createElement("div");
    wrap.className = "avatar-host";
    const badge = document.createElement("div");
    badge.className = "avatar-badge";
    badge.textContent = initials(label);
    wrap.appendChild(badge);
    const footer = document.createElement("div");
    footer.className = "student-label";
    footer.textContent = label;
    wrap.appendChild(footer);
    host.appendChild(wrap);
  };

  const renderTrack = (host, data, label) => {
    host.innerHTML = "";
    const media = data.track.attach();
    media.autoplay = true;
    media.playsInline = true;
    media.muted = !!data.isLocal;
    media.setAttribute("playsinline", "true");
    const footer = document.createElement("div");
    footer.className = "student-label";
    footer.textContent = label;
    host.appendChild(media);
    host.appendChild(footer);
  };

  const renderLeftPane = () => {
    professorIdentity = resolveProfessorIdentity();
    const label = participantLabels.get(professorIdentity) || "Professor";
    const profCam = professorIdentity ? pickTrack(professorIdentity, false) : null;
    if (profCam) renderTrack(leftHost, profCam, label);
    else renderAvatar(leftHost, label);
  };

  const getStudentEntries = () => {
    const entries = [];
    for (const [id, name] of participantLabels.entries()) {
      if (isProfessorLike(id)) continue;
      entries.push({ id, name });
    }
    return entries;
  };

  const renderStudentsInto = (host, compact = false) => {
    host.innerHTML = "";
    const students = getStudentEntries();
    if (!students.length) {
      const empty = document.createElement("div");
      empty.className = "empty-students";
      empty.textContent = "Waiting for students to join live";
      host.appendChild(empty);
      return;
    }

    const grid = document.createElement("div");
    grid.className = "student-grid";
    if (compact) grid.classList.add("compact");

    for (const student of students) {
      const card = document.createElement("div");
      card.className = "student-card";
      if (raisedHands.has(student.id)) card.classList.add("raised-border");
      else if (speakingIds.has(student.id)) card.classList.add("speaker-border");

      const cam = pickTrack(student.id, false);
      if (cam) {
        const media = cam.track.attach();
        media.autoplay = true;
        media.playsInline = true;
        media.muted = cam.isLocal;
        media.setAttribute("playsinline", "true");
        card.appendChild(media);
      } else {
        const av = document.createElement("div");
        av.className = "avatar-host";
        const badge = document.createElement("div");
        badge.className = "avatar-badge";
        badge.textContent = initials(student.name);
        av.appendChild(badge);
        card.appendChild(av);
      }
      const footer = document.createElement("div");
      footer.className = "student-label";
      footer.textContent = student.name;
      card.appendChild(footer);
      grid.appendChild(card);
    }
    host.appendChild(grid);
  };

  const renderRightPane = () => {
    if (rightMode === 0) {
      rightTitle.textContent = "Professor Screen Share (Tap to Switch)";
      const screen = professorIdentity ? pickTrack(professorIdentity, true) : null;
      if (screen) renderTrack(rightHost, screen, "Screen Share");
      else renderAvatar(rightHost, "No Screen Share");
    } else if (rightMode === 1) {
      rightTitle.textContent = "Professor Screen Share + Students (Tap to Switch)";
      rightHost.innerHTML = "";
      const split = document.createElement("div");
      split.className = "right-split";

      const top = document.createElement("div");
      top.className = "right-split-top";
      const bottom = document.createElement("div");
      bottom.className = "right-split-bottom";

      const screen = professorIdentity ? pickTrack(professorIdentity, true) : null;
      if (screen) renderTrack(top, screen, "The prof screen sharing");
      else renderAvatar(top, "No Screen Share");
      renderStudentsInto(bottom, true);

      split.appendChild(top);
      split.appendChild(bottom);
      rightHost.appendChild(split);
    } else {
      rightTitle.textContent = "Students Grid (Tap to Switch)";
      renderStudentsInto(rightHost, false);
    }
    syncModeButtons();
    markPaneBorders();
  };

  const rerender = () => {
    renderLeftPane();
    renderRightPane();
  };

  const syncModeButtons = () => {
    btnModeScreen.classList.toggle("active", rightMode === 0);
    btnModeSplit.classList.toggle("active", rightMode === 1);
    btnModeStudents.classList.toggle("active", rightMode === 2);
  };

  const room = new LivekitClient.Room({
    adaptiveStream: true,
    dynacast: true,
    stopLocalTrackOnUnpublish: true,
  });

  const syncControlStates = () => {
    const micOn = !!room.localParticipant?.isMicrophoneEnabled;
    const camOn = !!room.localParticipant?.isCameraEnabled;
    btnAudio.dataset.state = micOn ? "on" : "off";
    btnVideo.dataset.state = camOn ? "on" : "off";
    btnAudio.innerHTML = `<span class="material-symbols-outlined">${micOn ? "mic" : "mic_off"}</span>`;
    btnVideo.innerHTML = `<span class="material-symbols-outlined">${camOn ? "videocam" : "videocam_off"}</span>`;
  };

  const upsertParticipant = (participant) => {
    if (!participant) return;
    participantLabels.set(participant.identity, participant.name || participant.identity);
    if (!joinOrder.has(participant.identity)) joinOrder.set(participant.identity, ++joinCounter);
    const role = getIdentityRole(participant);
    if (role) participantRoles.set(participant.identity, role);
  };

  const addVideoTrack = (track, participant, source) => {
    upsertParticipant(participant);
    const sid = track.sid || `${participant.identity}:${source}`;
    videoTracks.set(sid, {
      track,
      identity: participant.identity,
      source: normalizeSource(source),
      isLocal: room.localParticipant && participant.identity === room.localParticipant.identity,
    });
    rerender();
  };

  const removeTrack = (track) => {
    for (const [sid, info] of videoTracks.entries()) {
      if (track.sid && info.track.sid === track.sid) videoTracks.delete(sid);
    }
    for (const [id, el] of audioEls.entries()) {
      if (el.dataset.trackSid === (track.sid || "")) {
        el.remove();
        audioEls.delete(id);
      }
    }
    track.detach().forEach((el) => el.remove());
    rerender();
  };

  const addAudioTrack = (track, participant, source) => {
    if (!participant || (room.localParticipant && participant.identity === room.localParticipant.identity)) return;
    if (isScreenShare(source)) return;
    upsertParticipant(participant);
    const identity = participant.identity;
    if (audioEls.has(identity)) {
      audioEls.get(identity).remove();
      audioEls.delete(identity);
    }
    const audioEl = track.attach();
    audioEl.autoplay = true;
    audioEl.playsInline = true;
    audioEl.muted = false;
    audioEl.dataset.trackSid = track.sid || "";
    audioSink.appendChild(audioEl);
    audioEls.set(identity, audioEl);
    const p = audioEl.play();
    if (p && typeof p.catch === "function") p.catch(() => setStatus("Tap Sound", "warn"));
  };

  const livekitUrl = normalizeLivekitUrl(rawLivekitUrl);
  if (!livekitUrl || !livekitToken) {
    setStatus("Config Error", "err");
    showError("Missing live config.");
    return;
  }

  try { new URL(livekitUrl); }
  catch {
    setStatus("Invalid URL", "err");
    showError(`Invalid LiveKit URL: ${livekitUrl}`);
    return;
  }

  room
    .on(LivekitClient.RoomEvent.TrackSubscribed, (track, pub, participant) => {
      if (track.kind === "video") addVideoTrack(track, participant, pub?.source || "camera");
      if (track.kind === "audio") addAudioTrack(track, participant, pub?.source || "microphone");
    })
    .on(LivekitClient.RoomEvent.TrackUnsubscribed, (track) => {
      removeTrack(track);
    })
    .on(LivekitClient.RoomEvent.LocalTrackPublished, (pub) => {
      if (pub?.track?.kind === "video") {
        addVideoTrack(pub.track, room.localParticipant, pub?.source || "camera");
      }
    })
    .on(LivekitClient.RoomEvent.LocalTrackUnpublished, (pub) => {
      if (pub?.track) removeTrack(pub.track);
    })
    .on(LivekitClient.RoomEvent.ParticipantConnected, (p) => {
      upsertParticipant(p);
      rerender();
    })
    .on(LivekitClient.RoomEvent.ParticipantDisconnected, (p) => {
      if (!p) return;
      for (const [sid, info] of videoTracks.entries()) {
        if (info.identity === p.identity) videoTracks.delete(sid);
      }
      if (audioEls.has(p.identity)) {
        audioEls.get(p.identity).remove();
        audioEls.delete(p.identity);
      }
      participantLabels.delete(p.identity);
      participantRoles.delete(p.identity);
      raisedHands.delete(p.identity);
      speakingIds.delete(p.identity);
      rerender();
    })
    .on(LivekitClient.RoomEvent.ActiveSpeakersChanged, () => {
      speakingIds.clear();
      (room.activeSpeakers || []).forEach((p) => speakingIds.add(p.identity));
      markPaneBorders();
      if (rightMode === 2) renderRightPane();
    })
    .on(LivekitClient.RoomEvent.DataReceived, (payload, participant) => {
      try {
        const msg = JSON.parse(new TextDecoder().decode(payload));
        if (!msg || !msg.type) return;
        const id = participant?.identity || "";
        if (msg.type === "raise_hand" && id) raisedHands.add(id);
        if (msg.type === "hand_lowered" && id) raisedHands.delete(id);
        markPaneBorders();
        if (rightMode === 2) renderRightPane();
      } catch (_) {}
    })
    .on(LivekitClient.RoomEvent.Disconnected, () => setStatus("Disconnected", "err"));

  setStatus("Connecting", "warn");
  room.connect(livekitUrl, livekitToken)
    .then(async () => {
      setStatus("Connected", "ok");
      upsertParticipant(room.localParticipant);
      if (isProfessor) participantRoles.set(room.localParticipant.identity, "professor");

      room.remoteParticipants.forEach((p) => {
        upsertParticipant(p);
        p.trackPublications.forEach((pub) => {
          if (!pub.track) return;
          if (pub.track.kind === "video") addVideoTrack(pub.track, p, pub.source || "camera");
          if (pub.track.kind === "audio") addAudioTrack(pub.track, p, pub.source || "microphone");
        });
      });

      try { await room.localParticipant.setMicrophoneEnabled(true); } catch (e) { showError(`Mic permission: ${e.message || e}`); }
      try { await room.localParticipant.setCameraEnabled(true); } catch (e) { showError(`Camera permission: ${e.message || e}`); }
      syncControlStates();
      rerender();

      if (!isProfessor) {
        btnScreen.disabled = true;
        btnScreen.classList.add("opacity-50", "cursor-not-allowed");
      } else {
        btnToggleLayoutPanel.classList.add("hidden");
      }
    })
    .catch((err) => {
      setStatus("Connection Failed", "err");
      showError(`LiveKit connection failed: ${err?.message || err}`);
    });

  rightPane.addEventListener("click", () => {
    rightMode = (rightMode + 1) % 3;
    renderRightPane();
  });

  btnCycleMode.addEventListener("click", () => {
    rightMode = (rightMode + 1) % 3;
    renderRightPane();
  });

  btnModeScreen.addEventListener("click", () => {
    rightMode = 0;
    renderRightPane();
  });

  btnModeSplit.addEventListener("click", () => {
    rightMode = 1;
    renderRightPane();
  });

  btnModeStudents.addEventListener("click", () => {
    rightMode = 2;
    renderRightPane();
  });

  btnToggleLayoutPanel.addEventListener("click", () => {
    layoutPanel.classList.toggle("open");
    btnToggleLayoutPanel.classList.toggle("active", layoutPanel.classList.contains("open"));
  });

  swapPanesInput.addEventListener("change", () => {
    layoutPrefs.swapped = swapPanesInput.checked;
    applyLayoutPrefs();
    persistLayoutPrefs();
  });

  rightWidthInput.addEventListener("input", () => {
    layoutPrefs.rightWidth = Number(rightWidthInput.value);
    applyLayoutPrefs();
  });
  rightWidthInput.addEventListener("change", persistLayoutPrefs);

  gridColsInput.addEventListener("input", () => {
    layoutPrefs.gridCols = Number(gridColsInput.value);
    applyLayoutPrefs();
    renderRightPane();
  });
  gridColsInput.addEventListener("change", persistLayoutPrefs);

  tileSizeInput.addEventListener("input", () => {
    layoutPrefs.tileMinHeight = Number(tileSizeInput.value);
    applyLayoutPrefs();
  });
  tileSizeInput.addEventListener("change", persistLayoutPrefs);

  btnResetLayout.addEventListener("click", () => {
    layoutPrefs = { ...defaultLayoutPrefs };
    applyLayoutPrefs();
    persistLayoutPrefs();
    renderRightPane();
  });

  const clampRightPaneWidth = (next) => Math.min(45, Math.max(24, Number(next || 28)));

  const setRightPaneWidthFromPointer = (clientX) => {
    if (window.matchMedia("(max-width: 1100px)").matches) return;
    const shellRect = roomRoot.querySelector(".room-shell").getBoundingClientRect();
    if (!shellRect.width) return;
    const relativeX = clientX - shellRect.left;
    const rightPercent = ((shellRect.width - relativeX) / shellRect.width) * 100;
    layoutPrefs.rightWidth = clampRightPaneWidth(rightPercent);
    applyLayoutPrefs();
  };

  paneResizer.addEventListener("pointerdown", (event) => {
    if (window.matchMedia("(max-width: 1100px)").matches) return;
    isResizing = true;
    paneResizer.classList.add("dragging");
    paneResizer.setPointerCapture(event.pointerId);
    event.preventDefault();
  });

  paneResizer.addEventListener("pointermove", (event) => {
    if (!isResizing) return;
    setRightPaneWidthFromPointer(event.clientX);
  });

  const stopResizing = () => {
    if (!isResizing) return;
    isResizing = false;
    paneResizer.classList.remove("dragging");
    persistLayoutPrefs();
  };

  paneResizer.addEventListener("pointerup", stopResizing);
  paneResizer.addEventListener("pointercancel", stopResizing);

  btnAudio.addEventListener("click", async () => {
    try {
      const on = room.localParticipant.isMicrophoneEnabled;
      await room.localParticipant.setMicrophoneEnabled(!on);
      syncControlStates();
    } catch (e) { showError(`Mic toggle failed: ${e.message || e}`); }
  });

  btnVideo.addEventListener("click", async () => {
    try {
      const on = room.localParticipant.isCameraEnabled;
      await room.localParticipant.setCameraEnabled(!on);
      syncControlStates();
    } catch (e) { showError(`Camera toggle failed: ${e.message || e}`); }
  });

  btnScreen.addEventListener("click", async () => {
    if (!isProfessor) return;
    try {
      const on = !!room.localParticipant.isScreenShareEnabled;
      await room.localParticipant.setScreenShareEnabled(!on);
      if (!on && !room.localParticipant.isCameraEnabled) {
        await room.localParticipant.setCameraEnabled(true);
      }
      btnScreen.innerHTML = `<span class="material-symbols-outlined">${on ? "present_to_all" : "stop_screen_share"}</span>`;
      syncControlStates();
    } catch (e) { showError(`Screen share failed: ${e.message || e}`); }
  });

  btnRaiseHand.addEventListener("click", async () => {
    try {
      const payload = JSON.stringify({ type: "raise_hand", name: selfName, ts: Date.now() });
      await room.localParticipant.publishData(new TextEncoder().encode(payload), { reliable: true });
      btnRaiseHand.innerHTML = '<span class="material-symbols-outlined">waving_hand</span>';
      setTimeout(() => { btnRaiseHand.innerHTML = '<span class="material-symbols-outlined">front_hand</span>'; }, 1800);
    } catch (e) { showError(`Raise hand failed: ${e.message || e}`); }
  });

  btnSound.addEventListener("click", async () => {
    for (const audio of audioSink.querySelectorAll("audio")) {
      try {
        audio.muted = false;
        audio.volume = 1;
        await audio.play();
      } catch (_) {}
    }
    setStatus("Connected", "ok");
  });

  btnFullscreen.addEventListener("click", async () => {
    if (!document.fullscreenElement) {
      roomRoot.classList.add("room-fullscreen");
      await roomRoot.requestFullscreen().catch(() => {});
      btnFullscreen.innerHTML = '<span class="material-symbols-outlined">fullscreen_exit</span>';
    } else {
      await document.exitFullscreen().catch(() => {});
      roomRoot.classList.remove("room-fullscreen");
      btnFullscreen.innerHTML = '<span class="material-symbols-outlined">fullscreen</span>';
    }
  });

  document.addEventListener("fullscreenchange", () => {
    if (!document.fullscreenElement) {
      roomRoot.classList.remove("room-fullscreen");
      btnFullscreen.innerHTML = '<span class="material-symbols-outlined">fullscreen</span>';
    }
  });

  window.addEventListener("beforeunload", () => {
    if (themeObserver) themeObserver.disconnect();
    room.disconnect();
  });

  bindThemeSync();
  loadLayoutPrefs();
  applyLayoutPrefs();
})();
</script>
{% endblock %}
