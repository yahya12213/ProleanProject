{% extends 'Prolean/base.html' %}
{% load static %}

{% block title %}Live Presenter Room{% endblock %}
{% block main_class %}w-full max-w-none{% endblock %}
{% block extra_css %}
<style>
    html, body {
        height: 100%;
        max-height: 100%;
        overflow: hidden;
    }

    #contact, .floating-buttons { display: none !important; }
    body > header, body > footer { display: none !important; }

    .presenter-room {
        --bg-main: linear-gradient(180deg, #14171c 0%, #101318 100%);
        --text-main: #e5e7eb;
        --panel-bg: #11141a;
        --top-bg: #15181d;
        --panel-border: rgba(148, 163, 184, 0.24);
        --top-border: rgba(148, 163, 184, 0.2);
        --media-bg: #090b0f;
        --label-bg: rgba(0, 0, 0, 0.65);
        --muted-text: #cbd5e1;
        --layout-bg: #1b212b;
        --ctrl-bg: #222a35;
        --mode-bg: #202733;
        --resizer-bg: linear-gradient(180deg, rgba(148, 163, 184, 0.18), rgba(148, 163, 184, 0.08));
        --resizer-border: rgba(148, 163, 184, 0.25);
        --empty-text: #9ca3af;
        height: 100vh;
        max-height: 100vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        background: var(--bg-main);
        color: var(--text-main);
        font-family: "Plus Jakarta Sans", sans-serif;
    }

    .presenter-room[data-ui-theme="light"] {
        --bg-main: linear-gradient(180deg, #f8fafc 0%, #eef2f7 100%);
        --text-main: #0f172a;
        --panel-bg: #ffffff;
        --top-bg: #f8fafc;
        --panel-border: rgba(15, 23, 42, 0.12);
        --top-border: rgba(15, 23, 42, 0.12);
        --media-bg: #e5e7eb;
        --label-bg: rgba(15, 23, 42, 0.75);
        --muted-text: #334155;
        --layout-bg: #f1f5f9;
        --ctrl-bg: #e2e8f0;
        --mode-bg: #e2e8f0;
        --resizer-bg: linear-gradient(180deg, rgba(15, 23, 42, 0.14), rgba(15, 23, 42, 0.06));
        --resizer-border: rgba(15, 23, 42, 0.18);
        --empty-text: #475569;
    }

    .room-top {
        border-bottom: 1px solid var(--top-border);
        background: var(--top-bg);
        flex: 0 0 auto;
    }

    .room-title {
        color: var(--muted-text);
    }

    .room-shell {
        display: grid;
        grid-template-columns: minmax(0, 1fr) 10px minmax(320px, var(--right-pane-width, 28%));
        grid-template-areas: "left resize right";
        gap: 14px;
        flex: 1 1 auto;
        min-height: 0;
        padding: 12px;
        overflow: hidden;
    }

    @media (max-width: 1100px) {
        .room-shell {
            grid-template-columns: 1fr;
            grid-template-areas: "left" "right";
            grid-template-rows: minmax(0, 1fr) minmax(0, 1fr);
        }

        .pane-resizer {
            display: none;
        }

        .pane-main, .pane-side {
            min-height: 0;
        }
    }

    .pane {
        border: 1px solid var(--panel-border);
        background: var(--panel-bg);
        border-radius: 12px;
        overflow: hidden;
        position: relative;
        display: flex;
        flex-direction: column;
    }

    .pane-main {
        min-height: 62vh;
        grid-area: left;
    }

    .pane-side {
        min-height: 62vh;
        cursor: pointer;
        min-width: 0;
        grid-area: right;
    }

    .right-split {
        height: 100%;
        display: grid;
        grid-template-rows: 1fr 1fr;
        min-height: 0;
    }

    .right-split-top, .right-split-bottom {
        position: relative;
        min-height: 0;
        background: var(--media-bg);
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }

    .right-split-bottom {
        border-top: 2px solid #f97316;
    }

    .pane-title {
        position: absolute;
        top: 8px;
        left: 8px;
        z-index: 5;
        background: var(--label-bg);
        border: 1px solid var(--panel-border);
        border-radius: 8px;
        padding: 4px 8px;
        font-size: 11px;
        font-weight: 800;
        letter-spacing: 0.06em;
        text-transform: uppercase;
    }

    .speaker-border {
        box-shadow: inset 0 0 0 2px #22c55e;
    }

    .raised-border {
        box-shadow: inset 0 0 0 2px #ef4444;
    }

    .video-host {
        width: 100%;
        height: 100%;
        background: var(--media-bg);
        flex: 1;
        min-height: 0;
    }

    .video-host video {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .avatar-host {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: radial-gradient(circle at 20% 20%, #1f2937 0%, #0b0d11 100%);
    }

    .avatar-badge {
        width: 96px;
        height: 96px;
        border-radius: 999px;
        background: #f97316;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #fff;
        font-size: 38px;
        font-weight: 900;
    }

    .student-grid {
        display: grid;
        grid-template-columns: repeat(var(--student-grid-cols, 2), minmax(0, 1fr));
        gap: 8px;
        padding: 40px 8px 8px;
        height: 100%;
        min-height: 0;
        overflow: auto;
    }

    .student-grid.compact {
        grid-template-columns: repeat(1, minmax(0, 1fr));
        grid-auto-rows: minmax(0, 1fr);
    }

    .student-grid.compact .student-card {
        min-height: 0;
    }

    .student-card {
        min-height: var(--student-tile-min-h, 120px);
        border: 1px solid var(--panel-border);
        border-radius: 10px;
        overflow: hidden;
        position: relative;
        background: var(--media-bg);
    }

    .student-card video {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .student-label {
        position: absolute;
        left: 6px;
        bottom: 6px;
        z-index: 4;
        padding: 3px 7px;
        border-radius: 7px;
        background: var(--label-bg);
        color: #fff;
        font-size: 11px;
        font-weight: 700;
    }

    .controls-bar {
        border-top: 1px solid var(--top-border);
        background: var(--top-bg);
        padding: 10px 12px;
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
        flex: 0 0 auto;
    }

    .ctrl-btn {
        width: 42px;
        height: 42px;
        border-radius: 10px;
        border: 1px solid var(--panel-border);
        background: var(--ctrl-bg);
        color: var(--text-main);
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }

    .ctrl-btn[data-state="off"] {
        background: rgba(239, 68, 68, 0.18);
        border-color: rgba(239, 68, 68, 0.45);
        color: #fca5a5;
    }

    .mode-btn {
        height: 32px;
        padding: 0 10px;
        border-radius: 8px;
        border: 1px solid var(--panel-border);
        background: var(--mode-bg);
        color: var(--muted-text);
        font-size: 11px;
        font-weight: 800;
        text-transform: uppercase;
        letter-spacing: 0.06em;
    }

    .mode-btn.active {
        background: #f97316;
        border-color: #fb923c;
        color: #111827;
    }

    .layout-panel {
        margin-left: auto;
        display: none;
        align-items: center;
        gap: 8px;
        background: var(--layout-bg);
        border: 1px solid var(--panel-border);
        border-radius: 10px;
        padding: 8px;
    }

    .layout-panel.open {
        display: flex;
        flex-wrap: wrap;
    }

    .layout-item {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        color: var(--muted-text);
        font-size: 11px;
        font-weight: 700;
    }

    .layout-item input[type="range"] {
        width: 88px;
    }

    .layout-item .value {
        min-width: 26px;
        text-align: right;
        color: #f8fafc;
    }

    .room-fullscreen .room-top {
        display: none;
    }

    @media (max-width: 1100px) {
        html, body {
            overflow-y: auto;
        }

        .presenter-room {
            height: 100dvh;
            max-height: 100dvh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .room-shell {
            min-height: 0;
        }
    }

    @media (max-width: 900px) {

        .room-shell {
            padding: 8px;
            gap: 8px;
            grid-template-rows: minmax(260px, 58dvh) minmax(180px, 34dvh);
            overflow-y: auto;
        }

        .pane {
            border-radius: 10px;
        }

        .pane-title {
            font-size: 10px;
            padding: 3px 7px;
        }

        .controls-bar {
            padding: 8px;
            gap: 6px;
            overflow-x: auto;
            flex-wrap: nowrap;
            position: sticky;
            bottom: 0;
            z-index: 9;
            backdrop-filter: blur(6px);
        }

        .ctrl-btn {
            width: 40px;
            height: 40px;
            flex: 0 0 auto;
        }

        .mode-btn {
            height: 30px;
            padding: 0 8px;
            flex: 0 0 auto;
        }

        .layout-panel {
            min-width: max-content;
        }
    }

    .presenter-room.swapped .room-shell {
        grid-template-columns: minmax(320px, var(--right-pane-width, 28%)) 10px minmax(0, 1fr);
        grid-template-areas: "right resize left";
    }

    .presenter-room.swapped #pane-resizer {
        cursor: col-resize;
    }

    .pane-resizer {
        grid-area: resize;
        align-self: stretch;
        border-radius: 999px;
        background: var(--resizer-bg);
        border: 1px solid var(--resizer-border);
        position: relative;
        cursor: col-resize;
        touch-action: none;
    }

    .pane-resizer::after {
        content: "";
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 4px;
        height: 32px;
        border-radius: 999px;
        background: rgba(203, 213, 225, 0.45);
    }

    .pane-resizer.dragging {
        background: linear-gradient(180deg, rgba(249, 115, 22, 0.45), rgba(249, 115, 22, 0.2));
        border-color: rgba(249, 115, 22, 0.7);
    }

    .empty-students {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        color: var(--empty-text);
        font-size: 18px;
        font-weight: 700;
        padding: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div id="room-root" class="presenter-room">
    <div class="room-top px-3 py-2 flex items-center justify-between">
        <div class="room-title text-xs font-black uppercase tracking-widest">Live Presenter</div>
        <div class="flex items-center gap-2">
            <span id="conn-badge" class="px-2 py-1 rounded bg-amber-500/15 text-amber-300 text-[10px] font-black uppercase tracking-wider">Connecting</span>
            <form method="post" action="{% url 'Prolean:external_live_leave' session_id %}">
                {% csrf_token %}
                <button type="submit" class="px-3 py-1.5 rounded bg-red-600 hover:bg-red-700 text-white text-[11px] font-black uppercase tracking-wider">Leave</button>
            </form>
        </div>
    </div>

    <div id="conn-error" class="hidden mx-3 mt-2 px-3 py-2 rounded border border-red-500/40 bg-red-500/10 text-red-300 text-xs font-semibold"></div>

    <div class="room-shell">
        <section id="left-pane" class="pane pane-main">
            <div class="pane-title">Professor Camera</div>
            <div id="left-host" class="video-host"></div>
        </section>

        <div id="pane-resizer" class="pane-resizer" title="Drag to resize screens"></div>

        <section id="right-pane" class="pane pane-side" title="Tap to switch right screen mode">
            <div id="right-title" class="pane-title">Professor Screen Share + Your Camera</div>
            <div id="right-host" class="video-host"></div>
        </section>
    </div>

    <div class="controls-bar">
        <button id="toggle-audio" class="ctrl-btn" data-state="on" title="Microphone"><span class="material-symbols-outlined">mic</span></button>
        <button id="toggle-video" class="ctrl-btn" data-state="on" title="Camera"><span class="material-symbols-outlined">videocam</span></button>
        <button id="toggle-screen" class="ctrl-btn" title="Screen Share"><span class="material-symbols-outlined">present_to_all</span></button>
        <button id="raise-hand" class="ctrl-btn" title="Raise Hand"><span class="material-symbols-outlined">front_hand</span></button>
        <button id="enable-sound" class="ctrl-btn" title="Enable Sound"><span class="material-symbols-outlined">volume_up</span></button>
        <button id="toggle-fullscreen" class="ctrl-btn" title="Fullscreen"><span class="material-symbols-outlined">fullscreen</span></button>
        <button id="cycle-right-mode" class="ctrl-btn" title="Switch Right Screen"><span class="material-symbols-outlined">swap_horiz</span></button>
        <button id="mode-screen" class="mode-btn" title="Screen only">Screen</button>
        <button id="mode-split" class="mode-btn active" title="Screen + Students">Split</button>
        <button id="mode-students" class="mode-btn" title="Students grid">Students</button>
        <button id="toggle-layout-panel" class="mode-btn" title="Customize layout">Layout</button>
        <div id="layout-panel" class="layout-panel">
            <label class="layout-item">
                <input id="swap-panes" type="checkbox" />
                <span>Swap</span>
            </label>
            <label class="layout-item">
                <span>Right</span>
                <input id="right-width" type="range" min="24" max="45" value="28" />
                <span id="right-width-value" class="value">28%</span>
            </label>
            <label class="layout-item">
                <span>Cols</span>
                <input id="grid-cols" type="range" min="1" max="4" value="2" />
                <span id="grid-cols-value" class="value">2</span>
            </label>
            <label class="layout-item">
                <span>Tile</span>
                <input id="tile-size" type="range" min="100" max="220" value="120" />
                <span id="tile-size-value" class="value">120</span>
            </label>
            <button id="reset-layout" class="mode-btn" type="button">Reset</button>
        </div>
        <div id="audio-sink" class="hidden"></div>
    </div>
</div>

<script src="https://download.agora.io/sdk/release/AgoraRTC_N.js"></script>
<script>
(() => {
  const agoraAppId = "{{ agora_app_id|escapejs }}";
  const agoraChannel = "{{ agora_channel|escapejs }}";
  const agoraToken = "{{ agora_token|escapejs }}";
  const agoraScreenToken = "{{ agora_screen_token|default:''|escapejs }}";
  const agoraUid = Number("{{ agora_uid|escapejs }}");
  const professorUidHint = Number("{{ professor_uid_hint|default:'1'|escapejs }}") || 1;
  const liveRole = String("{{ live_role|escapejs }}").toLowerCase();
  const isProfessor = liveRole === "professor";
  const selfName = "{{ user.get_full_name|default:user.username|escapejs }}";
  const professorNameHint = "{{ professor_name_hint|default:'Professor'|escapejs }}";

  const roomRoot = document.getElementById("room-root");
  const leftPane = document.getElementById("left-pane");
  const paneResizer = document.getElementById("pane-resizer");
  const rightPane = document.getElementById("right-pane");
  const leftHost = document.getElementById("left-host");
  const rightHost = document.getElementById("right-host");
  const rightTitle = document.getElementById("right-title");
  const connBadge = document.getElementById("conn-badge");
  const connError = document.getElementById("conn-error");

  const btnAudio = document.getElementById("toggle-audio");
  const btnVideo = document.getElementById("toggle-video");
  const btnScreen = document.getElementById("toggle-screen");
  const btnRaiseHand = document.getElementById("raise-hand");
  const btnSound = document.getElementById("enable-sound");
  const btnFullscreen = document.getElementById("toggle-fullscreen");
  const btnCycleMode = document.getElementById("cycle-right-mode");
  const btnModeScreen = document.getElementById("mode-screen");
  const btnModeSplit = document.getElementById("mode-split");
  const btnModeStudents = document.getElementById("mode-students");
  const btnToggleLayoutPanel = document.getElementById("toggle-layout-panel");
  const layoutPanel = document.getElementById("layout-panel");
  const swapPanesInput = document.getElementById("swap-panes");
  const rightWidthInput = document.getElementById("right-width");
  const gridColsInput = document.getElementById("grid-cols");
  const tileSizeInput = document.getElementById("tile-size");
  const rightWidthValue = document.getElementById("right-width-value");
  const gridColsValue = document.getElementById("grid-cols-value");
  const tileSizeValue = document.getElementById("tile-size-value");
  const btnResetLayout = document.getElementById("reset-layout");

  let themeObserver = null;
  let isResizing = false;
  let rightMode = 1;
  const SCREEN_UID_OFFSET = 1000;

  const participantLabels = new Map();
  const videoTracks = new Map();
  const audioTracks = new Map();
  const speakingIds = new Set();
  const raisedHands = new Set();
  let professorIdentity = String(professorUidHint);
  let localMicTrack = null;
  let localCamTrack = null;
  let localScreenTrack = null;
  let screenClient = null;

  const mainClient = AgoraRTC.createClient({ mode: "rtc", codec: "vp8" });

  const layoutStorageKey = "prolean_live_layout_v1";
  const defaultLayoutPrefs = { swapped: false, rightWidth: 28, gridCols: 2, tileMinHeight: 120 };
  let layoutPrefs = { ...defaultLayoutPrefs };

  const normalizeSource = (source) => String(source || "camera");
  const isScreenShare = (source) => normalizeSource(source).startsWith("screen_share");
  const initials = (label) => (String(label || "U").trim()[0] || "U").toUpperCase();

  const setStatus = (txt, kind = "warn") => {
    const style = {
      ok: "bg-green-500/15 text-green-300",
      warn: "bg-amber-500/15 text-amber-300",
      err: "bg-red-500/15 text-red-300",
    }[kind] || "bg-amber-500/15 text-amber-300";
    connBadge.className = `px-2 py-1 rounded text-[10px] font-black uppercase tracking-wider ${style}`;
    connBadge.textContent = txt;
  };
  const showError = (message) => {
    connError.textContent = message;
    connError.classList.remove("hidden");
  };

  const detectUiTheme = () => {
    const body = document.body;
    const root = document.documentElement;
    const bodyTheme = String(body?.dataset?.theme || body?.getAttribute("data-bs-theme") || "").toLowerCase();
    const rootTheme = String(root?.dataset?.theme || root?.getAttribute("data-bs-theme") || "").toLowerCase();
    const classDark = body?.classList?.contains("dark") || root?.classList?.contains("dark");
    if (bodyTheme === "light" || rootTheme === "light") return "light";
    if (bodyTheme === "dark" || rootTheme === "dark" || classDark) return "dark";
    return window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light";
  };
  const applyUiTheme = () => { roomRoot.dataset.uiTheme = detectUiTheme(); };
  const bindThemeSync = () => {
    applyUiTheme();
    const media = window.matchMedia("(prefers-color-scheme: dark)");
    if (typeof media.addEventListener === "function") media.addEventListener("change", applyUiTheme);
    themeObserver = new MutationObserver(applyUiTheme);
    if (document.body) themeObserver.observe(document.body, { attributes: true, attributeFilter: ["class", "data-theme", "data-bs-theme"] });
    themeObserver.observe(document.documentElement, { attributes: true, attributeFilter: ["class", "data-theme", "data-bs-theme"] });
  };

  const applyLayoutPrefs = () => {
    roomRoot.classList.toggle("swapped", !!layoutPrefs.swapped);
    roomRoot.style.setProperty("--right-pane-width", `${layoutPrefs.rightWidth}%`);
    roomRoot.style.setProperty("--student-grid-cols", String(layoutPrefs.gridCols));
    roomRoot.style.setProperty("--student-tile-min-h", `${layoutPrefs.tileMinHeight}px`);
    rightWidthValue.textContent = `${layoutPrefs.rightWidth}%`;
    gridColsValue.textContent = String(layoutPrefs.gridCols);
    tileSizeValue.textContent = String(layoutPrefs.tileMinHeight);
    swapPanesInput.checked = !!layoutPrefs.swapped;
    rightWidthInput.value = String(layoutPrefs.rightWidth);
    gridColsInput.value = String(layoutPrefs.gridCols);
    tileSizeInput.value = String(layoutPrefs.tileMinHeight);
  };
  const persistLayoutPrefs = () => { try { localStorage.setItem(layoutStorageKey, JSON.stringify(layoutPrefs)); } catch (_) {} };
  const loadLayoutPrefs = () => {
    try {
      const raw = localStorage.getItem(layoutStorageKey);
      if (!raw) return;
      const parsed = JSON.parse(raw);
      layoutPrefs = {
        swapped: !!parsed.swapped,
        rightWidth: Math.min(45, Math.max(24, Number(parsed.rightWidth || 28))),
        gridCols: Math.min(4, Math.max(1, Number(parsed.gridCols || 2))),
        tileMinHeight: Math.min(220, Math.max(100, Number(parsed.tileMinHeight || 120))),
      };
    } catch (_) {}
  };

  const syncControlStates = () => {
    const micOn = !!localMicTrack && !localMicTrack.muted;
    const camOn = !!localCamTrack && !localCamTrack.muted;
    btnAudio.dataset.state = micOn ? "on" : "off";
    btnVideo.dataset.state = camOn ? "on" : "off";
    btnAudio.innerHTML = `<span class="material-symbols-outlined">${micOn ? "mic" : "mic_off"}</span>`;
    btnVideo.innerHTML = `<span class="material-symbols-outlined">${camOn ? "videocam" : "videocam_off"}</span>`;
  };

  const addVideoTrack = (identity, track, source, isLocal = false) => {
    const key = `${identity}:${source}`;
    videoTracks.set(key, { track, identity: String(identity), source: normalizeSource(source), isLocal });
  };
  const removeVideoTracksByIdentity = (identity) => {
    for (const [key, item] of videoTracks.entries()) {
      if (String(item.identity) === String(identity)) {
        try { item.track.stop(); } catch (_) {}
        videoTracks.delete(key);
      }
    }
  };
  const pickTrack = (identity, wantScreen = false) => {
    const id = String(identity);
    const entries = Array.from(videoTracks.values()).filter((v) => String(v.identity) === id && (wantScreen ? isScreenShare(v.source) : !isScreenShare(v.source)));
    return entries.length ? entries[entries.length - 1] : null;
  };

  const resolveProfessorIdentity = () => {
    if (isProfessor) return String(agoraUid);
    if (participantLabels.has(String(professorUidHint))) return String(professorUidHint);
    if (participantLabels.has("1")) return "1";
    return String(professorUidHint);
  };
  const isProfessorLike = (identity) => {
    const id = String(identity);
    if (id === String(resolveProfessorIdentity())) return true;
    if (id === String(professorUidHint + SCREEN_UID_OFFSET)) return true;
    return false;
  };

  const renderAvatar = (host, label) => {
    host.innerHTML = "";
    const wrap = document.createElement("div");
    wrap.className = "avatar-host";
    const badge = document.createElement("div");
    badge.className = "avatar-badge";
    badge.textContent = initials(label);
    wrap.appendChild(badge);
    const footer = document.createElement("div");
    footer.className = "student-label";
    footer.textContent = label;
    wrap.appendChild(footer);
    host.appendChild(wrap);
  };
  const renderTrack = (host, data, label) => {
    host.innerHTML = "";
    const media = document.createElement("div");
    media.style.width = "100%";
    media.style.height = "100%";
    host.appendChild(media);
    data.track.play(media, { fit: "cover" });
    const footer = document.createElement("div");
    footer.className = "student-label";
    footer.textContent = label;
    host.appendChild(footer);
  };

  const markPaneBorders = () => {
    leftPane.classList.remove("speaker-border", "raised-border");
    rightPane.classList.remove("speaker-border", "raised-border");
    const prof = resolveProfessorIdentity();
    if (speakingIds.has(prof)) leftPane.classList.add("speaker-border");
    if (raisedHands.has(prof)) leftPane.classList.add("raised-border");
    const studentIds = Array.from(participantLabels.keys()).filter((id) => !isProfessorLike(id));
    if (studentIds.some((id) => speakingIds.has(id))) rightPane.classList.add("speaker-border");
    if (studentIds.some((id) => raisedHands.has(id))) rightPane.classList.add("raised-border");
  };

  const renderLeftPane = () => {
    professorIdentity = resolveProfessorIdentity();
    const label = participantLabels.get(professorIdentity) || professorNameHint || "Professor";
    const profCam = pickTrack(professorIdentity, false);
    if (profCam) renderTrack(leftHost, profCam, label);
    else renderAvatar(leftHost, label);
  };
  const getStudentEntries = () => {
    const rows = [];
    for (const [id, name] of participantLabels.entries()) {
      if (isProfessorLike(id)) continue;
      rows.push({ id, name });
    }
    return rows;
  };
  const renderStudentsInto = (host, compact = false) => {
    host.innerHTML = "";
    const students = getStudentEntries();
    if (!students.length) {
      const empty = document.createElement("div");
      empty.className = "empty-students";
      empty.textContent = "Waiting for students to join live";
      host.appendChild(empty);
      return;
    }
    const grid = document.createElement("div");
    grid.className = "student-grid";
    if (compact) grid.classList.add("compact");
    for (const student of students) {
      const card = document.createElement("div");
      card.className = "student-card";
      if (raisedHands.has(student.id)) card.classList.add("raised-border");
      else if (speakingIds.has(student.id)) card.classList.add("speaker-border");
      const cam = pickTrack(student.id, false);
      if (cam) {
        const media = document.createElement("div");
        media.style.width = "100%";
        media.style.height = "100%";
        card.appendChild(media);
        cam.track.play(media, { fit: "cover" });
      } else {
        const av = document.createElement("div");
        av.className = "avatar-host";
        const badge = document.createElement("div");
        badge.className = "avatar-badge";
        badge.textContent = initials(student.name);
        av.appendChild(badge);
        card.appendChild(av);
      }
      const footer = document.createElement("div");
      footer.className = "student-label";
      footer.textContent = student.name;
      card.appendChild(footer);
      grid.appendChild(card);
    }
    host.appendChild(grid);
  };
  const syncModeButtons = () => {
    btnModeScreen.classList.toggle("active", rightMode === 0);
    btnModeSplit.classList.toggle("active", rightMode === 1);
    btnModeStudents.classList.toggle("active", rightMode === 2);
  };
  const renderRightPane = () => {
    if (rightMode === 0) {
      rightTitle.textContent = "Professor Screen Share (Tap to Switch)";
      const screen = pickTrack(resolveProfessorIdentity(), true);
      if (screen) renderTrack(rightHost, screen, "Screen Share");
      else renderAvatar(rightHost, "No Screen Share");
    } else if (rightMode === 1) {
      rightTitle.textContent = "Professor Screen Share + Students (Tap to Switch)";
      rightHost.innerHTML = "";
      const split = document.createElement("div");
      split.className = "right-split";
      const top = document.createElement("div");
      top.className = "right-split-top";
      const bottom = document.createElement("div");
      bottom.className = "right-split-bottom";
      const screen = pickTrack(resolveProfessorIdentity(), true);
      if (screen) renderTrack(top, screen, "The prof screen sharing");
      else renderAvatar(top, "No Screen Share");
      renderStudentsInto(bottom, true);
      split.appendChild(top);
      split.appendChild(bottom);
      rightHost.appendChild(split);
    } else {
      rightTitle.textContent = "Students Grid (Tap to Switch)";
      renderStudentsInto(rightHost, false);
    }
    syncModeButtons();
    markPaneBorders();
  };
  const rerender = () => { renderLeftPane(); renderRightPane(); };

  const subscribeUser = async (user, mediaType) => {
    await mainClient.subscribe(user, mediaType);
    const uid = String(user.uid);
    if (!participantLabels.has(uid)) participantLabels.set(uid, `Student ${uid}`);
    if (mediaType === "video" && user.videoTrack) {
      const source = Number(user.uid) === (professorUidHint + SCREEN_UID_OFFSET) ? "screen_share" : "camera";
      const identity = source === "screen_share" ? String(professorUidHint) : uid;
      addVideoTrack(identity, user.videoTrack, source, false);
      rerender();
    }
    if (mediaType === "audio" && user.audioTrack) {
      audioTracks.set(uid, user.audioTrack);
      try { user.audioTrack.play(); } catch (_) {}
    }
  };

  const connectAgora = async () => {
    if (!agoraAppId || !agoraChannel || !agoraToken) {
      setStatus("Config Error", "err");
      showError("Agora config missing.");
      return;
    }
    setStatus("Connecting", "warn");
    try {
      participantLabels.set(String(agoraUid), selfName || (isProfessor ? "Professor" : "You"));
      await mainClient.join(agoraAppId, agoraChannel, agoraToken, agoraUid);
      mainClient.enableAudioVolumeIndicator();
      localMicTrack = await AgoraRTC.createMicrophoneAudioTrack();
      localCamTrack = await AgoraRTC.createCameraVideoTrack();
      await mainClient.publish([localMicTrack, localCamTrack]);
      addVideoTrack(String(agoraUid), localCamTrack, "camera", true);
      setStatus("Connected", "ok");
      syncControlStates();
      rerender();

      if (!isProfessor) {
        btnScreen.disabled = true;
        btnScreen.classList.add("opacity-50", "cursor-not-allowed");
      } else {
        btnToggleLayoutPanel.classList.add("hidden");
      }
    } catch (err) {
      setStatus("Connection Failed", "err");
      showError(`Agora connection failed: ${err?.message || err}`);
    }
  };

  mainClient.on("user-published", async (user, mediaType) => {
    await subscribeUser(user, mediaType);
  });
  mainClient.on("user-unpublished", (user, mediaType) => {
    const uid = String(user.uid);
    if (mediaType === "video") {
      removeVideoTracksByIdentity(uid);
      if (Number(user.uid) === (professorUidHint + SCREEN_UID_OFFSET)) removeVideoTracksByIdentity(String(professorUidHint));
    }
    if (mediaType === "audio") audioTracks.delete(uid);
    rerender();
  });
  mainClient.on("user-left", (user) => {
    const uid = String(user.uid);
    removeVideoTracksByIdentity(uid);
    audioTracks.delete(uid);
    participantLabels.delete(uid);
    speakingIds.delete(uid);
    raisedHands.delete(uid);
    rerender();
  });
  mainClient.on("volume-indicator", (volumes) => {
    speakingIds.clear();
    volumes.forEach((v) => {
      if ((v.level || 0) > 5) speakingIds.add(String(v.uid));
    });
    markPaneBorders();
    if (rightMode === 2) renderRightPane();
  });

  const startScreenShare = async () => {
    if (!isProfessor || localScreenTrack) return;
    try {
      const screenUid = professorUidHint + SCREEN_UID_OFFSET;
      screenClient = AgoraRTC.createClient({ mode: "rtc", codec: "vp8" });
      await screenClient.join(agoraAppId, agoraChannel, (agoraScreenToken || agoraToken), screenUid);
      const st = await AgoraRTC.createScreenVideoTrack();
      localScreenTrack = Array.isArray(st) ? st[0] : st;
      await screenClient.publish([localScreenTrack]);
      addVideoTrack(String(professorUidHint), localScreenTrack, "screen_share", true);
      localScreenTrack.on("track-ended", stopScreenShare);
      btnScreen.innerHTML = '<span class="material-symbols-outlined">stop_screen_share</span>';
      rerender();
    } catch (e) {
      const msg = String(e?.message || e || "");
      if (/not supported|permission|denied|mobile|ios|android/i.test(msg)) {
        showError("Screen share is not supported on this browser/device. Use desktop Chrome/Edge for screen sharing.");
      } else {
        showError(`Screen share failed: ${msg}`);
      }
      stopScreenShare();
    }
  };
  const stopScreenShare = async () => {
    try {
      if (localScreenTrack) {
        localScreenTrack.stop();
        localScreenTrack.close();
      }
      if (screenClient) await screenClient.leave();
    } catch (_) {}
    localScreenTrack = null;
    screenClient = null;
    removeVideoTracksByIdentity(String(professorUidHint));
    if (localCamTrack) addVideoTrack(String(agoraUid), localCamTrack, "camera", true);
    btnScreen.innerHTML = '<span class="material-symbols-outlined">present_to_all</span>';
    rerender();
  };

  rightPane.addEventListener("click", () => { rightMode = (rightMode + 1) % 3; renderRightPane(); });
  btnCycleMode.addEventListener("click", () => { rightMode = (rightMode + 1) % 3; renderRightPane(); });
  btnModeScreen.addEventListener("click", () => { rightMode = 0; renderRightPane(); });
  btnModeSplit.addEventListener("click", () => { rightMode = 1; renderRightPane(); });
  btnModeStudents.addEventListener("click", () => { rightMode = 2; renderRightPane(); });

  btnToggleLayoutPanel.addEventListener("click", () => {
    layoutPanel.classList.toggle("open");
    btnToggleLayoutPanel.classList.toggle("active", layoutPanel.classList.contains("open"));
  });
  swapPanesInput.addEventListener("change", () => { layoutPrefs.swapped = swapPanesInput.checked; applyLayoutPrefs(); persistLayoutPrefs(); });
  rightWidthInput.addEventListener("input", () => { layoutPrefs.rightWidth = Number(rightWidthInput.value); applyLayoutPrefs(); });
  rightWidthInput.addEventListener("change", persistLayoutPrefs);
  gridColsInput.addEventListener("input", () => { layoutPrefs.gridCols = Number(gridColsInput.value); applyLayoutPrefs(); renderRightPane(); });
  gridColsInput.addEventListener("change", persistLayoutPrefs);
  tileSizeInput.addEventListener("input", () => { layoutPrefs.tileMinHeight = Number(tileSizeInput.value); applyLayoutPrefs(); });
  tileSizeInput.addEventListener("change", persistLayoutPrefs);
  btnResetLayout.addEventListener("click", () => { layoutPrefs = { ...defaultLayoutPrefs }; applyLayoutPrefs(); persistLayoutPrefs(); renderRightPane(); });

  const clampRightPaneWidth = (next) => Math.min(45, Math.max(24, Number(next || 28)));
  const setRightPaneWidthFromPointer = (clientX) => {
    if (window.matchMedia("(max-width: 1100px)").matches) return;
    const shellRect = roomRoot.querySelector(".room-shell").getBoundingClientRect();
    if (!shellRect.width) return;
    const relativeX = clientX - shellRect.left;
    const rightPercent = ((shellRect.width - relativeX) / shellRect.width) * 100;
    layoutPrefs.rightWidth = clampRightPaneWidth(rightPercent);
    applyLayoutPrefs();
  };
  paneResizer.addEventListener("pointerdown", (event) => {
    if (window.matchMedia("(max-width: 1100px)").matches) return;
    isResizing = true;
    paneResizer.classList.add("dragging");
    paneResizer.setPointerCapture(event.pointerId);
    event.preventDefault();
  });
  paneResizer.addEventListener("pointermove", (event) => { if (isResizing) setRightPaneWidthFromPointer(event.clientX); });
  const stopResizing = () => { if (isResizing) { isResizing = false; paneResizer.classList.remove("dragging"); persistLayoutPrefs(); } };
  paneResizer.addEventListener("pointerup", stopResizing);
  paneResizer.addEventListener("pointercancel", stopResizing);

  btnAudio.addEventListener("click", async () => {
    if (!localMicTrack) return;
    await localMicTrack.setMuted(!localMicTrack.muted);
    syncControlStates();
  });
  btnVideo.addEventListener("click", async () => {
    if (!localCamTrack) return;
    await localCamTrack.setMuted(!localCamTrack.muted);
    syncControlStates();
    rerender();
  });
  btnScreen.addEventListener("click", async () => {
    if (!isProfessor) return;
    if (localScreenTrack) await stopScreenShare();
    else await startScreenShare();
  });
  btnRaiseHand.addEventListener("click", async () => {
    const id = String(agoraUid);
    if (raisedHands.has(id)) raisedHands.delete(id);
    else raisedHands.add(id);
    btnRaiseHand.innerHTML = raisedHands.has(id)
      ? '<span class="material-symbols-outlined">waving_hand</span>'
      : '<span class="material-symbols-outlined">front_hand</span>';
    markPaneBorders();
  });
  btnSound.addEventListener("click", () => {
    audioTracks.forEach((track) => { try { track.play(); } catch (_) {} });
    setStatus("Connected", "ok");
  });

  btnFullscreen.addEventListener("click", async () => {
    if (!document.fullscreenElement) {
      roomRoot.classList.add("room-fullscreen");
      await roomRoot.requestFullscreen().catch(() => {});
      btnFullscreen.innerHTML = '<span class="material-symbols-outlined">fullscreen_exit</span>';
    } else {
      await document.exitFullscreen().catch(() => {});
      roomRoot.classList.remove("room-fullscreen");
      btnFullscreen.innerHTML = '<span class="material-symbols-outlined">fullscreen</span>';
    }
  });
  document.addEventListener("fullscreenchange", () => {
    if (!document.fullscreenElement) {
      roomRoot.classList.remove("room-fullscreen");
      btnFullscreen.innerHTML = '<span class="material-symbols-outlined">fullscreen</span>';
    }
  });

  window.addEventListener("beforeunload", async () => {
    if (themeObserver) themeObserver.disconnect();
    try { if (localMicTrack) localMicTrack.close(); } catch (_) {}
    try { if (localCamTrack) localCamTrack.close(); } catch (_) {}
    try { await stopScreenShare(); } catch (_) {}
    try { await mainClient.leave(); } catch (_) {}
  });

  bindThemeSync();
  loadLayoutPrefs();
  applyLayoutPrefs();
  connectAgora();
})();
</script>
{% endblock %}

