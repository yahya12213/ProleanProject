{% extends 'Prolean/base.html' %}
{% load static i18n %}
{% get_current_language as CURRENT_LANGUAGE %}

{% block title %}Live Presenter Room{% endblock %}
{% block main_class %}w-full max-w-none{% endblock %}
{% block extra_css %}
<style>
    html, body {
        height: 100%;
        max-height: 100%;
        overflow: hidden;
    }

    #contact, .floating-buttons { display: none !important; }
    body > header, body > footer { display: none !important; }

    .presenter-room {
        --bg-main: linear-gradient(180deg, #14171c 0%, #101318 100%);
        --text-main: #e5e7eb;
        --panel-bg: #11141a;
        --top-bg: #15181d;
        --panel-border: rgba(148, 163, 184, 0.24);
        --top-border: rgba(148, 163, 184, 0.2);
        --media-bg: #090b0f;
        --label-bg: rgba(0, 0, 0, 0.65);
        --muted-text: #cbd5e1;
        --layout-bg: #1b212b;
        --ctrl-bg: #222a35;
        --mode-bg: #202733;
        --resizer-bg: linear-gradient(180deg, rgba(148, 163, 184, 0.18), rgba(148, 163, 184, 0.08));
        --resizer-border: rgba(148, 163, 184, 0.25);
        --empty-text: #9ca3af;
        height: 100vh;
        max-height: 100vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        background: var(--bg-main);
        color: var(--text-main);
        font-family: "Plus Jakarta Sans", sans-serif;
    }

    .presenter-room[data-ui-theme="light"] {
        --bg-main: linear-gradient(180deg, #f8fafc 0%, #eef2f7 100%);
        --text-main: #0f172a;
        --panel-bg: #ffffff;
        --top-bg: #f8fafc;
        --panel-border: rgba(15, 23, 42, 0.12);
        --top-border: rgba(15, 23, 42, 0.12);
        --media-bg: #e5e7eb;
        --label-bg: rgba(15, 23, 42, 0.75);
        --muted-text: #334155;
        --layout-bg: #f1f5f9;
        --ctrl-bg: #e2e8f0;
        --mode-bg: #e2e8f0;
        --resizer-bg: linear-gradient(180deg, rgba(15, 23, 42, 0.14), rgba(15, 23, 42, 0.06));
        --resizer-border: rgba(15, 23, 42, 0.18);
        --empty-text: #475569;
    }

    .room-top {
        border-bottom: 1px solid var(--top-border);
        background: var(--top-bg);
        flex: 0 0 auto;
    }

    .room-title {
        color: var(--muted-text);
    }

    .room-shell {
        display: grid;
        grid-template-columns: minmax(0, calc(100% - var(--right-pane-width, 28%))) 10px minmax(0, var(--right-pane-width, 28%));
        grid-template-areas: "left resize right";
        gap: 14px;
        flex: 1 1 auto;
        min-height: 0;
        padding: 12px;
        overflow: hidden;
    }

    .presence-board {
        margin: 0 12px 10px;
        border: 1px solid var(--panel-border);
        border-radius: 12px;
        background: var(--panel-bg);
        padding: 10px 12px;
        display: grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 10px;
    }

    .watermark {
        position: absolute;
        inset: 0;
        pointer-events: none;
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        padding: 10px;
        opacity: 0.72;
        mix-blend-mode: screen;
    }
    .presenter-room[data-ui-theme="light"] .watermark { mix-blend-mode: multiply; opacity: 0.55; }
    .wm-chip {
        display: inline-flex;
        flex-direction: column;
        gap: 2px;
        max-width: 70%;
        border-radius: 12px;
        padding: 6px 8px;
        border: 1px solid rgba(148, 163, 184, 0.24);
        background: rgba(0, 0, 0, 0.25);
        color: #e2e8f0;
        font-size: 10px;
        font-weight: 900;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        filter: drop-shadow(0 8px 18px rgba(0,0,0,.25));
    }
    .presenter-room[data-ui-theme="light"] .wm-chip {
        background: rgba(255, 255, 255, 0.55);
        color: #0f172a;
    }
    .wm-chip .small { font-size: 9px; opacity: 0.85; letter-spacing: 0.10em; }
    .wm-chip.right { align-items: flex-end; max-width: 48%; }

    .mod-drawer {
        position: fixed;
        top: 76px;
        right: 12px;
        width: min(420px, calc(100vw - 24px));
        max-height: calc(100vh - 140px);
        border: 1px solid var(--panel-border);
        border-radius: 16px;
        background: var(--panel-bg);
        box-shadow: 0 24px 80px rgba(0,0,0,.35);
        display: none;
        flex-direction: column;
        overflow: hidden;
        z-index: 60;
    }
    .mod-drawer.open { display: flex; }
    .mod-head {
        padding: 12px;
        border-bottom: 1px solid var(--panel-border);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        background: linear-gradient(135deg, rgba(255, 107, 0, 0.10), rgba(6, 182, 212, 0.08));
    }
    .mod-title {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        font-size: 12px;
        font-weight: 900;
        letter-spacing: 0.10em;
        text-transform: uppercase;
        color: var(--text-main);
    }
    .mod-actions { display: flex; gap: 8px; flex-wrap: wrap; }
    .mod-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        padding: 8px 10px;
        border-radius: 12px;
        border: 1px solid rgba(148, 163, 184, 0.24);
        background: rgba(148, 163, 184, 0.12);
        color: var(--text-main);
        font-size: 11px;
        font-weight: 900;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        cursor: pointer;
        user-select: none;
        white-space: nowrap;
    }
    .mod-btn.danger { background: rgba(239, 68, 68, 0.16); border-color: rgba(239, 68, 68, 0.28); }
    .mod-body { padding: 12px; overflow: auto; display: grid; gap: 10px; }
    .mod-row {
        border: 1px solid var(--panel-border);
        border-radius: 14px;
        padding: 10px;
        background: rgba(148, 163, 184, 0.08);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        min-width: 0;
    }
    .mod-row .name { font-size: 12px; font-weight: 900; color: var(--text-main); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .mod-row .meta { font-size: 10px; font-weight: 900; color: var(--muted-text); letter-spacing: 0.10em; text-transform: uppercase; }
    .mod-row .btns { display: flex; gap: 8px; flex: 0 0 auto; }
    .mod-mini {
        width: 38px;
        height: 38px;
        border-radius: 12px;
        border: 1px solid rgba(148, 163, 184, 0.24);
        background: rgba(148, 163, 184, 0.12);
        color: var(--text-main);
        display: grid;
        place-items: center;
        cursor: pointer;
    }
    .mod-mini.danger { background: rgba(239, 68, 68, 0.16); border-color: rgba(239, 68, 68, 0.28); }

    .presence-col {
        min-width: 0;
    }

    .presence-head {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 6px;
    }

    .presence-title {
        font-size: 11px;
        font-weight: 900;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--muted-text);
    }

    .presence-count {
        font-size: 11px;
        font-weight: 900;
        color: var(--text-main);
        background: rgba(148, 163, 184, 0.16);
        border-radius: 999px;
        padding: 2px 8px;
    }

    .presence-list {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        min-height: 30px;
    }

    .presence-chip {
        font-size: 11px;
        font-weight: 700;
        border-radius: 999px;
        padding: 3px 9px;
        border: 1px solid transparent;
        background: rgba(148, 163, 184, 0.15);
        color: var(--text-main);
        max-width: 100%;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .presence-chip.online {
        background: rgba(34, 197, 94, 0.18);
        border-color: rgba(34, 197, 94, 0.45);
        color: #86efac;
    }

    .presence-chip.speaking {
        background: rgba(239, 68, 68, 0.16);
        border-color: rgba(239, 68, 68, 0.45);
        color: #fca5a5;
    }

    .presence-chip.hand {
        background: rgba(34, 197, 94, 0.18);
        border-color: rgba(34, 197, 94, 0.45);
        color: #86efac;
    }

    .presence-empty {
        font-size: 11px;
        font-weight: 700;
        color: var(--empty-text);
    }

    @media (max-width: 1100px) {
        .room-shell {
            grid-template-columns: 1fr;
            grid-template-areas: "left" "right";
            grid-template-rows: minmax(0, 1fr) minmax(0, 1fr);
        }

        .presence-board {
            grid-template-columns: 1fr;
            margin: 0 8px 8px;
            padding: 8px;
        }

        .pane-resizer {
            display: none;
        }

        .pane-main, .pane-side {
            min-height: 0;
        }
    }

    .pane {
        border: 1px solid var(--panel-border);
        background: var(--panel-bg);
        border-radius: 12px;
        overflow: hidden;
        position: relative;
        display: flex;
        flex-direction: column;
    }

    .pane-main {
        min-height: 0;
        grid-area: left;
    }

    .pane-side {
        min-height: 0;
        cursor: pointer;
        min-width: 0;
        grid-area: right;
    }

    .right-split {
        height: 100%;
        display: grid;
        grid-template-rows: 1fr 1fr;
        min-height: 0;
    }

    .right-split-top, .right-split-bottom {
        position: relative;
        min-height: 0;
        background: var(--media-bg);
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }

    .right-split-bottom {
        border-top: 2px solid #f97316;
    }

    .pane-title {
        position: absolute;
        top: 8px;
        left: 8px;
        z-index: 5;
        background: var(--label-bg);
        border: 1px solid var(--panel-border);
        border-radius: 8px;
        padding: 4px 8px;
        font-size: 11px;
        font-weight: 800;
        letter-spacing: 0.06em;
        text-transform: uppercase;
    }

    .speaker-border {
        box-shadow: inset 0 0 0 2px #ef4444;
    }

    .raised-border {
        box-shadow: inset 0 0 0 2px #22c55e;
    }

    .video-host {
        width: 100%;
        height: 100%;
        background: var(--media-bg);
        flex: 1;
        min-height: 0;
        position: relative;
        overflow: hidden;
    }

    .video-host video {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .avatar-host {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: radial-gradient(circle at 20% 20%, #1f2937 0%, #0b0d11 100%);
    }

    .avatar-badge {
        width: 96px;
        height: 96px;
        border-radius: 999px;
        background: #f97316;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #fff;
        font-size: 38px;
        font-weight: 900;
    }

    .student-grid {
        display: grid;
        grid-template-columns: repeat(var(--student-grid-cols, 2), minmax(0, 1fr));
        gap: 8px;
        padding: 40px 8px 8px;
        height: 100%;
        min-height: 0;
        overflow: hidden;
        align-items: stretch;
    }

    .student-grid.compact {
        grid-template-columns: repeat(1, minmax(0, 1fr));
        grid-auto-rows: minmax(0, 1fr);
        padding: 8px;
    }

    .student-grid.compact .student-card {
        min-height: 0;
    }

    .student-card {
        min-height: var(--student-tile-min-h, 120px);
        height: 100%;
        border: 1px solid var(--panel-border);
        border-radius: 10px;
        overflow: hidden;
        position: relative;
        background: var(--media-bg);
    }

    .agora-video-slot {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .agora-video-slot.fit-contain {
        background: #000;
    }
    .agora-video-slot.fit-contain video {
        object-fit: contain !important;
    }

    .student-card video {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .student-label {
        position: absolute;
        left: 6px;
        bottom: 6px;
        z-index: 4;
        padding: 3px 7px;
        border-radius: 7px;
        background: var(--label-bg);
        color: #fff;
        font-size: 11px;
        font-weight: 700;
    }

    .controls-bar {
        border-top: 1px solid var(--top-border);
        background: var(--top-bg);
        padding: 10px 12px;
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
        flex: 0 0 auto;
    }

    .ctrl-btn {
        width: 42px;
        height: 42px;
        border-radius: 10px;
        border: 1px solid var(--panel-border);
        background: var(--ctrl-bg);
        color: var(--text-main);
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }

    .ctrl-btn[data-state="off"] {
        background: rgba(239, 68, 68, 0.18);
        border-color: rgba(239, 68, 68, 0.45);
        color: #fca5a5;
    }

    .mode-btn {
        height: 32px;
        padding: 0 10px;
        border-radius: 8px;
        border: 1px solid var(--panel-border);
        background: var(--mode-bg);
        color: var(--muted-text);
        font-size: 11px;
        font-weight: 800;
        text-transform: uppercase;
        letter-spacing: 0.06em;
    }

    .mode-btn.active {
        background: #f97316;
        border-color: #fb923c;
        color: #111827;
    }

    .layout-panel {
        margin-left: auto;
        display: none;
        align-items: center;
        gap: 8px;
        background: var(--layout-bg);
        border: 1px solid var(--panel-border);
        border-radius: 10px;
        padding: 8px;
    }

    .layout-panel.open {
        display: flex;
        flex-wrap: wrap;
    }

    .layout-item {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        color: var(--muted-text);
        font-size: 11px;
        font-weight: 700;
    }

    .layout-item input[type="range"] {
        width: 88px;
    }

    .layout-item .value {
        min-width: 26px;
        text-align: right;
        color: #f8fafc;
    }

    .room-fullscreen .room-top {
        display: none;
    }

    @media (max-width: 1100px) {
        html, body {
            overflow-y: auto;
        }

        .presenter-room {
            height: 100dvh;
            max-height: 100dvh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .room-shell {
            min-height: 0;
        }
    }

    @media (max-width: 900px) {

        .room-shell {
            padding: 8px;
            gap: 8px;
            grid-template-rows: minmax(260px, 58dvh) minmax(180px, 34dvh);
            overflow-y: auto;
        }

        .pane {
            border-radius: 10px;
        }

        .pane-title {
            font-size: 10px;
            padding: 3px 7px;
        }

        .controls-bar {
            padding: 8px;
            gap: 6px;
            overflow-x: auto;
            flex-wrap: nowrap;
            position: sticky;
            bottom: 0;
            z-index: 9;
            backdrop-filter: blur(6px);
        }

        .ctrl-btn {
            width: 40px;
            height: 40px;
            flex: 0 0 auto;
        }

        .mode-btn {
            height: 30px;
            padding: 0 8px;
            flex: 0 0 auto;
        }

        .layout-panel {
            min-width: max-content;
        }
    }

    .presenter-room.swapped .room-shell {
        grid-template-columns: minmax(0, var(--right-pane-width, 28%)) 10px minmax(0, calc(100% - var(--right-pane-width, 28%)));
        grid-template-areas: "right resize left";
    }

    .presenter-room.swapped #pane-resizer {
        cursor: col-resize;
    }

    .pane-resizer {
        grid-area: resize;
        align-self: stretch;
        border-radius: 999px;
        background: var(--resizer-bg);
        border: 1px solid var(--resizer-border);
        position: relative;
        cursor: col-resize;
        touch-action: none;
    }

    .pane-resizer::after {
        content: "";
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 4px;
        height: 32px;
        border-radius: 999px;
        background: rgba(203, 213, 225, 0.45);
    }

    .pane-resizer.dragging {
        background: linear-gradient(180deg, rgba(249, 115, 22, 0.45), rgba(249, 115, 22, 0.2));
        border-color: rgba(249, 115, 22, 0.7);
    }

    .empty-students {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        color: var(--empty-text);
        font-size: 18px;
        font-weight: 700;
        padding: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div id="room-root" class="presenter-room">
    <div class="room-top px-3 py-2 flex items-center justify-between">
        <div class="room-title text-xs font-black uppercase tracking-widest">{% if CURRENT_LANGUAGE == 'ar' %}غرفة البث{% elif CURRENT_LANGUAGE == 'en' %}Live Presenter{% else %}Présentateur Live{% endif %}</div>
        <div class="flex items-center gap-2">
            <span id="conn-badge" class="px-2 py-1 rounded bg-amber-500/15 text-amber-300 text-[10px] font-black uppercase tracking-wider">{% if CURRENT_LANGUAGE == 'ar' %}جاري الاتصال{% elif CURRENT_LANGUAGE == 'en' %}Connecting{% else %}Connexion{% endif %}</span>
            <form method="post" action="{% url 'Prolean:external_live_leave' session_id %}">
                {% csrf_token %}
                <button type="submit" class="px-3 py-1.5 rounded bg-red-600 hover:bg-red-700 text-white text-[11px] font-black uppercase tracking-wider">{% if CURRENT_LANGUAGE == 'ar' %}خروج{% elif CURRENT_LANGUAGE == 'en' %}Leave{% else %}Quitter{% endif %}</button>
            </form>
        </div>
    </div>

    <div id="conn-error" class="hidden mx-3 mt-2 px-3 py-2 rounded border border-red-500/40 bg-red-500/10 text-red-300 text-xs font-semibold"></div>

    <div id="presence-board" class="presence-board">
        <section class="presence-col">
            <div class="presence-head">
                <span class="presence-title">{% if CURRENT_LANGUAGE == 'ar' %}الطلاب المتصلون{% elif CURRENT_LANGUAGE == 'en' %}Online Students{% else %}Étudiants en ligne{% endif %}</span>
                <span id="online-count" class="presence-count">0</span>
            </div>
            <div id="online-list" class="presence-list">
                <span class="presence-empty">{% if CURRENT_LANGUAGE == 'ar' %}لا يوجد طلاب متصلون{% elif CURRENT_LANGUAGE == 'en' %}No students online{% else %}Aucun étudiant en ligne{% endif %}</span>
            </div>
        </section>
        <section class="presence-col">
            <div class="presence-head">
                <span class="presence-title">{% if CURRENT_LANGUAGE == 'ar' %}المتحدثون الآن{% elif CURRENT_LANGUAGE == 'en' %}Speaking Now{% else %}Parle maintenant{% endif %}</span>
                <span id="speaking-count" class="presence-count">0</span>
            </div>
            <div id="speaking-list" class="presence-list">
                <span class="presence-empty">{% if CURRENT_LANGUAGE == 'ar' %}لا يوجد متحدث نشط{% elif CURRENT_LANGUAGE == 'en' %}No active speaker{% else %}Aucun intervenant actif{% endif %}</span>
            </div>
        </section>
        <section class="presence-col">
            <div class="presence-head">
                <span class="presence-title">{% if CURRENT_LANGUAGE == 'ar' %}الأيادي المرفوعة{% elif CURRENT_LANGUAGE == 'en' %}Raised Hands{% else %}Mains levées{% endif %}</span>
                <span id="raised-count" class="presence-count">0</span>
            </div>
            <div id="raised-list" class="presence-list">
                <span class="presence-empty">{% if CURRENT_LANGUAGE == 'ar' %}لا توجد أيادي مرفوعة{% elif CURRENT_LANGUAGE == 'en' %}No raised hand{% else %}Aucune main levée{% endif %}</span>
            </div>
        </section>
    </div>

    {% if live_role|lower == 'professor' %}
    <div id="mod-drawer" class="mod-drawer">
        <div class="mod-head">
            <div class="mod-title"><span class="material-symbols-outlined">shield_person</span>Moderation</div>
            <div class="mod-actions">
                <button id="mute-all" class="mod-btn"><span class="material-symbols-outlined text-base">mic_off</span>Mute all</button>
                <button id="unmute-all" class="mod-btn"><span class="material-symbols-outlined text-base">mic</span>Unmute</button>
                <button id="close-mod" class="mod-btn"><span class="material-symbols-outlined text-base">close</span>Close</button>
            </div>
        </div>
        <div id="mod-body" class="mod-body"></div>
    </div>
    {% endif %}

    <div class="room-shell">
        <section id="left-pane" class="pane pane-main">
            <div class="pane-title">{% if CURRENT_LANGUAGE == 'ar' %}كاميرا الأستاذ{% elif CURRENT_LANGUAGE == 'en' %}Professor Camera{% else %}Caméra professeur{% endif %}</div>
            <div id="left-host" class="video-host"></div>
        </section>

        <div id="pane-resizer" class="pane-resizer" title="{% if CURRENT_LANGUAGE == 'ar' %}اسحب لتعديل الحجم{% elif CURRENT_LANGUAGE == 'en' %}Drag to resize screens{% else %}Glisser pour redimensionner{% endif %}"></div>

        <section id="right-pane" class="pane pane-side" title="{% if CURRENT_LANGUAGE == 'ar' %}اضغط لتبديل وضع الشاشة اليمنى{% elif CURRENT_LANGUAGE == 'en' %}Tap to switch right screen mode{% else %}Touchez pour changer le mode à droite{% endif %}">
            <div id="right-title" class="pane-title">{% if CURRENT_LANGUAGE == 'ar' %}مشاركة شاشة الأستاذ + كاميرتك{% elif CURRENT_LANGUAGE == 'en' %}Professor Screen Share + Your Camera{% else %}Partage écran prof + votre caméra{% endif %}</div>
            <div id="right-host" class="video-host"></div>
        </section>
    </div>

    <div class="controls-bar">
        <button id="toggle-audio" class="ctrl-btn" data-state="on" title="Microphone"><span class="material-symbols-outlined">mic</span></button>
        <button id="toggle-video" class="ctrl-btn" data-state="on" title="Camera"><span class="material-symbols-outlined">videocam</span></button>
        <button id="toggle-screen" class="ctrl-btn" title="Screen Share"><span class="material-symbols-outlined">present_to_all</span></button>
        <button id="raise-hand" class="ctrl-btn" title="Raise Hand"><span class="material-symbols-outlined">front_hand</span></button>
        {% if live_role|lower == 'professor' %}
        <button id="open-mod" class="ctrl-btn" title="Moderation">
            <span class="material-symbols-outlined">shield_person</span>
        </button>
        {% endif %}
        {% if live_role|lower == 'professor' %}
        <button id="end-live" class="ctrl-btn" title="End Live" data-end-url="{% url 'Prolean:external_professor_live_end' session_id %}">
            <span class="material-symbols-outlined">stop_circle</span>
        </button>
        {% endif %}
        <button id="enable-sound" class="ctrl-btn" title="Enable Sound"><span class="material-symbols-outlined">volume_up</span></button>
        <button id="toggle-fullscreen" class="ctrl-btn" title="Fullscreen"><span class="material-symbols-outlined">fullscreen</span></button>
        <button id="cycle-right-mode" class="ctrl-btn" title="Switch Right Screen"><span class="material-symbols-outlined">swap_horiz</span></button>
        <button id="mode-screen" class="mode-btn" title="Screen only">Screen</button>
        <button id="mode-split" class="mode-btn active" title="Screen + Students">Split</button>
        <button id="mode-students" class="mode-btn" title="Students grid">Students</button>
        <button id="toggle-layout-panel" class="mode-btn" title="Customize layout">Layout</button>
        <div id="layout-panel" class="layout-panel">
            <label class="layout-item">
                <input id="swap-panes" type="checkbox" />
                <span>Swap</span>
            </label>
            <label class="layout-item">
                <span>Right</span>
                <input id="right-width" type="range" min="0" max="100" value="28" />
                <span id="right-width-value" class="value">28%</span>
            </label>
            <label class="layout-item">
                <span>Cols</span>
                <input id="grid-cols" type="range" min="1" max="4" value="2" />
                <span id="grid-cols-value" class="value">2</span>
            </label>
            <label class="layout-item">
                <span>Tile</span>
                <input id="tile-size" type="range" min="100" max="220" value="120" />
                <span id="tile-size-value" class="value">120</span>
            </label>
            <button id="reset-layout" class="mode-btn" type="button">Reset</button>
        </div>
        <div id="audio-sink" class="hidden"></div>
    </div>
</div>

<script src="https://download.agora.io/sdk/release/AgoraRTC_N.js"></script>
<script>
(() => {
  const uiText = {
    connecting: "{% if CURRENT_LANGUAGE == 'ar' %}جاري الاتصال{% elif CURRENT_LANGUAGE == 'en' %}Connecting{% else %}Connexion{% endif %}",
    configMissing: "{% if CURRENT_LANGUAGE == 'ar' %}إعدادات Agora مفقودة.{% elif CURRENT_LANGUAGE == 'en' %}Agora config missing.{% else %}Configuration Agora manquante.{% endif %}",
    noStudentsOnline: "{% if CURRENT_LANGUAGE == 'ar' %}لا يوجد طلاب متصلون{% elif CURRENT_LANGUAGE == 'en' %}No students online{% else %}Aucun étudiant en ligne{% endif %}",
    noOneSpeaking: "{% if CURRENT_LANGUAGE == 'ar' %}لا أحد يتكلم الآن{% elif CURRENT_LANGUAGE == 'en' %}No one speaking now{% else %}Personne ne parle maintenant{% endif %}",
    noRaisedHands: "{% if CURRENT_LANGUAGE == 'ar' %}لا توجد أيادي مرفوعة{% elif CURRENT_LANGUAGE == 'en' %}No raised hands{% else %}Aucune main levée{% endif %}",
    waitingStudents: "{% if CURRENT_LANGUAGE == 'ar' %}في انتظار انضمام الطلاب{% elif CURRENT_LANGUAGE == 'en' %}Waiting for students to join live{% else %}En attente des étudiants{% endif %}",
    rightScreen: "{% if CURRENT_LANGUAGE == 'ar' %}مشاركة شاشة الأستاذ (اضغط للتبديل){% elif CURRENT_LANGUAGE == 'en' %}Professor Screen Share (Tap to Switch){% else %}Partage écran prof (tap pour changer){% endif %}",
    rightSplit: "{% if CURRENT_LANGUAGE == 'ar' %}مشاركة الشاشة + الطلاب (اضغط للتبديل){% elif CURRENT_LANGUAGE == 'en' %}Professor Screen Share + Students (Tap to Switch){% else %}Partage écran + étudiants (tap pour changer){% endif %}",
    rightStudents: "{% if CURRENT_LANGUAGE == 'ar' %}شبكة الطلاب (اضغط للتبديل){% elif CURRENT_LANGUAGE == 'en' %}Students Grid (Tap to Switch){% else %}Grille étudiants (tap pour changer){% endif %}",
    noScreenShare: "{% if CURRENT_LANGUAGE == 'ar' %}لا توجد مشاركة شاشة{% elif CURRENT_LANGUAGE == 'en' %}No Screen Share{% else %}Aucun partage écran{% endif %}",
    screenShareLabel: "{% if CURRENT_LANGUAGE == 'ar' %}مشاركة الشاشة{% elif CURRENT_LANGUAGE == 'en' %}Screen Share{% else %}Partage écran{% endif %}",
    profScreenSharing: "{% if CURRENT_LANGUAGE == 'ar' %}مشاركة شاشة الأستاذ{% elif CURRENT_LANGUAGE == 'en' %}The prof screen sharing{% else %}Partage écran du prof{% endif %}",
  };

  const agoraAppId = "{{ agora_app_id|escapejs }}";
  const agoraChannel = "{{ agora_channel|escapejs }}";
  const agoraToken = "{{ agora_token|escapejs }}";
  const agoraScreenToken = "{{ agora_screen_token|default:''|escapejs }}";
  const agoraUid = Number("{{ agora_uid|escapejs }}");
  const professorUidHint = Number("{{ professor_uid_hint|default:'1'|escapejs }}") || 1;
  const liveRole = String("{{ live_role|escapejs }}").toLowerCase();
  const isProfessor = liveRole === "professor";
  const selfName = "{{ user.get_full_name|default:user.username|escapejs }}";
  const professorNameHint = "{{ professor_name_hint|default:'Professor'|escapejs }}";

  const roomRoot = document.getElementById("room-root");
  const leftPane = document.getElementById("left-pane");
  const paneResizer = document.getElementById("pane-resizer");
  const rightPane = document.getElementById("right-pane");
  const leftHost = document.getElementById("left-host");
  const rightHost = document.getElementById("right-host");
  const rightTitle = document.getElementById("right-title");
  const connBadge = document.getElementById("conn-badge");
  const connError = document.getElementById("conn-error");
  const presenceBoard = document.getElementById("presence-board");
  const onlineList = document.getElementById("online-list");
  const speakingList = document.getElementById("speaking-list");
  const raisedList = document.getElementById("raised-list");
  const onlineCount = document.getElementById("online-count");
  const speakingCount = document.getElementById("speaking-count");
  const raisedCount = document.getElementById("raised-count");
  const btnAudio = document.getElementById("toggle-audio");
  const btnVideo = document.getElementById("toggle-video");
  const btnScreen = document.getElementById("toggle-screen");
  const btnRaiseHand = document.getElementById("raise-hand");
  const btnEndLive = document.getElementById("end-live");
  const btnSound = document.getElementById("enable-sound");
  const btnFullscreen = document.getElementById("toggle-fullscreen");
  const btnCycleMode = document.getElementById("cycle-right-mode");
  const btnModeScreen = document.getElementById("mode-screen");
  const btnModeSplit = document.getElementById("mode-split");
  const btnModeStudents = document.getElementById("mode-students");
  const btnToggleLayoutPanel = document.getElementById("toggle-layout-panel");
  const layoutPanel = document.getElementById("layout-panel");
  const btnOpenMod = document.getElementById("open-mod");
  const modDrawer = document.getElementById("mod-drawer");
  const modBody = document.getElementById("mod-body");
  const btnCloseMod = document.getElementById("close-mod");
  const btnMuteAll = document.getElementById("mute-all");
  const btnUnmuteAll = document.getElementById("unmute-all");
  const swapPanesInput = document.getElementById("swap-panes");
  const rightWidthInput = document.getElementById("right-width");
  const gridColsInput = document.getElementById("grid-cols");
  const tileSizeInput = document.getElementById("tile-size");
  const rightWidthValue = document.getElementById("right-width-value");
  const gridColsValue = document.getElementById("grid-cols-value");
  const tileSizeValue = document.getElementById("tile-size-value");
  const btnResetLayout = document.getElementById("reset-layout");

  let themeObserver = null;
  let isResizing = false;
  let rightMode = 1;
  const SCREEN_UID_OFFSET = 1000;

  const participantLabels = new Map();
  const videoTracks = new Map();
  const audioTracks = new Map();
  const speakingIds = new Set();
  const raisedHands = new Set();
  const statsByUid = new Map();
  let previousSpeaking = new Set();
  let professorIdentity = String(professorUidHint);
  let localMicTrack = null;
  let localCamTrack = null;
  let localScreenTrack = null;
  let screenClient = null;
  let dataStreamId = null;
  let hasJoined = false;
  let exiting = false;
  let warnedNoDataStream = false;

  const mainClient = AgoraRTC.createClient({ mode: "rtc", codec: "vp8" });

  const layoutStorageKey = "prolean_live_layout_v1";
  const defaultLayoutPrefs = { swapped: false, rightWidth: 28, gridCols: 2, tileMinHeight: 120 };
  let layoutPrefs = { ...defaultLayoutPrefs };

  const normalizeSource = (source) => String(source || "camera");
  const isScreenShare = (source) => normalizeSource(source).startsWith("screen_share");
  const initials = (label) => (String(label || "U").trim()[0] || "U").toUpperCase();

  const setStatus = (txt, kind = "warn") => {
    const style = {
      ok: "bg-green-500/15 text-green-300",
      warn: "bg-amber-500/15 text-amber-300",
      err: "bg-red-500/15 text-red-300",
    }[kind] || "bg-amber-500/15 text-amber-300";
    connBadge.className = `px-2 py-1 rounded text-[10px] font-black uppercase tracking-wider ${style}`;
    connBadge.textContent = txt;
  };
  const showError = (message) => {
    connError.textContent = message;
    connError.classList.remove("hidden");
  };

  const detectUiTheme = () => {
    const body = document.body;
    const root = document.documentElement;
    const bodyTheme = String(body?.dataset?.theme || body?.getAttribute("data-bs-theme") || "").toLowerCase();
    const rootTheme = String(root?.dataset?.theme || root?.getAttribute("data-bs-theme") || "").toLowerCase();
    const classDark = body?.classList?.contains("dark") || root?.classList?.contains("dark");
    if (bodyTheme === "light" || rootTheme === "light") return "light";
    if (bodyTheme === "dark" || rootTheme === "dark" || classDark) return "dark";
    return window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light";
  };
  const applyUiTheme = () => { roomRoot.dataset.uiTheme = detectUiTheme(); };
  const bindThemeSync = () => {
    applyUiTheme();
    const media = window.matchMedia("(prefers-color-scheme: dark)");
    if (typeof media.addEventListener === "function") media.addEventListener("change", applyUiTheme);
    themeObserver = new MutationObserver(applyUiTheme);
    if (document.body) themeObserver.observe(document.body, { attributes: true, attributeFilter: ["class", "data-theme", "data-bs-theme"] });
    themeObserver.observe(document.documentElement, { attributes: true, attributeFilter: ["class", "data-theme", "data-bs-theme"] });
  };

  const applyLayoutPrefs = () => {
    roomRoot.classList.toggle("swapped", !!layoutPrefs.swapped);
    roomRoot.style.setProperty("--right-pane-width", `${layoutPrefs.rightWidth}%`);
    roomRoot.style.setProperty("--student-grid-cols", String(layoutPrefs.gridCols));
    roomRoot.style.setProperty("--student-tile-min-h", `${layoutPrefs.tileMinHeight}px`);
    rightWidthValue.textContent = `${layoutPrefs.rightWidth}%`;
    gridColsValue.textContent = String(layoutPrefs.gridCols);
    tileSizeValue.textContent = String(layoutPrefs.tileMinHeight);
    swapPanesInput.checked = !!layoutPrefs.swapped;
    rightWidthInput.value = String(layoutPrefs.rightWidth);
    gridColsInput.value = String(layoutPrefs.gridCols);
    tileSizeInput.value = String(layoutPrefs.tileMinHeight);
  };
  const persistLayoutPrefs = () => { try { localStorage.setItem(layoutStorageKey, JSON.stringify(layoutPrefs)); } catch (_) {} };
  const loadLayoutPrefs = () => {
    try {
      const raw = localStorage.getItem(layoutStorageKey);
      if (!raw) return;
      const parsed = JSON.parse(raw);
      layoutPrefs = {
        swapped: !!parsed.swapped,
        rightWidth: Math.min(100, Math.max(0, Number(parsed.rightWidth || 28))),
        gridCols: Math.min(4, Math.max(1, Number(parsed.gridCols || 2))),
        tileMinHeight: Math.min(220, Math.max(100, Number(parsed.tileMinHeight || 120))),
      };
    } catch (_) {}
  };

  const syncControlStates = () => {
    const micOn = !!localMicTrack && !localMicTrack.muted;
    const camOn = !!localCamTrack && !localCamTrack.muted;
    btnAudio.dataset.state = micOn ? "on" : "off";
    btnVideo.dataset.state = camOn ? "on" : "off";
    btnAudio.innerHTML = `<span class="material-symbols-outlined">${micOn ? "mic" : "mic_off"}</span>`;
    btnVideo.innerHTML = `<span class="material-symbols-outlined">${camOn ? "videocam" : "videocam_off"}</span>`;
  };

  const addVideoTrack = (identity, track, source, isLocal = false) => {
    const key = `${identity}:${source}`;
    videoTracks.set(key, { track, identity: String(identity), source: normalizeSource(source), isLocal });
  };
  const removeVideoTracksByIdentity = (identity) => {
    for (const [key, item] of videoTracks.entries()) {
      if (String(item.identity) === String(identity)) {
        try { item.track.stop(); } catch (_) {}
        videoTracks.delete(key);
      }
    }
  };
  const pickTrack = (identity, wantScreen = false) => {
    const id = String(identity);
    const entries = Array.from(videoTracks.values()).filter((v) => String(v.identity) === id && (wantScreen ? isScreenShare(v.source) : !isScreenShare(v.source)));
    return entries.length ? entries[entries.length - 1] : null;
  };

  const resolveProfessorScreenIdentity = () => String(Number(professorUidHint) + SCREEN_UID_OFFSET);
  const resolveProfessorIdentity = () => {
    if (isProfessor) return String(agoraUid);
    if (participantLabels.has(String(professorUidHint))) return String(professorUidHint);
    if (participantLabels.has("1")) return "1";
    return String(professorUidHint);
  };
  const isProfessorLike = (identity) => {
    const id = String(identity);
    if (id === String(resolveProfessorIdentity())) return true;
    if (id === resolveProfessorScreenIdentity()) return true;
    if (id === String(Number(resolveProfessorIdentity()) + SCREEN_UID_OFFSET)) return true;
    return false;
  };

  const renderAvatar = (host, label) => {
    host.innerHTML = "";
    const wrap = document.createElement("div");
    wrap.className = "avatar-host";
    const badge = document.createElement("div");
    badge.className = "avatar-badge";
    badge.textContent = initials(label);
    wrap.appendChild(badge);
    const footer = document.createElement("div");
    footer.className = "student-label";
    footer.textContent = label;
    wrap.appendChild(footer);
    host.appendChild(wrap);
  };
  const renderTrack = (host, data, label) => {
    host.innerHTML = "";
    const media = document.createElement("div");
    media.className = "agora-video-slot";
    const fit = isScreenShare(data?.source) ? "contain" : "cover";
    if (fit === "contain") media.classList.add("fit-contain");
    host.appendChild(media);
    data.track.play(media, { fit });
    const wm = document.createElement("div");
    wm.className = "watermark";
    wm.innerHTML = `
      <div class="wm-chip">
        <div>${String(label || "").slice(0, 80)}</div>
        <div class="small">ID ${String(data?.identity || "")}</div>
      </div>
      <div class="wm-chip right">
        <div class="wm-ts">--:--:--</div>
        <div class="small">prolean</div>
      </div>
    `;
    media.appendChild(wm);
    const footer = document.createElement("div");
    footer.className = "student-label";
    footer.textContent = label;
    host.appendChild(footer);
  };

  const markPaneBorders = () => {
    leftPane.classList.remove("speaker-border", "raised-border");
    rightPane.classList.remove("speaker-border", "raised-border");
    const prof = resolveProfessorIdentity();
    if (speakingIds.has(prof)) leftPane.classList.add("speaker-border");
    if (raisedHands.has(prof)) leftPane.classList.add("raised-border");
    const studentIds = Array.from(participantLabels.keys()).filter((id) => !isProfessorLike(id));
    if (studentIds.some((id) => speakingIds.has(id))) rightPane.classList.add("speaker-border");
    if (studentIds.some((id) => raisedHands.has(id))) rightPane.classList.add("raised-border");
  };
  const identityLabel = (id) => participantLabels.get(String(id)) || `Student ${id}`;
  const paintPresenceList = (host, ids, type, emptyText) => {
    host.innerHTML = "";
    if (!ids.length) {
      const empty = document.createElement("span");
      empty.className = "presence-empty";
      empty.textContent = emptyText;
      host.appendChild(empty);
      return;
    }
    ids.forEach((id) => {
      const chip = document.createElement("span");
      chip.className = `presence-chip ${type}`;
      chip.textContent = identityLabel(id);
      host.appendChild(chip);
    });
  };
  const refreshPresenceBoard = () => {
    if (!presenceBoard || !isProfessor) return;
    const studentIds = getStudentEntries().map((s) => s.id);
    const speakingStudentIds = studentIds.filter((id) => speakingIds.has(id));
    const raisedStudentIds = studentIds.filter((id) => raisedHands.has(id));
    onlineCount.textContent = String(studentIds.length);
    speakingCount.textContent = String(speakingStudentIds.length);
    raisedCount.textContent = String(raisedStudentIds.length);
    paintPresenceList(onlineList, studentIds, "online", uiText.noStudentsOnline);
    paintPresenceList(speakingList, speakingStudentIds, "speaking", uiText.noOneSpeaking);
    paintPresenceList(raisedList, raisedStudentIds, "hand", uiText.noRaisedHands);
  };

  const getOrInitStat = (uid) => {
    const id = String(uid);
    let item = statsByUid.get(id);
    if (!item) {
      item = {
        uid: id,
        name: identityLabel(id),
        online: false,
        joinedAt: null,
        watchMs: 0,
        speaks: 0,
        hands: 0,
        speakingMs: 0,
        speakingStartedAt: null,
        handRaisedMs: 0,
        handRaisedStartedAt: null,
      };
      statsByUid.set(id, item);
    }
    const label = participantLabels.get(id);
    if (label) item.name = label;
    return item;
  };
  const estimateWatchMs = (item) => {
    const base = Number(item.watchMs || 0);
    if (item.online && item.joinedAt) return base + (Date.now() - Number(item.joinedAt));
    return base;
  };
  const estimateSpeakingMs = (item) => {
    const base = Number(item.speakingMs || 0);
    if (item.speakingStartedAt) return base + (Date.now() - Number(item.speakingStartedAt));
    return base;
  };
  const estimateHandRaisedMs = (item) => {
    const base = Number(item.handRaisedMs || 0);
    if (item.handRaisedStartedAt) return base + (Date.now() - Number(item.handRaisedStartedAt));
    return base;
  };
  const computeEngagement = (item) => {
    const mins = estimateWatchMs(item) / 60000;
    const speaks = Number(item.speaks || 0);
    const hands = Number(item.hands || 0);
    const speakMins = estimateSpeakingMs(item) / 60000;
    const handMins = estimateHandRaisedMs(item) / 60000;
    return Math.max(0, Math.round(mins * 1 + speakMins * 2 + handMins * 1.5 + speaks * 0.2 + hands * 0.2));
  };
  const renderLeftPane = () => {
    professorIdentity = resolveProfessorIdentity();
    const label = participantLabels.get(professorIdentity) || professorNameHint || "Professor";
    const profCam = pickTrack(professorIdentity, false);
    if (profCam) renderTrack(leftHost, profCam, label);
    else renderAvatar(leftHost, label);
  };
  const getStudentEntries = () => {
    const rows = [];
    for (const [id, name] of participantLabels.entries()) {
      if (isProfessorLike(id)) continue;
      rows.push({ id, name });
    }
    return rows;
  };
  const renderStudentsInto = (host, compact = false) => {
    host.innerHTML = "";
    const students = getStudentEntries();
    if (!students.length) {
      const empty = document.createElement("div");
      empty.className = "empty-students";
      empty.textContent = uiText.waitingStudents;
      host.appendChild(empty);
      return;
    }
    const grid = document.createElement("div");
    grid.className = "student-grid";
    if (compact) grid.classList.add("compact");
    const total = students.length;
    const cols = compact ? Math.min(2, Math.ceil(Math.sqrt(total))) : Math.ceil(Math.sqrt(total));
    const rows = Math.ceil(total / Math.max(cols, 1));
    grid.style.gridTemplateColumns = `repeat(${Math.max(cols, 1)}, minmax(0, 1fr))`;
    grid.style.gridTemplateRows = `repeat(${Math.max(rows, 1)}, minmax(0, 1fr))`;
    grid.style.gridAutoRows = "minmax(0, 1fr)";
    for (const student of students) {
      const card = document.createElement("div");
      card.className = "student-card";
      card.dataset.identity = String(student.id);
      card.style.minHeight = "0";
      if (raisedHands.has(student.id)) card.classList.add("raised-border");
      else if (speakingIds.has(student.id)) card.classList.add("speaker-border");
      const cam = pickTrack(student.id, false);
      if (cam) {
        const media = document.createElement("div");
        media.className = "agora-video-slot";
        card.appendChild(media);
        cam.track.play(media, { fit: "cover" });
        const wm = document.createElement("div");
        wm.className = "watermark";
        wm.innerHTML = `
          <div class="wm-chip">
            <div>${String(student.name || "").slice(0, 80)}</div>
            <div class="small">ID ${String(student.id || "")}</div>
          </div>
          <div class="wm-chip right">
            <div class="wm-ts">--:--:--</div>
            <div class="small">prolean</div>
          </div>
        `;
        media.appendChild(wm);
      } else {
        const av = document.createElement("div");
        av.className = "avatar-host";
        const badge = document.createElement("div");
        badge.className = "avatar-badge";
        badge.textContent = initials(student.name);
        av.appendChild(badge);
        card.appendChild(av);
      }
      const footer = document.createElement("div");
      footer.className = "student-label";
      footer.textContent = student.name;
      card.appendChild(footer);
      grid.appendChild(card);
    }
    host.appendChild(grid);
  };

  const syncStudentCardBorders = () => {
    const cards = rightHost.querySelectorAll(".student-card[data-identity]");
    cards.forEach((card) => {
      const id = String(card.dataset.identity || "");
      if (!id) return;
      card.classList.remove("speaker-border", "raised-border");
      if (raisedHands.has(id)) card.classList.add("raised-border");
      else if (speakingIds.has(id)) card.classList.add("speaker-border");
    });
  };
  const syncModeButtons = () => {
    btnModeScreen.classList.toggle("active", rightMode === 0);
    btnModeSplit.classList.toggle("active", rightMode === 1);
    btnModeStudents.classList.toggle("active", rightMode === 2);
  };
  const renderRightPane = () => {
    if (rightMode === 0) {
      rightTitle.textContent = uiText.rightScreen;
      const screen = pickTrack(resolveProfessorScreenIdentity(), true);
      if (screen) renderTrack(rightHost, screen, uiText.screenShareLabel);
      else renderAvatar(rightHost, uiText.noScreenShare);
    } else if (rightMode === 1) {
      rightTitle.textContent = uiText.rightSplit;
      rightHost.innerHTML = "";
      const split = document.createElement("div");
      split.className = "right-split";
      const top = document.createElement("div");
      top.className = "right-split-top";
      const bottom = document.createElement("div");
      bottom.className = "right-split-bottom";
      const screen = pickTrack(resolveProfessorScreenIdentity(), true);
      if (screen) renderTrack(top, screen, uiText.profScreenSharing);
      else renderAvatar(top, uiText.noScreenShare);
      renderStudentsInto(bottom, true);
      split.appendChild(top);
      split.appendChild(bottom);
      rightHost.appendChild(split);
    } else {
      rightTitle.textContent = uiText.rightStudents;
      renderStudentsInto(rightHost, false);
    }
    syncModeButtons();
    markPaneBorders();
    syncStudentCardBorders();
  };
  const rerender = () => { renderLeftPane(); renderRightPane(); refreshPresenceBoard(); };

  const refreshWatermarkTimestamps = () => {
    const now = new Date();
    const ts = now.toLocaleString();
    document.querySelectorAll(".wm-ts").forEach((el) => { el.textContent = ts; });
  };

  const openModeration = () => {
    if (!isProfessor || !modDrawer) return;
    modDrawer.classList.add("open");
    renderModerationDrawer();
  };
  const closeModeration = () => {
    if (!modDrawer) return;
    modDrawer.classList.remove("open");
  };

  const loadScript = (src) => new Promise((resolve, reject) => {
    const el = document.createElement("script");
    el.src = src;
    el.async = true;
    el.onload = () => resolve(true);
    el.onerror = () => reject(new Error(`Failed to load ${src}`));
    document.head.appendChild(el);
  });

  const startPhoneDetection = async () => {
    if (isProfessor) return;
    if (!localCamTrack || typeof localCamTrack.getMediaStreamTrack !== "function") return;
    const track = localCamTrack.getMediaStreamTrack();
    if (!track) return;

    let model = null;
    try {
      if (!window.tf) {
        await loadScript("https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.20.0/dist/tf.min.js");
      }
      if (!window.cocoSsd) {
        await loadScript("https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.3/dist/coco-ssd.min.js");
      }
      model = await window.cocoSsd.load();
    } catch (e) {
      await logEvent("phone_detection_unavailable", { error: String(e?.message || e || "") });
      return;
    }

    const video = document.createElement("video");
    video.muted = true;
    video.playsInline = true;
    video.autoplay = true;
    video.style.position = "fixed";
    video.style.left = "-9999px";
    video.style.top = "-9999px";
    video.width = 320;
    video.height = 240;
    video.srcObject = new MediaStream([track]);
    document.body.appendChild(video);
    try { await video.play(); } catch (_) {}

    const canvas = document.createElement("canvas");
    canvas.width = 320;
    canvas.height = 240;
    const ctx = canvas.getContext("2d", { willReadFrequently: true });

    let streak = 0;
    const tick = async () => {
      if (exiting || !hasJoined) return;
      if (!ctx || video.readyState < 2) return;
      try {
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        const preds = await model.detect(canvas);
        const found = (preds || []).some((p) => String(p.class || "").toLowerCase() === "cell phone" && Number(p.score || 0) >= 0.55);
        streak = found ? Math.min(6, streak + 1) : Math.max(0, streak - 1);
        if (streak >= 3) {
          streak = 0;
          showError("Security warning: phone-like object detected in your camera. Recording is prohibited.");
          await logEvent("phone_detected", { confidence: ">=0.55" });
          await sendRoomSignal({ t: "sec", kind: "phone_detected", uid: String(agoraUid) });
        }
      } catch (_) {}
    };

    setInterval(tick, 5000);
  };

  const getCsrfToken = () => {
    try {
      const match = document.cookie.match(/(?:^|; )csrftoken=([^;]+)/);
      return match ? decodeURIComponent(match[1]) : "";
    } catch (_) {
      return "";
    }
  };

  const decodeStreamMessage = (message) => {
    if (typeof message === "string") return message;
    try {
      if (message instanceof ArrayBuffer) return new TextDecoder().decode(new Uint8Array(message));
      if (ArrayBuffer.isView(message)) return new TextDecoder().decode(message);
    } catch (_) {}
    try {
      return new TextDecoder().decode(message);
    } catch (_) {}
    return "";
  };

  const forceExit = async (reason) => {
    if (exiting) return;
    exiting = true;
    try { await stopScreenShare(); } catch (_) {}
    try { if (localMicTrack) localMicTrack.close(); } catch (_) {}
    try { if (localCamTrack) localCamTrack.close(); } catch (_) {}
    try { await mainClient.leave(); } catch (_) {}
    const dest = isProfessor
      ? `${location.origin}{% url 'Prolean:professor_dashboard' %}?session_id={{ session_id }}`
      : `{% url 'Prolean:dashboard' %}`;
    if (reason) {
      try { sessionStorage.setItem("prolean_live_exit_reason", String(reason)); } catch (_) {}
    }
    window.location.href = dest;
  };

  const ensureDataStream = async () => {
    if (!mainClient || !hasJoined) return null;
    if (dataStreamId !== null) return dataStreamId;
    try {
      dataStreamId = await mainClient.createDataStream({ reliable: true, ordered: true });
    } catch (_) {
      dataStreamId = null;
    }
    return dataStreamId;
  };

  const sendRoomSignal = async (payload) => {
    if (!mainClient || !hasJoined) return;
    await ensureDataStream();
    if (dataStreamId === null) {
      if (!warnedNoDataStream) {
        warnedNoDataStream = true;
        showError("Live sync is limited on this device/browser (hand-raise and live-end signals may not propagate).");
      }
      return;
    }
    try {
      const raw = JSON.stringify(payload || {});
      if (typeof mainClient.sendStreamMessage === "function") {
        await mainClient.sendStreamMessage(dataStreamId, raw);
      }
    } catch (_) {}
  };

  const eventUrl = "{% url 'Prolean:external_live_event_log' session_id %}";
  const logEvent = async (eventType, payload = {}, targetUserId = null) => {
    try {
      await fetch(eventUrl, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": getCsrfToken(),
        },
        body: JSON.stringify({ event_type: String(eventType || ""), payload: payload || {}, target_user_id: targetUserId }),
        credentials: "same-origin",
      });
    } catch (_) {}
  };

  const uidToUserId = (uid) => {
    const n = Number(uid);
    if (!Number.isFinite(n)) return null;
    if (n >= 10000) return Math.max(0, Math.floor(n - 10000));
    return null;
  };

  const setMicLocked = (locked) => {
    btnAudio.dataset.locked = locked ? "1" : "0";
    btnAudio.classList.toggle("opacity-50", !!locked);
    btnAudio.classList.toggle("cursor-not-allowed", !!locked);
  };
  const isMicLocked = () => String(btnAudio.dataset.locked || "0") === "1";

  const subscribeUser = async (user, mediaType) => {
    await mainClient.subscribe(user, mediaType);
    const uid = String(user.uid);
    if (!participantLabels.has(uid)) participantLabels.set(uid, `Student ${uid}`);
    if (mediaType === "video" && user.videoTrack) {
      const source = Number(user.uid) === (Number(professorUidHint) + SCREEN_UID_OFFSET) ? "screen_share" : "camera";
      addVideoTrack(uid, user.videoTrack, source, false);
      rerender();
    }
    if (mediaType === "audio" && user.audioTrack) {
      audioTracks.set(uid, user.audioTrack);
      try { user.audioTrack.play(); } catch (_) {}
    }
  };

  const renderModerationDrawer = () => {
    if (!isProfessor || !modDrawer || !modBody) return;
    const students = getStudentEntries();
    modBody.innerHTML = "";
    if (!students.length) {
      const empty = document.createElement("div");
      empty.className = "text-xs font-black opacity-70";
      empty.textContent = "No students connected.";
      modBody.appendChild(empty);
      return;
    }
    students.forEach((s) => {
      const row = document.createElement("div");
      row.className = "mod-row";
      const left = document.createElement("div");
      left.className = "min-w-0";
      const name = document.createElement("div");
      name.className = "name";
      name.textContent = s.name || `Student ${s.id}`;
      const meta = document.createElement("div");
      meta.className = "meta";
      meta.textContent = `ID ${s.id}`;
      left.appendChild(name);
      left.appendChild(meta);

      const btns = document.createElement("div");
      btns.className = "btns";

      const muteBtn = document.createElement("button");
      muteBtn.type = "button";
      muteBtn.className = "mod-mini";
      muteBtn.title = "Force mute";
      muteBtn.innerHTML = '<span class="material-symbols-outlined">mic_off</span>';
      muteBtn.addEventListener("click", async () => {
        const targetUserId = uidToUserId(s.id);
        if (targetUserId) {
          const muteUrl = "{% url 'Prolean:external_live_mute_user' session_id %}";
          try {
            await fetch(muteUrl, {
              method: "POST",
              headers: {
                "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8",
                "X-CSRFToken": getCsrfToken(),
                "Accept": "application/json",
              },
              body: `user_id=${encodeURIComponent(String(targetUserId))}`,
              credentials: "same-origin",
            });
          } catch (_) {}
        }
        await sendRoomSignal({ t: "force_mute", uid: String(s.id), locked: true });
        await logEvent("moderate_force_mute", { target_uid: String(s.id) }, targetUserId);
      });

      const unmuteBtn = document.createElement("button");
      unmuteBtn.type = "button";
      unmuteBtn.className = "mod-mini";
      unmuteBtn.title = "Unlock mic";
      unmuteBtn.innerHTML = '<span class="material-symbols-outlined">mic</span>';
      unmuteBtn.addEventListener("click", async () => {
        const targetUserId = uidToUserId(s.id);
        if (targetUserId) {
          const unmuteUrl = "{% url 'Prolean:external_live_unmute_user' session_id %}";
          try {
            await fetch(unmuteUrl, {
              method: "POST",
              headers: {
                "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8",
                "X-CSRFToken": getCsrfToken(),
                "Accept": "application/json",
              },
              body: `user_id=${encodeURIComponent(String(targetUserId))}`,
              credentials: "same-origin",
            });
          } catch (_) {}
        }
        await sendRoomSignal({ t: "force_mute", uid: String(s.id), locked: false });
        await logEvent("moderate_unmute_user", { target_uid: String(s.id) }, targetUserId);
      });

      const banBtn = document.createElement("button");
      banBtn.type = "button";
      banBtn.className = "mod-mini danger";
      banBtn.title = "Ban (kick)";
      banBtn.innerHTML = '<span class="material-symbols-outlined">person_remove</span>';
      banBtn.addEventListener("click", async () => {
        const targetUserId = uidToUserId(s.id);
        if (!targetUserId) {
          showError("Cannot ban this participant (missing local user mapping).");
          return;
        }
        const banUrl = "{% url 'Prolean:external_live_ban_user' session_id %}";
        try {
          await fetch(banUrl, {
            method: "POST",
            headers: {
              "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8",
              "X-CSRFToken": getCsrfToken(),
              "Accept": "application/json",
            },
            body: `user_id=${encodeURIComponent(String(targetUserId))}`,
            credentials: "same-origin",
          });
        } catch (_) {}
        await sendRoomSignal({ t: "ban", uid: String(s.id) });
        await logEvent("moderate_ban", { target_uid: String(s.id) }, targetUserId);
      });

      btns.appendChild(muteBtn);
      btns.appendChild(unmuteBtn);
      btns.appendChild(banBtn);

      row.appendChild(left);
      row.appendChild(btns);
      modBody.appendChild(row);
    });
  };

  const connectAgora = async () => {
    if (!agoraAppId || !agoraChannel || !agoraToken) {
      setStatus("Config Error", "err");
      showError(uiText.configMissing);
      return;
    }
    setStatus(uiText.connecting, "warn");
    try {
      participantLabels.set(String(agoraUid), selfName || (isProfessor ? "Professor" : "You"));
      await mainClient.join(agoraAppId, agoraChannel, agoraToken, agoraUid);
      hasJoined = true;
      try {
        dataStreamId = await mainClient.createDataStream({ reliable: true, ordered: true });
      } catch (_) {
        dataStreamId = null;
      }
      mainClient.enableAudioVolumeIndicator();
      const tracksToPublish = [];
      let mediaWarning = "";
      try {
        localMicTrack = await AgoraRTC.createMicrophoneAudioTrack();
        tracksToPublish.push(localMicTrack);
      } catch (micErr) {
        localMicTrack = null;
        mediaWarning = "Microphone is unavailable. You joined without mic.";
      }
      try {
        localCamTrack = await AgoraRTC.createCameraVideoTrack();
        tracksToPublish.push(localCamTrack);
        addVideoTrack(String(agoraUid), localCamTrack, "camera", true);
      } catch (camErr) {
        localCamTrack = null;
        const camText = String(camErr?.message || camErr || "").toLowerCase();
        if (camText.includes("notreadable")) {
          mediaWarning = "Camera is busy or blocked by another app. You joined without camera.";
        } else {
          mediaWarning = "Camera is unavailable. You joined without camera.";
        }
      }
      if (!tracksToPublish.length) {
        throw new Error("Unable to access microphone and camera on this device.");
      }
      await mainClient.publish(tracksToPublish);
      setStatus("Connected", "ok");
      if (mediaWarning) {
        showError(mediaWarning);
      }
      syncControlStates();
      rerender();
      try {
        const helloName = selfName || (isProfessor ? (professorNameHint || "Professor") : "You");
        await sendRoomSignal({ t: "hello", uid: String(agoraUid), name: helloName });
      } catch (_) {}
      try {
        document.addEventListener("contextmenu", (e) => { e.preventDefault(); }, { capture: true });
        document.addEventListener("keydown", (e) => {
          const key = String(e.key || "").toLowerCase();
          if (key === "printscreen") logEvent("screenshot_key", {});
        });
      } catch (_) {}
      startPhoneDetection();
      try { pollStatus(); } catch (_) {}

      if (!isProfessor) {
        btnScreen.disabled = true;
        btnScreen.classList.add("opacity-50", "cursor-not-allowed");
      } else {
        btnToggleLayoutPanel.classList.add("hidden");
      }
    } catch (err) {
      setStatus("Connection Failed", "err");
      showError(`Agora connection failed: ${err?.message || err}`);
    }
  };

  mainClient.on("stream-message", async (uid, _streamId, message) => {
    let payload = null;
    try {
      const txt = decodeStreamMessage(message);
      payload = JSON.parse(txt);
    } catch (_) {
      payload = null;
    }
    if (!payload || typeof payload !== "object") return;
    const type = String(payload.t || payload.type || "");
    if (type === "hello") {
      const who = String(payload.uid || uid || "");
      const name = String(payload.name || "").trim();
      if (who && name) participantLabels.set(who, name.slice(0, 80));
      if (isProfessor && who && !isProfessorLike(who)) {
        const stat = getOrInitStat(who);
        if (name) stat.name = name.slice(0, 80);
      }
      rerender();
      return;
    }
    if (type === "hand") {
      const who = String(payload.uid || uid || "");
      const raised = !!payload.raised;
      const wasRaised = raisedHands.has(who);
      if (raised) raisedHands.add(who);
      else raisedHands.delete(who);
      if (isProfessor && raised && !wasRaised && who && !isProfessorLike(who)) {
        const stat = getOrInitStat(who);
        stat.hands = Number(stat.hands || 0) + 1;
        if (!stat.handRaisedStartedAt) stat.handRaisedStartedAt = Date.now();
      }
      if (isProfessor && !raised && wasRaised && who && !isProfessorLike(who)) {
        const stat = getOrInitStat(who);
        if (stat.handRaisedStartedAt) {
          stat.handRaisedMs = Number(stat.handRaisedMs || 0) + (Date.now() - Number(stat.handRaisedStartedAt));
          stat.handRaisedStartedAt = null;
        }
      }
      markPaneBorders();
      syncStudentCardBorders();
      refreshPresenceBoard();
      return;
    }
    if (type === "force_mute") {
      const targetUid = String(payload.uid || payload.target_uid || "");
      const locked = payload.locked !== false;
      if (targetUid && targetUid === String(agoraUid)) {
        if (locked) {
          if (localMicTrack) {
            try { await localMicTrack.setMuted(true); } catch (_) {}
          }
          setMicLocked(true);
        } else {
          setMicLocked(false);
        }
        syncControlStates();
        showError(locked ? "Your microphone was muted by the professor." : "Microphone lock was removed.");
        logEvent(locked ? "forced_mute" : "unmute_signal", { locked: !!locked });
      }
      return;
    }
    if (type === "force_mute_all") {
      if (!isProfessor) {
        const locked = payload.locked !== false;
        if (locked) {
          if (localMicTrack) {
            try { await localMicTrack.setMuted(true); } catch (_) {}
          }
          setMicLocked(true);
        } else {
          setMicLocked(false);
        }
        syncControlStates();
        showError(locked ? "All microphones were muted by the professor." : "Microphone lock was removed.");
        logEvent(locked ? "forced_mute_all" : "unmute_all_signal", {});
      }
      return;
    }
    if (type === "ban") {
      const targetUid = String(payload.uid || payload.target_uid || "");
      if (targetUid && targetUid === String(agoraUid) && !isProfessor) {
        showError("You were removed from this live session.");
        logEvent("banned_client_signal", {});
        forceExit("banned");
      }
      return;
    }
    if (type === "sec") {
      if (isProfessor) {
        const who = String(payload.uid || uid || "");
        const kind = String(payload.kind || "security");
        const label = who ? (participantLabels.get(who) || `Student ${who}`) : "Student";
        showError(`Security alert: ${label} (${kind})`);
        await logEvent("security_alert", { kind, uid: who }, uidToUserId(who));
      }
      return;
    }
    if (type === "live_end") {
      forceExit("live_end_signal");
    }
  });

  mainClient.on("user-published", async (user, mediaType) => {
    await subscribeUser(user, mediaType);
  });
  mainClient.on("user-joined", (user) => {
    const uid = String(user.uid);
    if (!participantLabels.has(uid)) participantLabels.set(uid, `Student ${uid}`);
    if (isProfessor && !isProfessorLike(uid)) {
      const stat = getOrInitStat(uid);
      stat.online = true;
      if (!stat.joinedAt) stat.joinedAt = Date.now();
    }
    rerender();
    renderModerationDrawer();
  });
  mainClient.on("user-unpublished", (user, mediaType) => {
    const uid = String(user.uid);
    if (mediaType === "video") {
      removeVideoTracksByIdentity(uid);
    }
    if (mediaType === "audio") audioTracks.delete(uid);
    rerender();
  });
  mainClient.on("user-left", (user) => {
    const uid = String(user.uid);
    if (isProfessor && !isProfessorLike(uid)) {
      const stat = getOrInitStat(uid);
      stat.online = false;
      if (stat.joinedAt) {
        stat.watchMs = Number(stat.watchMs || 0) + (Date.now() - Number(stat.joinedAt));
        stat.joinedAt = null;
      }
      if (stat.speakingStartedAt) {
        stat.speakingMs = Number(stat.speakingMs || 0) + (Date.now() - Number(stat.speakingStartedAt));
        stat.speakingStartedAt = null;
      }
      if (stat.handRaisedStartedAt) {
        stat.handRaisedMs = Number(stat.handRaisedMs || 0) + (Date.now() - Number(stat.handRaisedStartedAt));
        stat.handRaisedStartedAt = null;
      }
    }
    removeVideoTracksByIdentity(uid);
    audioTracks.delete(uid);
    participantLabels.delete(uid);
    speakingIds.delete(uid);
    raisedHands.delete(uid);
    rerender();
    renderModerationDrawer();
    if (!isProfessor && uid === String(professorUidHint)) {
      forceExit("professor_left");
    }
  });
  mainClient.on("volume-indicator", (volumes) => {
    const nextSpeaking = new Set();
    volumes.forEach((v) => {
      if ((v.level || 0) > 5) nextSpeaking.add(String(v.uid));
    });
    if (isProfessor) {
      nextSpeaking.forEach((id) => {
        if (!previousSpeaking.has(id) && id && !isProfessorLike(id)) {
          const stat = getOrInitStat(id);
          stat.speaks = Number(stat.speaks || 0) + 1;
          if (!stat.speakingStartedAt) stat.speakingStartedAt = Date.now();
        }
      });
      previousSpeaking.forEach((id) => {
        if (!nextSpeaking.has(id) && id && !isProfessorLike(id)) {
          const stat = getOrInitStat(id);
          if (stat.speakingStartedAt) {
            stat.speakingMs = Number(stat.speakingMs || 0) + (Date.now() - Number(stat.speakingStartedAt));
            stat.speakingStartedAt = null;
          }
        }
      });
      previousSpeaking = nextSpeaking;
    }
    speakingIds.clear();
    nextSpeaking.forEach((id) => speakingIds.add(id));
    markPaneBorders();
    syncStudentCardBorders();
    refreshPresenceBoard();
  });

  const startScreenShare = async () => {
    if (!isProfessor || localScreenTrack) return;
    try {
      const screenUid = Number(professorUidHint) + SCREEN_UID_OFFSET;
      screenClient = AgoraRTC.createClient({ mode: "rtc", codec: "vp8" });
      await screenClient.join(agoraAppId, agoraChannel, (agoraScreenToken || agoraToken), screenUid);
      const st = await AgoraRTC.createScreenVideoTrack();
      localScreenTrack = Array.isArray(st) ? st[0] : st;
      await screenClient.publish([localScreenTrack]);
      addVideoTrack(String(screenUid), localScreenTrack, "screen_share", true);
      localScreenTrack.on("track-ended", stopScreenShare);
      btnScreen.innerHTML = '<span class="material-symbols-outlined">stop_screen_share</span>';
      rerender();
    } catch (e) {
      const msg = String(e?.message || e || "");
      if (/not supported|permission|denied|mobile|ios|android/i.test(msg)) {
        showError("Screen share is not supported on this browser/device. Use desktop Chrome/Edge for screen sharing.");
      } else {
        showError(`Screen share failed: ${msg}`);
      }
      stopScreenShare();
    }
  };
  const stopScreenShare = async () => {
    try {
      if (localScreenTrack) {
        localScreenTrack.stop();
        localScreenTrack.close();
      }
      if (screenClient) await screenClient.leave();
    } catch (_) {}
    localScreenTrack = null;
    screenClient = null;
    removeVideoTracksByIdentity(resolveProfessorScreenIdentity());
    if (localCamTrack) addVideoTrack(String(agoraUid), localCamTrack, "camera", true);
    btnScreen.innerHTML = '<span class="material-symbols-outlined">present_to_all</span>';
    rerender();
  };

  rightPane.addEventListener("click", () => { rightMode = (rightMode + 1) % 3; renderRightPane(); });
  btnCycleMode.addEventListener("click", () => { rightMode = (rightMode + 1) % 3; renderRightPane(); });
  btnModeScreen.addEventListener("click", () => { rightMode = 0; renderRightPane(); });
  btnModeSplit.addEventListener("click", () => { rightMode = 1; renderRightPane(); });
  btnModeStudents.addEventListener("click", () => { rightMode = 2; renderRightPane(); });

  btnToggleLayoutPanel.addEventListener("click", () => {
    layoutPanel.classList.toggle("open");
    btnToggleLayoutPanel.classList.toggle("active", layoutPanel.classList.contains("open"));
  });
  swapPanesInput.addEventListener("change", () => { layoutPrefs.swapped = swapPanesInput.checked; applyLayoutPrefs(); persistLayoutPrefs(); });
  rightWidthInput.addEventListener("input", () => { layoutPrefs.rightWidth = Number(rightWidthInput.value); applyLayoutPrefs(); });
  rightWidthInput.addEventListener("change", persistLayoutPrefs);
  gridColsInput.addEventListener("input", () => { layoutPrefs.gridCols = Number(gridColsInput.value); applyLayoutPrefs(); });
  gridColsInput.addEventListener("change", () => { persistLayoutPrefs(); renderRightPane(); });
  tileSizeInput.addEventListener("input", () => { layoutPrefs.tileMinHeight = Number(tileSizeInput.value); applyLayoutPrefs(); });
  tileSizeInput.addEventListener("change", persistLayoutPrefs);
  btnResetLayout.addEventListener("click", () => { layoutPrefs = { ...defaultLayoutPrefs }; applyLayoutPrefs(); persistLayoutPrefs(); renderRightPane(); });

  const clampRightPaneWidth = (next) => Math.min(100, Math.max(0, Number(next || 28)));
  const setRightPaneWidthFromPointer = (clientX) => {
    if (window.matchMedia("(max-width: 1100px)").matches) return;
    const shellRect = roomRoot.querySelector(".room-shell").getBoundingClientRect();
    if (!shellRect.width) return;
    const relativeX = clientX - shellRect.left;
    const rightPercent = ((shellRect.width - relativeX) / shellRect.width) * 100;
    layoutPrefs.rightWidth = clampRightPaneWidth(rightPercent);
    applyLayoutPrefs();
  };
  paneResizer.addEventListener("pointerdown", (event) => {
    if (window.matchMedia("(max-width: 1100px)").matches) return;
    isResizing = true;
    paneResizer.classList.add("dragging");
    paneResizer.setPointerCapture(event.pointerId);
    event.preventDefault();
  });
  paneResizer.addEventListener("pointermove", (event) => { if (isResizing) setRightPaneWidthFromPointer(event.clientX); });
  const stopResizing = () => { if (isResizing) { isResizing = false; paneResizer.classList.remove("dragging"); persistLayoutPrefs(); } };
  paneResizer.addEventListener("pointerup", stopResizing);
  paneResizer.addEventListener("pointercancel", stopResizing);

  btnAudio.addEventListener("click", async () => {
    if (isMicLocked() && !isProfessor) {
      showError("Microphone is locked by the professor.");
      return;
    }
    if (!localMicTrack) return;
    await localMicTrack.setMuted(!localMicTrack.muted);
    syncControlStates();
  });
  btnVideo.addEventListener("click", async () => {
    if (!localCamTrack) return;
    await localCamTrack.setMuted(!localCamTrack.muted);
    syncControlStates();
    rerender();
  });
  btnScreen.addEventListener("click", async () => {
    if (!isProfessor) return;
    if (localScreenTrack) await stopScreenShare();
    else await startScreenShare();
  });
  btnRaiseHand.addEventListener("click", async () => {
    const id = String(agoraUid);
    if (raisedHands.has(id)) raisedHands.delete(id);
    else raisedHands.add(id);
    btnRaiseHand.innerHTML = raisedHands.has(id)
      ? '<span class="material-symbols-outlined">waving_hand</span>'
      : '<span class="material-symbols-outlined">front_hand</span>';
    markPaneBorders();
    syncStudentCardBorders();
    refreshPresenceBoard();
    await sendRoomSignal({ t: "hand", uid: id, raised: raisedHands.has(id) });
  });

  if (btnOpenMod) btnOpenMod.addEventListener("click", openModeration);
  if (btnCloseMod) btnCloseMod.addEventListener("click", closeModeration);
  if (btnMuteAll) btnMuteAll.addEventListener("click", async () => {
    const muteAllUrl = "{% url 'Prolean:external_live_mute_all' session_id %}";
    try {
      await fetch(muteAllUrl, {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8",
          "X-CSRFToken": getCsrfToken(),
          "Accept": "application/json",
        },
        body: "",
        credentials: "same-origin",
      });
    } catch (_) {}
    await sendRoomSignal({ t: "force_mute_all" });
    await logEvent("moderate_force_mute_all", {});
  });
  if (btnUnmuteAll) btnUnmuteAll.addEventListener("click", async () => {
    const unmuteAllUrl = "{% url 'Prolean:external_live_unmute_all' session_id %}";
    try {
      await fetch(unmuteAllUrl, {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8",
          "X-CSRFToken": getCsrfToken(),
          "Accept": "application/json",
        },
        body: "",
        credentials: "same-origin",
      });
    } catch (_) {}
    await sendRoomSignal({ t: "force_mute_all", locked: false });
    await logEvent("moderate_unmute_all", {});
  });
  if (btnEndLive) {
    btnEndLive.addEventListener("click", async () => {
      if (!isProfessor) return;
      const endUrl = String(btnEndLive.dataset.endUrl || "");
      if (!endUrl) return;
      btnEndLive.disabled = true;
      btnEndLive.classList.add("opacity-50", "cursor-not-allowed");
      try {
        await sendRoomSignal({ t: "live_end", uid: String(agoraUid) });
      } catch (_) {}
      try {
        const res = await fetch(endUrl, {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8",
            "X-CSRFToken": getCsrfToken(),
          },
          body: "",
          credentials: "same-origin",
        });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
      } catch (e) {
        showError(`End live failed: ${e?.message || e}`);
      }
      const dest = `${location.origin}{% url 'Prolean:professor_dashboard' %}?session_id={{ session_id }}`;
      window.location.href = dest;
    });
  }
  btnSound.addEventListener("click", () => {
    audioTracks.forEach((track) => { try { track.play(); } catch (_) {} });
    setStatus("Connected", "ok");
  });

  btnFullscreen.addEventListener("click", async () => {
    if (!document.fullscreenElement) {
      roomRoot.classList.add("room-fullscreen");
      await roomRoot.requestFullscreen().catch(() => {});
      btnFullscreen.innerHTML = '<span class="material-symbols-outlined">fullscreen_exit</span>';
    } else {
      await document.exitFullscreen().catch(() => {});
      roomRoot.classList.remove("room-fullscreen");
      btnFullscreen.innerHTML = '<span class="material-symbols-outlined">fullscreen</span>';
    }
  });
  document.addEventListener("fullscreenchange", () => {
    if (!document.fullscreenElement) {
      roomRoot.classList.remove("room-fullscreen");
      btnFullscreen.innerHTML = '<span class="material-symbols-outlined">fullscreen</span>';
    }
  });

  window.addEventListener("beforeunload", async () => {
    if (themeObserver) themeObserver.disconnect();
    try { if (localMicTrack) localMicTrack.close(); } catch (_) {}
    try { if (localCamTrack) localCamTrack.close(); } catch (_) {}
    try { await stopScreenShare(); } catch (_) {}
    try { await mainClient.leave(); } catch (_) {}
  });

  bindThemeSync();
  loadLayoutPrefs();
  applyLayoutPrefs();
  if (!isProfessor && presenceBoard) presenceBoard.classList.add("hidden");
  window.addEventListener("resize", rerender);
  connectAgora();
  refreshWatermarkTimestamps();
  setInterval(refreshWatermarkTimestamps, 1000);

  const statusUrl = "{% url 'Prolean:external_live_status' session_id %}";
  const pollStatus = async () => {
    if (exiting || !hasJoined) return;
    try {
      const res = await fetch(statusUrl, { credentials: "same-origin" });
      if (!res.ok) return;
      const data = await res.json();
      if (data && data.banned) {
        const reason = data.ban_reason ? ` (${data.ban_reason})` : "";
        showError(`You are banned from this live session${reason}.`);
        forceExit("banned_status");
        return;
      }
      if (data && data.mic_locked && !isProfessor) {
        setMicLocked(true);
        if (localMicTrack) {
          try { await localMicTrack.setMuted(true); } catch (_) {}
        }
        syncControlStates();
      } else if (!isProfessor && !data?.mic_locked && isMicLocked()) {
        setMicLocked(false);
        syncControlStates();
      }
      if (data && data.ended) {
        forceExit("live_ended_status");
      }
    } catch (_) {}
  };
  setInterval(pollStatus, 3500);

  if (isProfessor) {
    const statsPushUrl = "{% url 'Prolean:external_live_stats_push' session_id %}";

    const tickTracking = () => {
      if (exiting) return;
      const students = getStudentEntries();
      students.forEach((s) => {
        const stat = getOrInitStat(s.id);
        if (stat.online && !stat.joinedAt) stat.joinedAt = Date.now();
      });
    };

    const pushTracking = async () => {
      if (exiting || !hasJoined) return;
      const students = Array.from(statsByUid.values())
        .filter((r) => r && r.uid && !isProfessorLike(r.uid))
        .map((r) => ({
          uid: String(r.uid),
          name: String(r.name || identityLabel(r.uid) || `Student ${r.uid}`),
          watch_ms: Math.round(estimateWatchMs(r)),
          speaking_ms: Math.round(estimateSpeakingMs(r)),
          hand_raised_ms: Math.round(estimateHandRaisedMs(r)),
          speaks: Number(r.speaks || 0),
          hands: Number(r.hands || 0),
          engagement: computeEngagement(r),
        }));
      try {
        await fetch(statsPushUrl, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCsrfToken(),
          },
          body: JSON.stringify({ students }),
          credentials: "same-origin",
        });
      } catch (_) {}
    };

    setInterval(tickTracking, 1000);
    setInterval(pushTracking, 5000);
  }
})();
</script>
{% endblock %}

