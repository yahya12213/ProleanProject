{% extends 'Prolean/base.html' %}
{% load static %}

{% block title %}Live Session{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="rounded-2xl border border-neutral-200 bg-white p-6 shadow-sm mb-6 flex items-center justify-between gap-4">
        <div>
            <p class="text-xs font-bold uppercase tracking-widest text-neutral-500">Live Session</p>
            <h1 class="text-2xl font-black text-neutral-900">{{ room_name }}</h1>
            <p class="text-sm text-neutral-600 mt-1">Role: {{ live_role|title }}</p>
        </div>
        <div class="flex items-center gap-3">
            <span id="conn-badge" class="px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider bg-amber-100 text-amber-700">
                Connecting
            </span>
            <form method="post" action="{% url 'Prolean:external_live_leave' session_id %}">
                {% csrf_token %}
                <button type="submit" class="px-4 py-2 rounded-xl bg-red-600 text-white font-bold text-sm hover:bg-red-700 transition-colors">
                    Leave
                </button>
            </form>
        </div>
    </div>
    <div id="conn-error" class="hidden mb-6 px-4 py-3 rounded-xl border border-red-200 bg-red-50 text-red-700 text-sm font-semibold"></div>

    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
        <div class="lg:col-span-3 rounded-2xl border border-neutral-200 bg-neutral-950 min-h-[520px] p-3">
            <div id="video-grid" class="grid grid-cols-1 md:grid-cols-2 gap-3"></div>
            <div id="audio-sink" class="hidden"></div>
        </div>
        <div class="rounded-2xl border border-neutral-200 bg-white p-4">
            <p class="text-xs font-bold uppercase tracking-widest text-neutral-500 mb-4">Controls</p>
            <div class="space-y-3">
                <button id="toggle-audio" class="w-full px-4 py-2 rounded-xl border border-neutral-300 font-bold text-sm">
                    Mute Mic
                </button>
                <button id="toggle-video" class="w-full px-4 py-2 rounded-xl border border-neutral-300 font-bold text-sm">
                    Stop Camera
                </button>
                <button id="raise-hand" class="w-full px-4 py-2 rounded-xl border border-neutral-300 font-bold text-sm">
                    Raise Hand
                </button>
                <button id="enable-sound" class="w-full px-4 py-2 rounded-xl border border-neutral-300 font-bold text-sm">
                    Enable Sound
                </button>
            </div>
            <p class="text-xs text-neutral-500 mt-6">If connection drops, return to dashboard and join again.</p>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/livekit-client/dist/livekit-client.umd.min.js"></script>
<script>
(() => {
  const rawLivekitUrl = "{{ livekit_url|escapejs }}";
  const livekitToken = "{{ livekit_token|escapejs }}";
  const isProfessor = "{{ live_role|escapejs }}" === "professor";
  const videoGrid = document.getElementById("video-grid");
  const audioSink = document.getElementById("audio-sink");
  const badge = document.getElementById("conn-badge");
  const btnAudio = document.getElementById("toggle-audio");
  const btnVideo = document.getElementById("toggle-video");
  const btnRaiseHand = document.getElementById("raise-hand");
  const btnEnableSound = document.getElementById("enable-sound");
  const errBox = document.getElementById("conn-error");
  const attachedTrackKeys = new Set();

  const normalizeLivekitUrl = (value) => {
    const cleaned = String(value || "").trim().replace(/^['"]|['"]$/g, "");
    if (!cleaned) return "";
    if (/^wss?:\/\//i.test(cleaned)) return cleaned;
    return `wss://${cleaned}`;
  };
  const livekitUrl = normalizeLivekitUrl(rawLivekitUrl);

  if (!livekitUrl || !livekitToken) {
    badge.textContent = "Config Error";
    badge.className = "px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider bg-red-100 text-red-700";
    if (errBox) {
      errBox.textContent = `Missing live config. URL="${rawLivekitUrl || '-'}"`;
      errBox.classList.remove("hidden");
    }
    return;
  }

  try {
    new URL(livekitUrl);
  } catch {
    badge.textContent = "Invalid URL";
    badge.className = "px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider bg-red-100 text-red-700";
    if (errBox) {
      errBox.textContent = `Invalid LiveKit URL after normalization: "${livekitUrl}" (raw: "${rawLivekitUrl || '-'}")`;
      errBox.classList.remove("hidden");
    }
    return;
  }

  const room = new LivekitClient.Room({
    adaptiveStream: true,
    dynacast: true,
  });

  const trackKey = (track, kindHint) => `${kindHint || track.kind}:${track.sid || track.mediaStreamTrack?.id || Math.random().toString(36).slice(2)}`;

  const attachVideoTrack = (track, participantIdentity, label) => {
    const key = trackKey(track, "video");
    if (attachedTrackKeys.has(key)) return;
    attachedTrackKeys.add(key);

    const wrapper = document.createElement("div");
    wrapper.className = "relative rounded-xl overflow-hidden border border-neutral-800 bg-black";
    wrapper.dataset.trackKey = key;

    const mediaEl = track.attach();
    mediaEl.className = "w-full h-64 object-cover bg-black";
    mediaEl.playsInline = true;
    mediaEl.autoplay = true;
    mediaEl.muted = participantIdentity === room.localParticipant.identity;
    wrapper.appendChild(mediaEl);

    const badge = document.createElement("div");
    badge.className = "absolute left-2 bottom-2 px-2 py-1 rounded bg-black/60 text-white text-xs font-bold";
    badge.textContent = label || participantIdentity;
    wrapper.appendChild(badge);

    videoGrid.appendChild(wrapper);
  };

  const attachAudioTrack = (track, participantIdentity) => {
    const key = trackKey(track, "audio");
    if (attachedTrackKeys.has(key)) return;
    attachedTrackKeys.add(key);

    const audioEl = track.attach();
    audioEl.autoplay = true;
    audioEl.playsInline = true;
    audioEl.muted = false;
    audioEl.dataset.trackKey = key;
    audioEl.dataset.participant = participantIdentity;
    audioSink.appendChild(audioEl);
    const p = audioEl.play();
    if (p && typeof p.catch === "function") p.catch(() => {});
  };

  const detachTrack = (track) => {
    const videoKey = trackKey(track, "video");
    const audioKey = trackKey(track, "audio");
    attachedTrackKeys.delete(videoKey);
    attachedTrackKeys.delete(audioKey);
    track.detach().forEach((el) => {
      const wrapper = el.closest("[data-track-key]");
      if (wrapper) {
        wrapper.remove();
      } else {
        el.remove();
      }
    });
  };

  const attachTrack = (track, participantIdentity, label) => {
    if (track.kind === "video") {
      attachVideoTrack(track, participantIdentity, label);
      return;
    }
    if (track.kind === "audio") {
      attachAudioTrack(track, participantIdentity);
    }
  };

  const renderParticipantTracks = (participant, label) => {
    participant.trackPublications.forEach((pub) => {
      if (pub.track) {
        attachTrack(pub.track, participant.identity, label || participant.identity);
      }
    });
  };

  room
    .on(LivekitClient.RoomEvent.TrackSubscribed, (track, publication, participant) => {
      attachTrack(track, participant.identity);
    })
    .on(LivekitClient.RoomEvent.TrackUnsubscribed, (track) => {
      detachTrack(track);
    })
    .on(LivekitClient.RoomEvent.Disconnected, () => {
      badge.textContent = "Disconnected";
      badge.className = "px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider bg-red-100 text-red-700";
    })
    .on(LivekitClient.RoomEvent.DataReceived, (payload, participant) => {
      try {
        const message = JSON.parse(new TextDecoder().decode(payload));
        if (isProfessor && message && message.type === "raise_hand") {
          if (errBox) {
            errBox.textContent = `${message.name || participant?.identity || "Student"} raised hand`;
            errBox.classList.remove("hidden");
          }
        }
      } catch (_) {}
    });

  room.connect(livekitUrl, livekitToken).then(async () => {
    badge.textContent = "Connected";
    badge.className = "px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider bg-green-100 text-green-700";

    room.remoteParticipants.forEach((participant) => renderParticipantTracks(participant));

    if (isProfessor) {
      await room.localParticipant.setMicrophoneEnabled(true);
      await room.localParticipant.setCameraEnabled(true);
      renderParticipantTracks(room.localParticipant, "You");
      btnVideo.disabled = false;
      btnVideo.classList.remove("opacity-50", "cursor-not-allowed");
    } else {
      await room.localParticipant.setCameraEnabled(false);
      await room.localParticipant.setMicrophoneEnabled(true);
      btnVideo.disabled = true;
      btnVideo.classList.add("opacity-50", "cursor-not-allowed");
      btnVideo.textContent = "Camera Disabled for Students";
    }
  }).catch((err) => {
    badge.textContent = "Connection Failed";
    badge.className = "px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider bg-red-100 text-red-700";
    if (errBox) {
      const errMsg = (err && (err.message || String(err))) ? (err.message || String(err)) : "Unknown LiveKit connection error.";
      errBox.textContent = `LiveKit connection failed: ${errMsg}`;
      errBox.classList.remove("hidden");
    }
  });

  btnAudio.addEventListener("click", async () => {
    const enabled = room.localParticipant.isMicrophoneEnabled;
    await room.localParticipant.setMicrophoneEnabled(!enabled);
    btnAudio.textContent = enabled ? "Unmute Mic" : "Mute Mic";
  });

  btnVideo.addEventListener("click", async () => {
    if (!isProfessor) return;
    const enabled = room.localParticipant.isCameraEnabled;
    await room.localParticipant.setCameraEnabled(!enabled);
    btnVideo.textContent = enabled ? "Start Camera" : "Stop Camera";
  });

  btnRaiseHand.addEventListener("click", async () => {
    try {
      const payload = JSON.stringify({
        type: "raise_hand",
        name: "{{ user.get_full_name|default:user.username|escapejs }}",
        ts: Date.now()
      });
      await room.localParticipant.publishData(new TextEncoder().encode(payload), { reliable: true });
      btnRaiseHand.textContent = "Hand Raised";
      setTimeout(() => { btnRaiseHand.textContent = "Raise Hand"; }, 3000);
    } catch (err) {
      if (errBox) {
        errBox.textContent = `Raise hand failed: ${err?.message || err}`;
        errBox.classList.remove("hidden");
      }
    }
  });

  btnEnableSound.addEventListener("click", async () => {
    const audios = audioSink.querySelectorAll("audio");
    for (const audio of audios) {
      try {
        audio.muted = false;
        audio.volume = 1;
        await audio.play();
      } catch (_) {}
    }
  });
})();
</script>
{% endblock %}
