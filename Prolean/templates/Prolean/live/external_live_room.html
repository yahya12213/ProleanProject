{% extends 'Prolean/base.html' %}
{% load static %}

{% block title %}Live Presenter Room{% endblock %}
{% block main_class %}w-full max-w-none{% endblock %}
{% block extra_css %}
<style>
    #contact, .floating-buttons { display: none !important; }
    body > header, body > footer { display: none !important; }

    .presenter-room {
        min-height: 100vh;
        background: linear-gradient(180deg, #14171c 0%, #101318 100%);
        color: #e5e7eb;
        font-family: "Plus Jakarta Sans", sans-serif;
    }

    .room-top {
        border-bottom: 1px solid rgba(148, 163, 184, 0.2);
        background: #15181d;
    }

    .room-shell {
        display: grid;
        grid-template-columns: minmax(0, 1fr) minmax(320px, 28%);
        gap: 14px;
        min-height: calc(100vh - 64px);
        padding: 12px;
    }

    @media (max-width: 1100px) {
        .room-shell {
            grid-template-columns: 1fr;
        }
    }

    .pane {
        border: 1px solid rgba(148, 163, 184, 0.24);
        background: #11141a;
        border-radius: 12px;
        overflow: hidden;
        position: relative;
    }

    .pane-main {
        min-height: 62vh;
    }

    .pane-side {
        min-height: 62vh;
        cursor: pointer;
    }

    .pane-title {
        position: absolute;
        top: 8px;
        left: 8px;
        z-index: 5;
        background: rgba(0, 0, 0, 0.65);
        border: 1px solid rgba(148, 163, 184, 0.25);
        border-radius: 8px;
        padding: 4px 8px;
        font-size: 11px;
        font-weight: 800;
        letter-spacing: 0.06em;
        text-transform: uppercase;
    }

    .speaker-border {
        box-shadow: inset 0 0 0 2px #22c55e;
    }

    .raised-border {
        box-shadow: inset 0 0 0 2px #ef4444;
    }

    .video-host {
        width: 100%;
        height: 100%;
        background: #090b0f;
    }

    .video-host video {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .avatar-host {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: radial-gradient(circle at 20% 20%, #1f2937 0%, #0b0d11 100%);
    }

    .avatar-badge {
        width: 96px;
        height: 96px;
        border-radius: 999px;
        background: #f97316;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #fff;
        font-size: 38px;
        font-weight: 900;
    }

    .student-grid {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 8px;
        padding: 40px 8px 8px;
        height: 100%;
        overflow: auto;
    }

    .student-card {
        min-height: 120px;
        border: 1px solid rgba(148, 163, 184, 0.28);
        border-radius: 10px;
        overflow: hidden;
        position: relative;
        background: #0b0d11;
    }

    .student-label {
        position: absolute;
        left: 6px;
        bottom: 6px;
        z-index: 4;
        padding: 3px 7px;
        border-radius: 7px;
        background: rgba(0, 0, 0, 0.65);
        color: #fff;
        font-size: 11px;
        font-weight: 700;
    }

    .controls-bar {
        border-top: 1px solid rgba(148, 163, 184, 0.2);
        background: #15181d;
        padding: 10px 12px;
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
    }

    .ctrl-btn {
        width: 42px;
        height: 42px;
        border-radius: 10px;
        border: 1px solid rgba(148, 163, 184, 0.3);
        background: #222a35;
        color: #e5e7eb;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }

    .ctrl-btn[data-state="off"] {
        background: rgba(239, 68, 68, 0.18);
        border-color: rgba(239, 68, 68, 0.45);
        color: #fca5a5;
    }

    .room-fullscreen .room-top {
        display: none;
    }
</style>
{% endblock %}

{% block content %}
<div id="room-root" class="presenter-room">
    <div class="room-top px-3 py-2 flex items-center justify-between">
        <div class="text-xs font-black uppercase tracking-widest text-slate-300">Live Presenter</div>
        <div class="flex items-center gap-2">
            <span id="conn-badge" class="px-2 py-1 rounded bg-amber-500/15 text-amber-300 text-[10px] font-black uppercase tracking-wider">Connecting</span>
            <form method="post" action="{% url 'Prolean:external_live_leave' session_id %}">
                {% csrf_token %}
                <button type="submit" class="px-3 py-1.5 rounded bg-red-600 hover:bg-red-700 text-white text-[11px] font-black uppercase tracking-wider">Leave</button>
            </form>
        </div>
    </div>

    <div id="conn-error" class="hidden mx-3 mt-2 px-3 py-2 rounded border border-red-500/40 bg-red-500/10 text-red-300 text-xs font-semibold"></div>

    <div class="room-shell">
        <section id="left-pane" class="pane pane-main">
            <div class="pane-title">Professor Camera</div>
            <div id="left-host" class="video-host"></div>
        </section>

        <section id="right-pane" class="pane pane-side" title="Tap to switch right screen mode">
            <div id="right-title" class="pane-title">Professor Screen Share</div>
            <div id="right-host" class="video-host"></div>
        </section>
    </div>

    <div class="controls-bar">
        <button id="toggle-audio" class="ctrl-btn" data-state="on" title="Microphone"><span class="material-symbols-outlined">mic</span></button>
        <button id="toggle-video" class="ctrl-btn" data-state="on" title="Camera"><span class="material-symbols-outlined">videocam</span></button>
        <button id="toggle-screen" class="ctrl-btn" title="Screen Share"><span class="material-symbols-outlined">present_to_all</span></button>
        <button id="raise-hand" class="ctrl-btn" title="Raise Hand"><span class="material-symbols-outlined">front_hand</span></button>
        <button id="enable-sound" class="ctrl-btn" title="Enable Sound"><span class="material-symbols-outlined">volume_up</span></button>
        <button id="toggle-fullscreen" class="ctrl-btn" title="Fullscreen"><span class="material-symbols-outlined">fullscreen</span></button>
        <button id="cycle-right-mode" class="ctrl-btn" title="Switch Right Screen"><span class="material-symbols-outlined">swap_horiz</span></button>
        <div id="audio-sink" class="hidden"></div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/livekit-client/dist/livekit-client.umd.min.js"></script>
<script>
(() => {
  const rawLivekitUrl = "{{ livekit_url|escapejs }}";
  const livekitToken = "{{ livekit_token|escapejs }}";
  const isProfessor = "{{ live_role|escapejs }}" === "professor";
  const selfName = "{{ user.get_full_name|default:user.username|escapejs }}";

  const roomRoot = document.getElementById("room-root");
  const leftPane = document.getElementById("left-pane");
  const rightPane = document.getElementById("right-pane");
  const leftHost = document.getElementById("left-host");
  const rightHost = document.getElementById("right-host");
  const rightTitle = document.getElementById("right-title");
  const connBadge = document.getElementById("conn-badge");
  const connError = document.getElementById("conn-error");
  const audioSink = document.getElementById("audio-sink");

  const btnAudio = document.getElementById("toggle-audio");
  const btnVideo = document.getElementById("toggle-video");
  const btnScreen = document.getElementById("toggle-screen");
  const btnRaiseHand = document.getElementById("raise-hand");
  const btnSound = document.getElementById("enable-sound");
  const btnFullscreen = document.getElementById("toggle-fullscreen");
  const btnCycleMode = document.getElementById("cycle-right-mode");

  const participantLabels = new Map();
  const participantRoles = new Map();
  const videoTracks = new Map(); // sid -> {track, identity, source, isLocal}
  const audioEls = new Map(); // identity -> audioEl
  const raisedHands = new Set();
  const speakingIds = new Set();

  let professorIdentity = null;
  let rightMode = 0; // 0 screen share, 1 self cam, 2 students grid

  const normalizeLivekitUrl = (value) => {
    const cleaned = String(value || "").trim().replace(/^['"]|['"]$/g, "");
    if (!cleaned) return "";
    if (/^wss?:\/\//i.test(cleaned)) return cleaned;
    return `wss://${cleaned}`;
  };

  const normalizeSource = (source) => {
    const text = String(source || "").toLowerCase();
    if (!text || text === "unknown") return "camera";
    return text;
  };

  const isScreenShare = (source) => normalizeSource(source).startsWith("screen_share");

  const initials = (label) => (String(label || "U").trim()[0] || "U").toUpperCase();

  const setStatus = (txt, kind = "warn") => {
    const style = {
      ok: "bg-green-500/15 text-green-300",
      warn: "bg-amber-500/15 text-amber-300",
      err: "bg-red-500/15 text-red-300",
    }[kind] || "bg-amber-500/15 text-amber-300";
    connBadge.className = `px-2 py-1 rounded text-[10px] font-black uppercase tracking-wider ${style}`;
    connBadge.textContent = txt;
  };

  const showError = (message) => {
    connError.textContent = message;
    connError.classList.remove("hidden");
  };

  const markPaneBorders = () => {
    leftPane.classList.remove("speaker-border", "raised-border");
    rightPane.classList.remove("speaker-border", "raised-border");

    if (professorIdentity && speakingIds.has(professorIdentity)) leftPane.classList.add("speaker-border");
    if (professorIdentity && raisedHands.has(professorIdentity)) leftPane.classList.add("raised-border");

    const rightIdentity =
      rightMode === 1 ? (room.localParticipant ? room.localParticipant.identity : null) : null;
    if (rightIdentity && speakingIds.has(rightIdentity)) rightPane.classList.add("speaker-border");
    if (rightIdentity && raisedHands.has(rightIdentity)) rightPane.classList.add("raised-border");
  };

  const getIdentityRole = (participant) => {
    if (!participant) return null;
    try {
      if (participant.metadata) {
        const meta = JSON.parse(participant.metadata);
        if (meta && typeof meta.role === "string") return String(meta.role).toLowerCase();
      }
    } catch (_) {}
    const identity = String(participant.identity || "").toLowerCase();
    if (identity.includes("prof")) return "professor";
    if (identity.includes("teacher")) return "professor";
    return null;
  };

  const resolveProfessorIdentity = () => {
    if (isProfessor && room.localParticipant) return room.localParticipant.identity;
    for (const [id, role] of participantRoles.entries()) {
      if (role === "professor") return id;
    }
    for (const { identity, source, isLocal } of videoTracks.values()) {
      if (isLocal) continue;
      if (!isScreenShare(source)) return identity;
    }
    return professorIdentity;
  };

  const tracksByIdentity = (identity, wantScreen = false) =>
    Array.from(videoTracks.values()).filter((v) => v.identity === identity && (wantScreen ? isScreenShare(v.source) : !isScreenShare(v.source)));

  const pickTrack = (identity, wantScreen = false) => {
    const arr = tracksByIdentity(identity, wantScreen);
    return arr.length ? arr[arr.length - 1] : null;
  };

  const renderAvatar = (host, label) => {
    host.innerHTML = "";
    const wrap = document.createElement("div");
    wrap.className = "avatar-host";
    const badge = document.createElement("div");
    badge.className = "avatar-badge";
    badge.textContent = initials(label);
    wrap.appendChild(badge);
    const footer = document.createElement("div");
    footer.className = "student-label";
    footer.textContent = label;
    wrap.appendChild(footer);
    host.appendChild(wrap);
  };

  const renderTrack = (host, data, label) => {
    host.innerHTML = "";
    const media = data.track.attach();
    media.autoplay = true;
    media.playsInline = true;
    media.muted = !!data.isLocal;
    media.setAttribute("playsinline", "true");
    const footer = document.createElement("div");
    footer.className = "student-label";
    footer.textContent = label;
    host.appendChild(media);
    host.appendChild(footer);
  };

  const renderLeftPane = () => {
    professorIdentity = resolveProfessorIdentity();
    const label = participantLabels.get(professorIdentity) || "Professor";
    const profCam = professorIdentity ? pickTrack(professorIdentity, false) : null;
    if (profCam) renderTrack(leftHost, profCam, label);
    else renderAvatar(leftHost, label);
  };

  const renderStudentsGrid = () => {
    rightHost.innerHTML = "";
    const grid = document.createElement("div");
    grid.className = "student-grid";

    const entries = new Map();
    for (const [id, name] of participantLabels.entries()) {
      if (id === professorIdentity) continue;
      entries.set(id, { id, name });
    }
    for (const student of entries.values()) {
      const card = document.createElement("div");
      card.className = "student-card";
      if (raisedHands.has(student.id)) card.classList.add("raised-border");
      else if (speakingIds.has(student.id)) card.classList.add("speaker-border");

      const cam = pickTrack(student.id, false);
      if (cam) {
        const media = cam.track.attach();
        media.autoplay = true;
        media.playsInline = true;
        media.muted = cam.isLocal;
        media.setAttribute("playsinline", "true");
        card.appendChild(media);
      } else {
        const av = document.createElement("div");
        av.className = "avatar-host";
        const badge = document.createElement("div");
        badge.className = "avatar-badge";
        badge.textContent = initials(student.name);
        av.appendChild(badge);
        card.appendChild(av);
      }
      const footer = document.createElement("div");
      footer.className = "student-label";
      footer.textContent = student.name;
      card.appendChild(footer);
      grid.appendChild(card);
    }

    rightHost.appendChild(grid);
  };

  const renderRightPane = () => {
    if (rightMode === 0) {
      rightTitle.textContent = "Professor Screen Share (Tap to Switch)";
      const screen = professorIdentity ? pickTrack(professorIdentity, true) : null;
      if (screen) renderTrack(rightHost, screen, "Screen Share");
      else renderAvatar(rightHost, "No Screen Share");
    } else if (rightMode === 1) {
      rightTitle.textContent = "Your Camera (Tap to Switch)";
      const localId = room.localParticipant ? room.localParticipant.identity : null;
      const localCam = localId ? pickTrack(localId, false) : null;
      if (localCam) renderTrack(rightHost, localCam, "You");
      else renderAvatar(rightHost, "You");
    } else {
      rightTitle.textContent = "Students Grid (Tap to Switch)";
      renderStudentsGrid();
    }
    markPaneBorders();
  };

  const rerender = () => {
    renderLeftPane();
    renderRightPane();
  };

  const room = new LivekitClient.Room({
    adaptiveStream: true,
    dynacast: true,
    stopLocalTrackOnUnpublish: true,
  });

  const syncControlStates = () => {
    const micOn = !!room.localParticipant?.isMicrophoneEnabled;
    const camOn = !!room.localParticipant?.isCameraEnabled;
    btnAudio.dataset.state = micOn ? "on" : "off";
    btnVideo.dataset.state = camOn ? "on" : "off";
    btnAudio.innerHTML = `<span class="material-symbols-outlined">${micOn ? "mic" : "mic_off"}</span>`;
    btnVideo.innerHTML = `<span class="material-symbols-outlined">${camOn ? "videocam" : "videocam_off"}</span>`;
  };

  const upsertParticipant = (participant) => {
    if (!participant) return;
    participantLabels.set(participant.identity, participant.name || participant.identity);
    const role = getIdentityRole(participant);
    if (role) participantRoles.set(participant.identity, role);
  };

  const addVideoTrack = (track, participant, source) => {
    upsertParticipant(participant);
    const sid = track.sid || `${participant.identity}:${source}`;
    videoTracks.set(sid, {
      track,
      identity: participant.identity,
      source: normalizeSource(source),
      isLocal: room.localParticipant && participant.identity === room.localParticipant.identity,
    });
    rerender();
  };

  const removeTrack = (track) => {
    for (const [sid, info] of videoTracks.entries()) {
      if (track.sid && info.track.sid === track.sid) videoTracks.delete(sid);
    }
    for (const [id, el] of audioEls.entries()) {
      if (el.dataset.trackSid === (track.sid || "")) {
        el.remove();
        audioEls.delete(id);
      }
    }
    track.detach().forEach((el) => el.remove());
    rerender();
  };

  const addAudioTrack = (track, participant, source) => {
    if (!participant || (room.localParticipant && participant.identity === room.localParticipant.identity)) return;
    if (isScreenShare(source)) return;
    upsertParticipant(participant);
    const identity = participant.identity;
    if (audioEls.has(identity)) {
      audioEls.get(identity).remove();
      audioEls.delete(identity);
    }
    const audioEl = track.attach();
    audioEl.autoplay = true;
    audioEl.playsInline = true;
    audioEl.muted = false;
    audioEl.dataset.trackSid = track.sid || "";
    audioSink.appendChild(audioEl);
    audioEls.set(identity, audioEl);
    const p = audioEl.play();
    if (p && typeof p.catch === "function") p.catch(() => setStatus("Tap Sound", "warn"));
  };

  const livekitUrl = normalizeLivekitUrl(rawLivekitUrl);
  if (!livekitUrl || !livekitToken) {
    setStatus("Config Error", "err");
    showError("Missing live config.");
    return;
  }

  try { new URL(livekitUrl); }
  catch {
    setStatus("Invalid URL", "err");
    showError(`Invalid LiveKit URL: ${livekitUrl}`);
    return;
  }

  room
    .on(LivekitClient.RoomEvent.TrackSubscribed, (track, pub, participant) => {
      if (track.kind === "video") addVideoTrack(track, participant, pub?.source || "camera");
      if (track.kind === "audio") addAudioTrack(track, participant, pub?.source || "microphone");
    })
    .on(LivekitClient.RoomEvent.TrackUnsubscribed, (track) => {
      removeTrack(track);
    })
    .on(LivekitClient.RoomEvent.LocalTrackPublished, (pub) => {
      if (pub?.track?.kind === "video") {
        addVideoTrack(pub.track, room.localParticipant, pub?.source || "camera");
      }
    })
    .on(LivekitClient.RoomEvent.LocalTrackUnpublished, (pub) => {
      if (pub?.track) removeTrack(pub.track);
    })
    .on(LivekitClient.RoomEvent.ParticipantConnected, (p) => {
      upsertParticipant(p);
      rerender();
    })
    .on(LivekitClient.RoomEvent.ParticipantDisconnected, (p) => {
      if (!p) return;
      for (const [sid, info] of videoTracks.entries()) {
        if (info.identity === p.identity) videoTracks.delete(sid);
      }
      if (audioEls.has(p.identity)) {
        audioEls.get(p.identity).remove();
        audioEls.delete(p.identity);
      }
      participantLabels.delete(p.identity);
      participantRoles.delete(p.identity);
      raisedHands.delete(p.identity);
      speakingIds.delete(p.identity);
      rerender();
    })
    .on(LivekitClient.RoomEvent.ActiveSpeakersChanged, () => {
      speakingIds.clear();
      (room.activeSpeakers || []).forEach((p) => speakingIds.add(p.identity));
      markPaneBorders();
      if (rightMode === 2) renderRightPane();
    })
    .on(LivekitClient.RoomEvent.DataReceived, (payload, participant) => {
      try {
        const msg = JSON.parse(new TextDecoder().decode(payload));
        if (!msg || !msg.type) return;
        const id = participant?.identity || "";
        if (msg.type === "raise_hand" && id) raisedHands.add(id);
        if (msg.type === "hand_lowered" && id) raisedHands.delete(id);
        markPaneBorders();
        if (rightMode === 2) renderRightPane();
      } catch (_) {}
    })
    .on(LivekitClient.RoomEvent.Disconnected, () => setStatus("Disconnected", "err"));

  setStatus("Connecting", "warn");
  room.connect(livekitUrl, livekitToken)
    .then(async () => {
      setStatus("Connected", "ok");
      upsertParticipant(room.localParticipant);
      if (isProfessor) participantRoles.set(room.localParticipant.identity, "professor");

      room.remoteParticipants.forEach((p) => {
        upsertParticipant(p);
        p.trackPublications.forEach((pub) => {
          if (!pub.track) return;
          if (pub.track.kind === "video") addVideoTrack(pub.track, p, pub.source || "camera");
          if (pub.track.kind === "audio") addAudioTrack(pub.track, p, pub.source || "microphone");
        });
      });

      try { await room.localParticipant.setMicrophoneEnabled(true); } catch (e) { showError(`Mic permission: ${e.message || e}`); }
      try { await room.localParticipant.setCameraEnabled(true); } catch (e) { showError(`Camera permission: ${e.message || e}`); }
      syncControlStates();
      rerender();

      if (!isProfessor) {
        btnScreen.disabled = true;
        btnScreen.classList.add("opacity-50", "cursor-not-allowed");
      }
    })
    .catch((err) => {
      setStatus("Connection Failed", "err");
      showError(`LiveKit connection failed: ${err?.message || err}`);
    });

  rightPane.addEventListener("click", () => {
    rightMode = (rightMode + 1) % 3;
    renderRightPane();
  });

  btnCycleMode.addEventListener("click", () => {
    rightMode = (rightMode + 1) % 3;
    renderRightPane();
  });

  btnAudio.addEventListener("click", async () => {
    try {
      const on = room.localParticipant.isMicrophoneEnabled;
      await room.localParticipant.setMicrophoneEnabled(!on);
      syncControlStates();
    } catch (e) { showError(`Mic toggle failed: ${e.message || e}`); }
  });

  btnVideo.addEventListener("click", async () => {
    try {
      const on = room.localParticipant.isCameraEnabled;
      await room.localParticipant.setCameraEnabled(!on);
      syncControlStates();
    } catch (e) { showError(`Camera toggle failed: ${e.message || e}`); }
  });

  btnScreen.addEventListener("click", async () => {
    if (!isProfessor) return;
    try {
      const on = !!room.localParticipant.isScreenShareEnabled;
      await room.localParticipant.setScreenShareEnabled(!on);
      if (!on && !room.localParticipant.isCameraEnabled) {
        await room.localParticipant.setCameraEnabled(true);
      }
      btnScreen.innerHTML = `<span class="material-symbols-outlined">${on ? "present_to_all" : "stop_screen_share"}</span>`;
      syncControlStates();
    } catch (e) { showError(`Screen share failed: ${e.message || e}`); }
  });

  btnRaiseHand.addEventListener("click", async () => {
    try {
      const payload = JSON.stringify({ type: "raise_hand", name: selfName, ts: Date.now() });
      await room.localParticipant.publishData(new TextEncoder().encode(payload), { reliable: true });
      btnRaiseHand.innerHTML = '<span class="material-symbols-outlined">waving_hand</span>';
      setTimeout(() => { btnRaiseHand.innerHTML = '<span class="material-symbols-outlined">front_hand</span>'; }, 1800);
    } catch (e) { showError(`Raise hand failed: ${e.message || e}`); }
  });

  btnSound.addEventListener("click", async () => {
    for (const audio of audioSink.querySelectorAll("audio")) {
      try {
        audio.muted = false;
        audio.volume = 1;
        await audio.play();
      } catch (_) {}
    }
    setStatus("Connected", "ok");
  });

  btnFullscreen.addEventListener("click", async () => {
    if (!document.fullscreenElement) {
      roomRoot.classList.add("room-fullscreen");
      await roomRoot.requestFullscreen().catch(() => {});
      btnFullscreen.innerHTML = '<span class="material-symbols-outlined">fullscreen_exit</span>';
    } else {
      await document.exitFullscreen().catch(() => {});
      roomRoot.classList.remove("room-fullscreen");
      btnFullscreen.innerHTML = '<span class="material-symbols-outlined">fullscreen</span>';
    }
  });

  document.addEventListener("fullscreenchange", () => {
    if (!document.fullscreenElement) {
      roomRoot.classList.remove("room-fullscreen");
      btnFullscreen.innerHTML = '<span class="material-symbols-outlined">fullscreen</span>';
    }
  });

  window.addEventListener("beforeunload", () => {
    room.disconnect();
  });
})();
</script>
{% endblock %}
