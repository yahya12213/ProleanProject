{% extends 'Prolean/base.html' %}
{% load static %}

{% block title %}Live Session{% endblock %}
{% block main_class %}w-full max-w-none{% endblock %}
{% block extra_css %}
<style>
    #contact { display: none !important; }
    .live-room-shell {
        min-height: calc(100vh - 80px);
        background:
            radial-gradient(circle at 10% 10%, rgba(255, 107, 0, 0.12), transparent 38%),
            radial-gradient(circle at 90% 18%, rgba(14, 165, 233, 0.12), transparent 40%),
            #0b0b0f;
    }
    .dark .live-room-shell {
        background:
            radial-gradient(circle at 10% 10%, rgba(255, 107, 0, 0.18), transparent 38%),
            radial-gradient(circle at 90% 18%, rgba(14, 165, 233, 0.18), transparent 40%),
            #060608;
    }
</style>
{% endblock %}

{% block content %}
<div class="live-room-shell w-full px-2 sm:px-4 lg:px-6 py-3 sm:py-4">
    <div class="rounded-3xl border border-neutral-800 bg-gradient-to-r from-neutral-900 via-neutral-900 to-neutral-800 p-4 sm:p-5 shadow-2xl mb-3 sm:mb-4">
        <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-4">
            <div>
                <p class="text-[10px] font-black uppercase tracking-[0.2em] text-neutral-400">Live Session</p>
                <h1 class="text-lg sm:text-2xl font-black text-white break-words">{{ room_name }}</h1>
                <p class="text-xs sm:text-sm text-neutral-300 mt-1">Role: {{ live_role|title }}</p>
            </div>
            <div class="flex items-center gap-2 sm:gap-3">
                <span id="conn-badge" class="px-3 py-1 rounded-full text-[10px] sm:text-xs font-bold uppercase tracking-wider bg-amber-100 text-amber-700">
                    Connecting
                </span>
                <form method="post" action="{% url 'Prolean:external_live_leave' session_id %}">
                    {% csrf_token %}
                    <button type="submit" class="px-3 sm:px-4 py-2 rounded-xl bg-red-600 text-white font-bold text-xs sm:text-sm hover:bg-red-700 transition-colors">
                        Leave
                    </button>
                </form>
            </div>
        </div>
    </div>

    <div id="conn-error" class="hidden mb-3 px-4 py-3 rounded-xl border border-red-900 bg-red-950/70 text-red-200 text-sm font-semibold"></div>

    <div class="mb-3 rounded-2xl border border-emerald-700/40 bg-emerald-900/20 p-3 sm:p-4">
        <div class="flex items-center justify-between gap-3 mb-2">
            <p class="text-[10px] font-black uppercase tracking-[0.2em] text-emerald-300">Live Activity</p>
            <span id="speaking-count" class="px-2 py-1 rounded-full bg-emerald-100 text-emerald-700 text-[10px] font-black">0 Speaking</span>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <div class="rounded-xl bg-neutral-900/70 border border-emerald-700/30 p-3">
                <p class="text-[10px] font-black uppercase tracking-[0.15em] text-emerald-200 mb-2">Now Speaking</p>
                <div id="speaking-list" class="flex flex-wrap gap-2"></div>
            </div>
            <div class="rounded-xl bg-neutral-900/70 border border-emerald-700/30 p-3">
                <p class="text-[10px] font-black uppercase tracking-[0.15em] text-emerald-200 mb-2">Raised Hands</p>
                <div id="raised-hands-list" class="flex flex-wrap gap-2"></div>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 xl:grid-cols-4 gap-3 sm:gap-4">
        <div class="xl:col-span-3 rounded-3xl border border-neutral-800 bg-neutral-950 p-3 sm:p-4 min-h-[70vh] sm:min-h-[80vh]">
            <div id="main-stage" class="relative w-full h-[58vh] sm:h-[66vh] rounded-2xl overflow-hidden bg-black border border-neutral-800"></div>
            <div id="thumb-strip" class="mt-3 grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-3"></div>
            <div id="audio-sink" class="hidden"></div>
        </div>

        <div class="rounded-3xl border border-neutral-800 bg-neutral-900/80 p-4 sm:p-5">
            <p class="text-[10px] font-black uppercase tracking-[0.2em] text-neutral-300 mb-4">Controls</p>
            <div class="grid grid-cols-4 gap-2 sm:gap-3">
                <button id="toggle-audio" title="Microphone" class="aspect-square rounded-xl border border-neutral-700 text-white font-bold text-sm hover:bg-neutral-800 flex items-center justify-center">
                    <span class="material-symbols-outlined">mic</span>
                </button>
                <button id="toggle-video" title="Camera" class="aspect-square rounded-xl border border-neutral-700 text-white font-bold text-sm hover:bg-neutral-800 flex items-center justify-center">
                    <span class="material-symbols-outlined">videocam</span>
                </button>
                <button id="toggle-screen" title="Share Screen (Professor)" class="aspect-square rounded-xl border border-neutral-700 text-white font-bold text-sm hover:bg-neutral-800 flex items-center justify-center">
                    <span class="material-symbols-outlined">present_to_all</span>
                </button>
                <button id="raise-hand" title="Raise Hand" class="aspect-square rounded-xl border border-neutral-700 text-white font-bold text-sm hover:bg-neutral-800 flex items-center justify-center">
                    <span class="material-symbols-outlined">front_hand</span>
                </button>
                <button id="enable-sound" title="Enable Sound" class="aspect-square rounded-xl border border-neutral-700 text-white font-bold text-sm hover:bg-neutral-800 flex items-center justify-center">
                    <span class="material-symbols-outlined">volume_up</span>
                </button>
                <button id="toggle-fullscreen" title="Fullscreen Stage" class="aspect-square rounded-xl border border-neutral-700 text-white font-bold text-sm hover:bg-neutral-800 flex items-center justify-center">
                    <span class="material-symbols-outlined">fullscreen</span>
                </button>
                <button id="cycle-layout" title="Switch View" class="aspect-square rounded-xl border border-neutral-700 text-white font-bold text-sm hover:bg-neutral-800 flex items-center justify-center">
                    <span class="material-symbols-outlined">dashboard</span>
                </button>
            </div>
            <p class="text-xs text-neutral-300 mt-5">Tap icons: mic, camera, hand raise, fullscreen. Students can use camera and microphone.</p>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/livekit-client/dist/livekit-client.umd.min.js"></script>
<script>
(() => {
  const rawLivekitUrl = "{{ livekit_url|escapejs }}";
  const livekitToken = "{{ livekit_token|escapejs }}";
  const isProfessor = "{{ live_role|escapejs }}" === "professor";
  const selfName = "{{ user.get_full_name|default:user.username|escapejs }}";

  const mainStage = document.getElementById("main-stage");
  const thumbStrip = document.getElementById("thumb-strip");
  const audioSink = document.getElementById("audio-sink");
  const badge = document.getElementById("conn-badge");
  const btnAudio = document.getElementById("toggle-audio");
  const btnVideo = document.getElementById("toggle-video");
  const btnScreen = document.getElementById("toggle-screen");
  const btnRaiseHand = document.getElementById("raise-hand");
  const btnEnableSound = document.getElementById("enable-sound");
  const btnFullscreen = document.getElementById("toggle-fullscreen");
  const btnLayout = document.getElementById("cycle-layout");
  const errBox = document.getElementById("conn-error");
  const speakingList = document.getElementById("speaking-list");
  const raisedHandsList = document.getElementById("raised-hands-list");
  const speakingCount = document.getElementById("speaking-count");

  const videoTiles = new Map();  // key -> {wrapper, media, track, isLocal, label}
  const audioEls = new Map();    // key -> element
  const raisedHands = new Map(); // identity -> name
  const avatarTiles = new Map(); // key -> avatar wrapper
  let mainVideoKey = null;
  let layoutMode = 0;

  const normalizeLivekitUrl = (value) => {
    const cleaned = String(value || "").trim().replace(/^['"]|['"]$/g, "");
    if (!cleaned) return "";
    if (/^wss?:\/\//i.test(cleaned)) return cleaned;
    return `wss://${cleaned}`;
  };

  const livekitUrl = normalizeLivekitUrl(rawLivekitUrl);
  if (!livekitUrl || !livekitToken) {
    badge.textContent = "Config Error";
    badge.className = "px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider bg-red-100 text-red-700";
    if (errBox) {
      errBox.textContent = `Missing live config. URL="${rawLivekitUrl || '-'}"`;
      errBox.classList.remove("hidden");
    }
    return;
  }

  try {
    new URL(livekitUrl);
  } catch {
    badge.textContent = "Invalid URL";
    badge.className = "px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider bg-red-100 text-red-700";
    if (errBox) {
      errBox.textContent = `Invalid LiveKit URL: "${livekitUrl}"`;
      errBox.classList.remove("hidden");
    }
    return;
  }

  const room = new LivekitClient.Room({
    adaptiveStream: true,
    dynacast: true,
    stopLocalTrackOnUnpublish: true,
  });

  const showError = (message) => {
    if (!errBox) return;
    errBox.textContent = message;
    errBox.classList.remove("hidden");
  };

  const setStatus = (label, state) => {
    badge.textContent = label;
    const classByState = {
      ok: "px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider bg-green-100 text-green-700",
      warn: "px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider bg-amber-100 text-amber-700",
      err: "px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider bg-red-100 text-red-700",
    };
    badge.className = classByState[state] || classByState.warn;
  };

  const makeIdentityLabel = (identity) => {
    if (!identity) return "Participant";
    if (identity === room.localParticipant.identity) return "You";
    return identity;
  };

  const initialsFromLabel = (label) => {
    const normalized = String(label || "U").trim();
    if (!normalized) return "U";
    return normalized[0].toUpperCase();
  };

  const renderSpeaking = () => {
    const speakers = room.activeSpeakers || [];
    speakingList.innerHTML = "";
    if (!speakers.length) {
      speakingList.innerHTML = '<span class="px-2 py-1 rounded-full bg-neutral-100 text-neutral-500 text-xs font-bold">No one speaking</span>';
    } else {
      speakers.forEach((p) => {
        const chip = document.createElement("span");
        chip.className = "px-2 py-1 rounded-full bg-emerald-100 text-emerald-700 text-xs font-bold";
        chip.textContent = makeIdentityLabel(p.identity);
        speakingList.appendChild(chip);
      });
    }
    speakingCount.textContent = `${speakers.length} Speaking`;
  };

  const renderRaisedHands = () => {
    raisedHandsList.innerHTML = "";
    if (!raisedHands.size) {
      raisedHandsList.innerHTML = '<span class="px-2 py-1 rounded-full bg-neutral-100 text-neutral-500 text-xs font-bold">No raised hands</span>';
      return;
    }
    raisedHands.forEach((name, identity) => {
      const chip = document.createElement("span");
      chip.className = "px-2 py-1 rounded-full bg-orange-100 text-orange-700 text-xs font-bold";
      chip.textContent = `${name || identity}`;
      raisedHandsList.appendChild(chip);
    });
  };

  const createVideoWrapper = (label) => {
    const wrapper = document.createElement("div");
    wrapper.className = "relative rounded-xl overflow-hidden border border-neutral-800 bg-black";
    const footer = document.createElement("div");
    footer.className = "absolute left-2 bottom-2 px-2 py-1 rounded bg-black/70 text-white text-[11px] font-bold";
    footer.textContent = label;
    wrapper.appendChild(footer);
    return wrapper;
  };

  const createAvatarWrapper = (label) => {
    const wrapper = document.createElement("div");
    wrapper.className = "relative rounded-xl overflow-hidden border border-neutral-800 bg-gradient-to-br from-neutral-800 to-neutral-900 h-28 sm:h-32 flex items-center justify-center";
    const avatar = document.createElement("div");
    avatar.className = "size-14 rounded-full bg-orange-500 text-white font-black text-2xl flex items-center justify-center";
    avatar.textContent = initialsFromLabel(label);
    wrapper.appendChild(avatar);
    const footer = document.createElement("div");
    footer.className = "absolute left-2 bottom-2 px-2 py-1 rounded bg-black/70 text-white text-[11px] font-bold";
    footer.textContent = label;
    wrapper.appendChild(footer);
    return wrapper;
  };

  const setMainVideo = (key) => {
    if (!videoTiles.has(key)) return;
    if (mainVideoKey === key) return;
    mainStage.innerHTML = "";
    const tile = videoTiles.get(key);
    const cloned = document.createElement("div");
    cloned.className = "relative w-full h-full rounded-2xl overflow-hidden bg-black";
    const media = tile.track.attach();
    media.className = "w-full h-full object-cover bg-black";
    media.muted = tile.isLocal;
    media.autoplay = true;
    media.playsInline = true;
    media.setAttribute("playsinline", "true");
    cloned.appendChild(media);
    const footer = document.createElement("div");
    footer.className = "absolute left-3 bottom-3 px-3 py-1 rounded bg-black/70 text-white text-xs font-bold";
    footer.textContent = tile.label;
    cloned.appendChild(footer);
    mainStage.appendChild(cloned);
    mainVideoKey = key;
    syncThumbnailVisibility();
  };

  const setMainAvatar = (key, label) => {
    mainStage.innerHTML = "";
    const container = document.createElement("div");
    container.className = "w-full h-full flex items-center justify-center bg-gradient-to-br from-neutral-900 to-neutral-800";
    const avatar = document.createElement("div");
    avatar.className = "size-24 sm:size-32 rounded-full bg-orange-500 text-white font-black text-4xl sm:text-5xl flex items-center justify-center shadow-2xl";
    avatar.textContent = initialsFromLabel(label);
    container.appendChild(avatar);
    const footer = document.createElement("div");
    footer.className = "absolute left-3 bottom-3 px-3 py-1 rounded bg-black/70 text-white text-xs font-bold";
    footer.textContent = label;
    mainStage.appendChild(container);
    mainStage.appendChild(footer);
    mainVideoKey = key;
    syncThumbnailVisibility();
  };

  const syncThumbnailVisibility = () => {
    for (const [key, tile] of videoTiles.entries()) {
      tile.wrapper.style.display = key === mainVideoKey ? "none" : "";
    }
    for (const [key, wrapper] of avatarTiles.entries()) {
      wrapper.style.display = key === mainVideoKey ? "none" : "";
    }
  };

  const attachVideoTrack = (track, identity, source = "camera") => {
    const key = `video:${source}:${track.sid || identity}`;
    if (videoTiles.has(key)) return;

    const isLocal = identity === room.localParticipant.identity;
    const baseLabel = makeIdentityLabel(identity);
    const label = source === "screen_share" ? `${baseLabel} Â· Content` : baseLabel;
    const wrapper = createVideoWrapper(label);
    const media = track.attach();
    media.className = "w-full h-28 sm:h-32 object-cover bg-black";
    media.autoplay = true;
    media.playsInline = true;
    media.muted = isLocal;

    wrapper.insertBefore(media, wrapper.firstChild);
    wrapper.addEventListener("click", () => setMainVideo(key));
    thumbStrip.appendChild(wrapper);

    videoTiles.set(key, { wrapper, media, label, isLocal, identity, track });
    if (avatarTiles.has(`avatar:${identity}`)) {
      avatarTiles.get(`avatar:${identity}`).remove();
      avatarTiles.delete(`avatar:${identity}`);
    }

    if (!mainVideoKey) {
      setMainVideo(key);
    } else if (isProfessor && isLocal) {
      setMainVideo(key);
    } else if (!isProfessor && !isLocal && String(identity).startsWith("prof_")) {
      setMainVideo(key);
    }
    syncThumbnailVisibility();
  };

  const attachAvatar = (identity, label) => {
    const key = `avatar:${identity}`;
    if (avatarTiles.has(key)) return;
    const wrapper = createAvatarWrapper(label);
    wrapper.dataset.avatarKey = key;
    wrapper.addEventListener("click", () => setMainAvatar(key, label));
    thumbStrip.appendChild(wrapper);
    avatarTiles.set(key, wrapper);
    if (!mainVideoKey) setMainAvatar(key, label);
    syncThumbnailVisibility();
  };

  const removeAvatar = (identity) => {
    const key = `avatar:${identity}`;
    if (!avatarTiles.has(key)) return;
    avatarTiles.get(key).remove();
    avatarTiles.delete(key);
    if (mainVideoKey === key) {
      mainVideoKey = null;
      const nextVideo = videoTiles.keys().next();
      if (!nextVideo.done) setMainVideo(nextVideo.value);
      else mainStage.innerHTML = "";
    }
    syncThumbnailVisibility();
  };

  const attachAudioTrack = (track, identity) => {
    const key = `audio:${track.sid || identity}`;
    if (audioEls.has(key)) return;

    const audioEl = track.attach();
    audioEl.autoplay = true;
    audioEl.playsInline = true;
    audioEl.muted = false;
    audioEl.dataset.key = key;
    audioSink.appendChild(audioEl);
    audioEls.set(key, audioEl);
    const playPromise = audioEl.play();
    if (playPromise && typeof playPromise.catch === "function") {
      playPromise.catch(() => setStatus("Tap Enable Sound", "warn"));
    }
  };

  const detachTrack = (track) => {
    for (const [k, tile] of videoTiles.entries()) {
      if (tile.track?.sid && track.sid && tile.track.sid === track.sid) {
        tile.wrapper.remove();
        videoTiles.delete(k);
      if (mainVideoKey === k) {
        mainVideoKey = null;
        const next = videoTiles.keys().next();
        if (!next.done) setMainVideo(next.value);
        else mainStage.innerHTML = "";
      }
      syncThumbnailVisibility();
    }
    }

    for (const [k, audio] of audioEls.entries()) {
      if (k.includes(track.sid || "")) {
        audio.remove();
        audioEls.delete(k);
      }
    }

    track.detach().forEach((el) => el.remove());
  };

  const renderExistingParticipantTracks = (participant) => {
    participant.trackPublications.forEach((pub) => {
      if (!pub.track) return;
      if (pub.track.kind === "video") attachVideoTrack(pub.track, participant.identity, pub.source || "camera");
      if (pub.track.kind === "audio") attachAudioTrack(pub.track, participant.identity);
    });
  };

  const attachLocalTracksNow = () => {
    if (!room.localParticipant) return;
    room.localParticipant.trackPublications.forEach((pub) => {
      if (!pub.track) return;
      if (pub.track.kind === "video") attachVideoTrack(pub.track, room.localParticipant.identity, pub.source || "camera");
      if (pub.track.kind === "audio") attachAudioTrack(pub.track, room.localParticipant.identity);
    });
    refreshLocalAvatarState();
  };

  const applyLayoutMode = () => {
    if (layoutMode === 0) {
      thumbStrip.className = "mt-3 grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-3";
    } else if (layoutMode === 1) {
      thumbStrip.className = "mt-3 flex gap-3 overflow-x-auto pb-1";
    } else {
      thumbStrip.className = "mt-3 grid grid-cols-3 sm:grid-cols-4 lg:grid-cols-6 gap-2";
    }
  };

  const refreshLocalAvatarState = () => {
    if (!room.localParticipant) return;
    const localIdentity = room.localParticipant.identity;
    const hasVideo = Array.from(videoTiles.values()).some((tile) => tile.identity === localIdentity);
    if (!hasVideo) attachAvatar(localIdentity, "You");
    else removeAvatar(localIdentity);
  };

  room
    .on(LivekitClient.RoomEvent.TrackSubscribed, (track, publication, participant) => {
      if (track.kind === "video") attachVideoTrack(track, participant.identity, publication?.source || "camera");
      if (track.kind === "audio") attachAudioTrack(track, participant.identity);
      if (participant.identity === room.localParticipant.identity) refreshLocalAvatarState();
    })
    .on(LivekitClient.RoomEvent.TrackUnsubscribed, (track, publication, participant) => {
      detachTrack(track);
      if (participant && participant.identity === room.localParticipant.identity) refreshLocalAvatarState();
    })
    .on(LivekitClient.RoomEvent.LocalTrackPublished, (publication) => {
      const track = publication?.track;
      if (track?.kind === "video") attachVideoTrack(track, room.localParticipant.identity, publication?.source || "camera");
      if (track?.kind === "audio") attachAudioTrack(track, room.localParticipant.identity);
      refreshLocalAvatarState();
    })
    .on(LivekitClient.RoomEvent.LocalTrackUnpublished, () => refreshLocalAvatarState())
    .on(LivekitClient.RoomEvent.ActiveSpeakersChanged, () => renderSpeaking())
    .on(LivekitClient.RoomEvent.Disconnected, () => setStatus("Disconnected", "err"))
    .on(LivekitClient.RoomEvent.DataReceived, (payload, participant) => {
      try {
        const message = JSON.parse(new TextDecoder().decode(payload));
        if (!message || !message.type) return;
        if (message.type === "raise_hand") {
          raisedHands.set(participant?.identity || message.name || "student", message.name || participant?.identity || "student");
          renderRaisedHands();
        }
        if (message.type === "hand_lowered") {
          raisedHands.delete(participant?.identity || "");
          renderRaisedHands();
        }
      } catch (_) {}
    });

  setStatus("Connecting", "warn");
  renderSpeaking();
  renderRaisedHands();
  applyLayoutMode();

  room.connect(livekitUrl, livekitToken)
    .then(async () => {
      setStatus("Connected", "ok");
      room.remoteParticipants.forEach((p) => renderExistingParticipantTracks(p));

      if (isProfessor) {
        try { await room.localParticipant.setMicrophoneEnabled(true); } catch (e) { showError(`Microphone error: ${e.message || e}`); }
        try { await room.localParticipant.setCameraEnabled(true); } catch (e) { showError(`Camera error: ${e.message || e}`); }
        renderExistingParticipantTracks(room.localParticipant);
      } else {
        try { await room.localParticipant.setCameraEnabled(false); } catch (_) {}
        try { await room.localParticipant.setMicrophoneEnabled(true); } catch (e) { showError(`Student microphone permission: ${e.message || e}`); }
      }
      refreshLocalAvatarState();
      if (!isProfessor) {
        btnScreen.disabled = true;
        btnScreen.classList.add("opacity-50", "cursor-not-allowed");
      }
    })
    .catch((err) => {
      setStatus("Connection Failed", "err");
      showError(`LiveKit connection failed: ${err?.message || err}`);
    });

  btnAudio.addEventListener("click", async () => {
    try {
      const enabled = room.localParticipant.isMicrophoneEnabled;
      await room.localParticipant.setMicrophoneEnabled(!enabled);
      btnAudio.innerHTML = `<span class="material-symbols-outlined">${enabled ? 'mic_off' : 'mic'}</span>`;
    } catch (err) {
      showError(`Mic toggle failed: ${err?.message || err}`);
    }
  });

  btnVideo.addEventListener("click", async () => {
    try {
      const enabled = room.localParticipant.isCameraEnabled;
      await room.localParticipant.setCameraEnabled(!enabled);
      btnVideo.innerHTML = `<span class="material-symbols-outlined">${enabled ? 'videocam_off' : 'videocam'}</span>`;
      if (!enabled) {
        // Local publication may complete asynchronously; attach on next tick.
        setTimeout(() => attachLocalTracksNow(), 200);
      }
      refreshLocalAvatarState();
    } catch (err) {
      showError(`Camera toggle failed: ${err?.message || err}`);
    }
  });

  btnScreen.addEventListener("click", async () => {
    if (!isProfessor) return;
    try {
      const enabled = !!room.localParticipant.isScreenShareEnabled;
      await room.localParticipant.setScreenShareEnabled(!enabled);
      btnScreen.innerHTML = `<span class="material-symbols-outlined">${enabled ? 'present_to_all' : 'stop_screen_share'}</span>`;
    } catch (err) {
      showError(`Screen share failed: ${err?.message || err}`);
    }
  });

  btnRaiseHand.addEventListener("click", async () => {
    try {
      const payload = JSON.stringify({ type: "raise_hand", name: selfName, ts: Date.now() });
      await room.localParticipant.publishData(new TextEncoder().encode(payload), { reliable: true });
      btnRaiseHand.innerHTML = '<span class="material-symbols-outlined">waving_hand</span>';
      setTimeout(() => { btnRaiseHand.innerHTML = '<span class="material-symbols-outlined">front_hand</span>'; }, 2000);
    } catch (err) {
      showError(`Raise hand failed: ${err?.message || err}`);
    }
  });

  btnEnableSound.addEventListener("click", async () => {
    const audios = audioSink.querySelectorAll("audio");
    for (const audio of audios) {
      try {
        audio.muted = false;
        audio.volume = 1;
        await audio.play();
      } catch (_) {}
    }
    setStatus("Connected", "ok");
  });

  btnFullscreen.addEventListener("click", async () => {
    if (!document.fullscreenElement) {
      await mainStage.requestFullscreen().catch(() => {});
      btnFullscreen.innerHTML = '<span class="material-symbols-outlined">fullscreen_exit</span>';
    } else {
      await document.exitFullscreen().catch(() => {});
      btnFullscreen.innerHTML = '<span class="material-symbols-outlined">fullscreen</span>';
    }
  });

  btnLayout.addEventListener("click", () => {
    layoutMode = (layoutMode + 1) % 3;
    applyLayoutMode();
  });
})();
</script>
{% endblock %}
