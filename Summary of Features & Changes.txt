Summary of Features & Changes
=================================

Purpose
- Persistent project log of implemented features, fixes, and key decisions.
- This file must be updated whenever a new feature is added or an error fix is applied.

Update Rule
- For every new change, append a new entry with:
  - Date (UTC)
  - Area (Barka / Prolean / Infra)
  - Type (Feature / Fix / Config / Refactor)
  - What changed
  - Why it changed
  - Validation done

Project Baseline (Current Working Direction)
- Barka is source of truth for identity, roles/permissions, sessions, formations, cities, and assignments.
- Prolean consumes Barka via API contract and adapts payloads to UI.
- Login supports CIN and username depending on user type.
- Registration creates student in Barka and redirects to student dashboard.
- Student dashboard renders external assignments and pending-assignment states.
- Professor dashboard renders assigned external sessions/students.
- Live streaming integrated through LiveKit with Barka-controlled access.

Recent Entries
--------------

[2026-02-16 UTC] Area: Barka | Type: Feature
- Added session live lifecycle contract endpoints:
  - get live state
  - start live
  - pause live
  - end live (with optional recording URL)
  - join live
  - leave live
- Added live/session participant persistence with idempotent initialization.
- Why:
  - Enforce session-scoped live authorization under Barka authority.
- Validation:
  - Route syntax check passed.

[2026-02-16 UTC] Area: Prolean | Type: Feature
- Added external live integration client methods and routes/views.
- Added external live room page for LiveKit join experience.
- Added professor controls (start/pause/end/join) in external dashboard.
- Added student live status/CTA binding based on Barka live state.
- Why:
  - Enable end-to-end live flow with Barka as authority.
- Validation:
  - Django system check passed.

[2026-02-16 UTC] Area: Prolean | Type: Fix/UI
- Fixed silent live action behavior:
  - Start-live now redirects professor directly to live room after success.
  - Added visible flash alerts (success/error/warning/info) in professor and student base layouts.
- Improved student UX:
  - Added clear "Live Available" panel with direct Join buttons for active session lives.
- Why:
  - Users reported clicking start/join with no visible outcome and unclear student join entry points.
- Validation:
  - Django system check passed.

[2026-02-16 UTC] Area: Barka | Type: Fix/Config Guard
- Added early validation of LiveKit env config in session live endpoints:
  - start live now checks LIVEKIT_URL, LIVEKIT_API_KEY, LIVEKIT_API_SECRET before creating a live.
  - join live now checks the same vars before generating token.
- Why:
  - Prevented confusing runtime failure where live starts but join fails with missing credentials.
- Validation:
  - Route syntax check passed.

[2026-02-16 UTC] Area: Barka | Type: Fix/Error Handling
- Changed missing LiveKit config response from 503 to 500 on live start/join.
- Why:
  - Prolean retries 503 as transient upstream downtime; this masked the real configuration error.
- Validation:
  - Route syntax check passed and commit pushed to Barka remotes.

[2026-02-16 UTC] Area: Barka | Type: Fix/Config Robustness
- Normalized LiveKit env values (trim + quote stripping) before token generation and URL response.
- Why:
  - Prevent failures caused by copied env values containing whitespace/quotes.
- Validation:
  - Route syntax check passed and pushed.

[2026-02-16 UTC] Area: Prolean | Type: Fix/UI Diagnostics
- Enhanced external live room to display detailed LiveKit connection error text on page.
- Why:
  - Replace ambiguous "Connection Failed" with actionable reason for debugging.
- Validation:
  - Django system check passed and pushed.

[2026-02-16 UTC] Area: Barka | Type: Fix/URL Normalization
- Added normalization for LiveKit websocket URL in join payload:
  - trims spaces/quotes
  - enforces ws scheme by prefixing with `wss://` if missing
- Why:
  - Prevent invalid URL errors in browser connect flow.
- Validation:
  - Route syntax check passed and pushed.

[2026-02-16 UTC] Area: Prolean | Type: Fix/Client Validation
- Added client-side LiveKit URL normalization and explicit URL validation in live room page.
- Added raw/normalized URL error output for fast diagnosis.
- Why:
  - Expose exact malformed URL problems instead of generic connection failure.
- Validation:
  - Django system check passed and pushed.

[2026-02-16 UTC] Area: Barka | Type: Feature/Live Permissions
- Updated LiveKit token grants:
  - professor can publish camera + microphone (+ data)
  - student can publish microphone only (+ data), no camera source permission
- Why:
  - Requirement: students can talk/raise hand but must not share camera.
- Validation:
  - Route syntax check passed and pushed.

[2026-02-16 UTC] Area: Prolean | Type: Fix/Live UX+Media
- Live room now:
  - shows professor self-preview ("You") by rendering local video track
  - separates audio tracks from video grid (prevents duplicate/black tiles)
  - avoids duplicate track attachments
  - keeps student camera disabled in UI
  - adds "Raise Hand" data signal and "Enable Sound" control
- Why:
  - Fix dark frame/self-preview missing, duplicate stream appearance, and muted audio UX issues.
- Validation:
  - Django system check passed and pushed.

[2026-02-16 UTC] Area: Prolean | Type: Refactor/Live Stage + Responsive UI
- Rebuilt external live room page for a stage-based layout:
  - main stream fills stage area properly
  - participant thumbnails in strip
  - explicit live activity banner (speaking + raised hands)
  - improved mobile responsiveness and control ergonomics
- Fixed false global "Connection Failed" by handling post-connect mic/camera errors separately from socket connection status.
- Added stronger audio recovery flow (`Enable Sound`) and speaking state rendering.
- Updated student/professor base layouts with improved responsive spacing and visual hierarchy.
- Why:
  - Resolve stream sizing/usability issues on mobile and improve overall UX consistency.
- Validation:
  - Django system check passed.

[2026-02-16 UTC] Area: Prolean | Type: Fix/Live Rendering + UX
- Fixed main-stage black preview issue by using real attached track elements in stage view (no clone-without-stream).
- Updated professor external live control panel with improved responsive design and clearer CTA:
  - `Start & Join Live`
  - `Pause Live`
  - `End Live`
  - persistent `Back to Live Room` when live is active
- Why:
  - Ensure professor camera fills full stage and improve live action clarity.
- Validation:
  - Django system check passed.

[2026-02-16 UTC] Area: Barka | Type: Feature/Live Permissions Update
- Updated student LiveKit publish sources to allow camera + microphone (instead of mic-only).
- Kept professor screen-share capability.
- Why:
  - New requirement allows students to open camera while staying in the same live room model.
- Validation:
  - Route syntax check passed.

[2026-02-16 UTC] Area: Prolean | Type: Refactor/Live UX
- Reworked live room controls to icon-first interaction (mic/camera/screen share/raise hand/sound/fullscreen/layout).
- Added professor screen-share toggle.
- Added local avatar fallback tile (first letter) when camera is off.
- Improved tile-to-stage switching behavior and fullscreen support for easier low-tech use.
- Wired floating buttons to switch from WhatsApp to "Join Live" when live stream updates are detected, including external live data dispatch from student dashboard.
- Updated professor dashboard live actions with icon-assisted buttons and clearer semantics.
- Why:
  - Improve usability for non-technical users and match requested UX behavior.
- Validation:
  - Django system check passed.
